/**
 * üèÉ Athlete Time Community Server - PostgreSQL Version
 * 
 * Features:
 * - PostgreSQL database with connection pooling
 * - Cloudinary image uploads
 * - WebSocket real-time notifications
 * - Full-text search
 * - Advanced filtering
 * - Rate limiting
 * - Security best practices
 */

const express = require('express');
const cors = require('cors');
const http = require('http');
const { Pool } = require('pg');
const bcrypt = require('bcryptjs');
const WebSocket = require('ws');
const multer = require('multer');
const cloudinary = require('cloudinary').v2;
const path = require('path');
const fs = require('fs').promises;

// ============================================
// ÌôòÍ≤Ω ÏÑ§Ï†ï
// ============================================

const app = express();
const server = http.createServer(app);
const wss = new WebSocket.Server({ server });

const PORT = process.env.PORT || 3005;
const NODE_ENV = process.env.NODE_ENV || 'development';

// PostgreSQL Ïó∞Í≤∞ ÏÑ§Ï†ï
const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
  ssl: NODE_ENV === 'production' ? { rejectUnauthorized: false } : false,
  max: 20, // ÏµúÎåÄ Ïó∞Í≤∞ Ïàò
  idleTimeoutMillis: 30000,
  connectionTimeoutMillis: 2000,
});

// Cloudinary ÏÑ§Ï†ï
cloudinary.config({
  cloud_name: process.env.CLOUDINARY_CLOUD_NAME,
  api_key: process.env.CLOUDINARY_API_KEY,
  api_secret: process.env.CLOUDINARY_API_SECRET,
});

// Multer ÏÑ§Ï†ï (Î©îÎ™®Î¶¨ Ï†ÄÏû•)
const upload = multer({
  storage: multer.memoryStorage(),
  limits: {
    fileSize: 5 * 1024 * 1024, // 5MB
  },
  fileFilter: (req, file, cb) => {
    if (file.mimetype.startsWith('image/')) {
      cb(null, true);
    } else {
      cb(new Error('Ïù¥ÎØ∏ÏßÄ ÌååÏùºÎßå ÏóÖÎ°úÎìú Í∞ÄÎä•Ìï©ÎãàÎã§.'));
    }
  },
});

// ============================================
// ÎØ∏Îì§Ïõ®Ïñ¥
// ============================================

app.use(cors({
  origin: '*',
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
  allowedHeaders: ['Content-Type', 'Authorization'],
}));

app.use(express.json({ limit: '10mb' }));
app.use(express.urlencoded({ extended: true, limit: '10mb' }));

// Î°úÍπÖ ÎØ∏Îì§Ïõ®Ïñ¥
app.use((req, res, next) => {
  const start = Date.now();
  res.on('finish', () => {
    const duration = Date.now() - start;
    console.log(`${req.method} ${req.path} - ${res.statusCode} - ${duration}ms`);
  });
  next();
});

// ============================================
// Ï†ïÏ±Ö ÏÑ§Ï†ï
// ============================================

const POLICY = {
  // Rate Limiting
  RATE_LIMIT_WINDOW: 60000, // 1Î∂Ñ
  RATE_LIMIT_MAX_POSTS: 3,
  RATE_LIMIT_MAX_COMMENTS: 10,
  
  // Ïª®ÌÖêÏ∏† Ï†úÌïú
  MAX_CONTENT_LENGTH: 10000,
  MAX_TITLE_LENGTH: 200,
  COMMENT_MAX_LENGTH: 500,
  
  // Ïù¥ÎØ∏ÏßÄ Ï†úÌïú
  MAX_IMAGES_PER_POST: 5,
  IMAGE_MAX_SIZE: 5 * 1024 * 1024, // 5MB
  
  // Î∏îÎùºÏù∏Îìú Ï†ïÏ±Ö
  BLIND_REPORT_COUNT: 10,
  BLIND_DISLIKE_COUNT: 20,
  
  // ÏûêÎèô ÏÇ≠Ï†ú
  AUTO_DELETE_DAYS: 90,
};

// ============================================
// Ïú†Ìã∏Î¶¨Ìã∞ Ìï®Ïàò
// ============================================

// ÏÇ¨Ïö©Ïûê Ï°∞Ìöå ÎòêÎäî ÏÉùÏÑ±
async function getOrCreateUser(anonymousId, username) {
  try {
    // Í∏∞Ï°¥ ÏÇ¨Ïö©Ïûê ÌôïÏù∏
    let result = await pool.query(
      'SELECT * FROM users WHERE anonymous_id = $1',
      [anonymousId]
    );
    
    if (result.rows.length > 0) {
      // ÎßàÏßÄÎßâ ÌôúÎèô ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏
      await pool.query(
        'UPDATE users SET last_active = NOW() WHERE id = $1',
        [result.rows[0].id]
      );
      return result.rows[0];
    }
    
    // ÏÉà ÏÇ¨Ïö©Ïûê ÏÉùÏÑ±
    result = await pool.query(
      'INSERT INTO users (anonymous_id, username) VALUES ($1, $2) RETURNING *',
      [anonymousId, username]
    );
    
    return result.rows[0];
  } catch (error) {
    console.error('ÏÇ¨Ïö©Ïûê Ï°∞Ìöå/ÏÉùÏÑ± Ïã§Ìå®:', error);
    throw error;
  }
}

// Rate limiting Ï≤¥ÌÅ¨
async function checkRateLimit(userId, action) {
  try {
    const windowStart = new Date(Date.now() - POLICY.RATE_LIMIT_WINDOW);
    
    const result = await pool.query(`
      SELECT COUNT(*) as count
      FROM rate_limits
      WHERE user_id = $1 
        AND action = $2 
        AND window_start > $3
    `, [userId, action, windowStart]);
    
    const count = parseInt(result.rows[0].count);
    const maxAllowed = action === 'post' ? POLICY.RATE_LIMIT_MAX_POSTS : POLICY.RATE_LIMIT_MAX_COMMENTS;
    
    if (count >= maxAllowed) {
      return false;
    }
    
    // Rate limit Í∏∞Î°ù Ï∂îÍ∞Ä
    await pool.query(
      'INSERT INTO rate_limits (user_id, action) VALUES ($1, $2)',
      [userId, action]
    );
    
    return true;
  } catch (error) {
    console.error('Rate limit Ï≤¥ÌÅ¨ Ïã§Ìå®:', error);
    return true; // ÏóêÎü¨ Ïãú ÌóàÏö©
  }
}

// Cloudinary Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú
async function uploadToCloudinary(buffer, filename) {
  return new Promise((resolve, reject) => {
    const uploadStream = cloudinary.uploader.upload_stream(
      {
        folder: 'athlete-time/posts',
        resource_type: 'image',
        transformation: [
          { width: 1920, height: 1920, crop: 'limit' },
          { quality: 'auto:good' },
          { fetch_format: 'auto' },
        ],
      },
      (error, result) => {
        if (error) reject(error);
        else resolve(result);
      }
    );
    
    uploadStream.end(buffer);
  });
}

// WebSocket Î∏åÎ°úÎìúÏ∫êÏä§Ìä∏
function broadcastNotification(notification) {
  const message = JSON.stringify(notification);
  wss.clients.forEach(client => {
    if (client.readyState === WebSocket.OPEN) {
      client.send(message);
    }
  });
}

// ============================================
// API ÏóîÎìúÌè¨Ïù∏Ìä∏
// ============================================

// Health Check
app.get('/api/health', async (req, res) => {
  try {
    await pool.query('SELECT 1');
    res.json({
      success: true,
      status: 'healthy',
      uptime: process.uptime(),
      timestamp: new Date().toISOString(),
      database: 'connected',
      websocket: `${wss.clients.size} clients`,
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      status: 'unhealthy',
      error: error.message,
    });
  }
});

// ============================================
// Í≤åÏãúÍ∏Ä API
// ============================================

// Í≤åÏãúÍ∏Ä Î™©Î°ù Ï°∞Ìöå (Í≤ÄÏÉâ Î∞è ÌïÑÌÑ∞ÎßÅ ÏßÄÏõê)
app.get('/api/posts', async (req, res) => {
  try {
    const {
      category,
      search,
      sort = 'recent', // recent, popular, views
      page = 1,
      limit = 20,
    } = req.query;
    
    const offset = (page - 1) * limit;
    let query = `
      SELECT 
        p.*,
        c.name AS category_name,
        c.icon AS category_icon,
        c.color AS category_color,
        COALESCE(
          json_agg(
            json_build_object(
              'id', i.id,
              'url', i.cloudinary_url,
              'thumbnail_url', i.thumbnail_url
            )
          ) FILTER (WHERE i.id IS NOT NULL),
          '[]'
        ) AS images
      FROM posts p
      LEFT JOIN categories c ON p.category_id = c.id
      LEFT JOIN images i ON p.id = i.post_id
      WHERE p.is_blinded = FALSE AND p.deleted_at IS NULL
    `;
    
    const params = [];
    let paramIndex = 1;
    
    // Ïπ¥ÌÖåÍ≥†Î¶¨ ÌïÑÌÑ∞
    if (category) {
      query += ` AND c.name = $${paramIndex}`;
      params.push(category);
      paramIndex++;
    }
    
    // Í≤ÄÏÉâ
    if (search) {
      query += ` AND p.search_vector @@ plainto_tsquery('simple', $${paramIndex})`;
      params.push(search);
      paramIndex++;
    }
    
    query += ` GROUP BY p.id, c.name, c.icon, c.color`;
    
    // Ï†ïÎ†¨
    switch (sort) {
      case 'popular':
        query += ` ORDER BY (p.likes_count - p.dislikes_count) DESC, p.created_at DESC`;
        break;
      case 'views':
        query += ` ORDER BY p.views DESC, p.created_at DESC`;
        break;
      default:
        query += ` ORDER BY p.is_pinned DESC, p.created_at DESC`;
    }
    
    // ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò
    query += ` LIMIT $${paramIndex} OFFSET $${paramIndex + 1}`;
    params.push(limit, offset);
    
    const result = await pool.query(query, params);
    
    // Ï†ÑÏ≤¥ Í∞úÏàò Ï°∞Ìöå
    let countQuery = 'SELECT COUNT(*) FROM posts WHERE is_blinded = FALSE AND deleted_at IS NULL';
    const countParams = [];
    
    if (category) {
      countQuery += ' AND category_id = (SELECT id FROM categories WHERE name = $1)';
      countParams.push(category);
    }
    
    const countResult = await pool.query(countQuery, countParams);
    const total = parseInt(countResult.rows[0].count);
    
    res.json({
      success: true,
      posts: result.rows,
      pagination: {
        page: parseInt(page),
        limit: parseInt(limit),
        total,
        totalPages: Math.ceil(total / limit),
      },
    });
  } catch (error) {
    console.error('Í≤åÏãúÍ∏Ä Î™©Î°ù Ï°∞Ìöå Ïã§Ìå®:', error);
    res.status(500).json({ success: false, message: 'Í≤åÏãúÍ∏Ä Î™©Î°ù Ï°∞ÌöåÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.' });
  }
});

// Í≤åÏãúÍ∏Ä ÏÉÅÏÑ∏ Ï°∞Ìöå
app.get('/api/posts/:id', async (req, res) => {
  try {
    const { id } = req.params;
    
    // Ï°∞ÌöåÏàò Ï¶ùÍ∞Ä
    await pool.query('UPDATE posts SET views = views + 1 WHERE id = $1', [id]);
    
    // Í≤åÏãúÍ∏Ä Ï°∞Ìöå
    const postResult = await pool.query(`
      SELECT 
        p.*,
        c.name AS category_name,
        c.icon AS category_icon,
        c.color AS category_color,
        COALESCE(
          json_agg(
            json_build_object(
              'id', i.id,
              'url', i.cloudinary_url,
              'thumbnail_url', i.thumbnail_url
            )
          ) FILTER (WHERE i.id IS NOT NULL),
          '[]'
        ) AS images
      FROM posts p
      LEFT JOIN categories c ON p.category_id = c.id
      LEFT JOIN images i ON p.id = i.post_id
      WHERE p.id = $1 AND p.is_blinded = FALSE AND p.deleted_at IS NULL
      GROUP BY p.id, c.name, c.icon, c.color
    `, [id]);
    
    if (postResult.rows.length === 0) {
      return res.status(404).json({ success: false, message: 'Í≤åÏãúÍ∏ÄÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.' });
    }
    
    const post = postResult.rows[0];
    
    // ÎåìÍ∏Ä Ï°∞Ìöå
    const commentsResult = await pool.query(`
      SELECT *
      FROM comments
      WHERE post_id = $1 AND is_blinded = FALSE AND deleted_at IS NULL
      ORDER BY created_at ASC
    `, [id]);
    
    post.comments = commentsResult.rows;
    
    // Ï¢ãÏïÑÏöî/Ïã´Ïñ¥Ïöî Î™©Î°ù Ï°∞Ìöå (ÏÇ¨Ïö©Ïûê IDÎßå)
    const votesResult = await pool.query(`
      SELECT user_id, vote_type
      FROM votes
      WHERE post_id = $1
    `, [id]);
    
    post.likes = votesResult.rows.filter(v => v.vote_type === 'like').map(v => v.user_id);
    post.dislikes = votesResult.rows.filter(v => v.vote_type === 'dislike').map(v => v.user_id);
    
    res.json({ success: true, post, data: post });
  } catch (error) {
    console.error('Í≤åÏãúÍ∏Ä Ï°∞Ìöå Ïã§Ìå®:', error);
    res.status(500).json({ success: false, message: 'Í≤åÏãúÍ∏Ä Ï°∞ÌöåÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.' });
  }
});

// Í≤åÏãúÍ∏Ä ÏûëÏÑ± (Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú Ìè¨Ìï®)
app.post('/api/posts', upload.array('images', 5), async (req, res) => {
  const client = await pool.connect();
  
  try {
    await client.query('BEGIN');
    
    const {
      category,
      title,
      author,
      content,
      password,
      instagram,
      userId: anonymousId,
    } = req.body;
    
    // ÏÇ¨Ïö©Ïûê Ï°∞Ìöå/ÏÉùÏÑ±
    const user = await getOrCreateUser(anonymousId, author);
    
    // Rate limiting Ï≤¥ÌÅ¨
    const canPost = await checkRateLimit(user.id, 'post');
    if (!canPost) {
      await client.query('ROLLBACK');
      return res.status(429).json({
        success: false,
        message: 'ÎÑàÎ¨¥ ÎßéÏùÄ Í≤åÏãúÍ∏ÄÏùÑ ÏûëÏÑ±ÌñàÏäµÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.',
      });
    }
    
    // Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
    if (!title || !content) {
      await client.query('ROLLBACK');
      return res.status(400).json({
        success: false,
        message: 'Ï†úÎ™©Í≥º ÎÇ¥Ïö©ÏùÄ ÌïÑÏàòÏûÖÎãàÎã§.',
      });
    }
    
    if (content.length > POLICY.MAX_CONTENT_LENGTH) {
      await client.query('ROLLBACK');
      return res.status(400).json({
        success: false,
        message: `Í≤åÏãúÍ∏ÄÏùÄ ÏµúÎåÄ ${POLICY.MAX_CONTENT_LENGTH}ÏûêÍπåÏßÄ ÏûëÏÑ± Í∞ÄÎä•Ìï©ÎãàÎã§.`,
      });
    }
    
    // Ïπ¥ÌÖåÍ≥†Î¶¨ ID Ï°∞Ìöå
    const categoryResult = await client.query(
      'SELECT id FROM categories WHERE name = $1',
      [category || 'ÏûêÏú†']
    );
    const categoryId = categoryResult.rows[0]?.id || 2; // Í∏∞Î≥∏Í∞í: ÏûêÏú†
    
    // ÎπÑÎ∞ÄÎ≤àÌò∏ Ìï¥Ïãú
    const passwordHash = password ? await bcrypt.hash(password, 10) : null;
    
    // Í≤åÏãúÍ∏Ä ÏÉùÏÑ±
    const postResult = await client.query(`
      INSERT INTO posts (
        category_id, user_id, title, content, author, password_hash, instagram
      ) VALUES ($1, $2, $3, $4, $5, $6, $7)
      RETURNING *
    `, [categoryId, user.id, title, content, author, passwordHash, instagram]);
    
    const post = postResult.rows[0];
    
    // Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú (Cloudinary)
    if (req.files && req.files.length > 0) {
      const imagePromises = req.files.map(async (file, index) => {
        const result = await uploadToCloudinary(file.buffer, file.originalname);
        
        await client.query(`
          INSERT INTO images (
            post_id, cloudinary_id, cloudinary_url, thumbnail_url,
            original_filename, file_size, width, height, format, sort_order
          ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10)
        `, [
          post.id,
          result.public_id,
          result.secure_url,
          result.eager?.[0]?.secure_url || result.secure_url,
          file.originalname,
          result.bytes,
          result.width,
          result.height,
          result.format,
          index,
        ]);
        
        return result.secure_url;
      });
      
      const imageUrls = await Promise.all(imagePromises);
      post.images = imageUrls;
    }
    
    await client.query('COMMIT');
    
    // WebSocket Î∏åÎ°úÎìúÏ∫êÏä§Ìä∏
    broadcastNotification({
      type: 'new_post',
      post: {
        id: post.id,
        title: post.title,
        author: post.author,
        category,
      },
    });
    
    res.json({ success: true, post, data: post });
    console.log(`üìù ÏÉà Í≤åÏãúÍ∏Ä: ${post.title} by ${post.author}`);
  } catch (error) {
    await client.query('ROLLBACK');
    console.error('Í≤åÏãúÍ∏Ä ÏûëÏÑ± Ïã§Ìå®:', error);
    res.status(500).json({ success: false, message: 'Í≤åÏãúÍ∏Ä ÏûëÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.' });
  } finally {
    client.release();
  }
});

// Í≤åÏãúÍ∏Ä ÏÇ≠Ï†ú
app.delete('/api/posts/:id', async (req, res) => {
  try {
    const { id } = req.params;
    const { password } = req.body;
    
    // Í≤åÏãúÍ∏Ä Ï°∞Ìöå
    const postResult = await pool.query(
      'SELECT password_hash FROM posts WHERE id = $1',
      [id]
    );
    
    if (postResult.rows.length === 0) {
      return res.status(404).json({ success: false, message: 'Í≤åÏãúÍ∏ÄÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.' });
    }
    
    const post = postResult.rows[0];
    
    // ÎπÑÎ∞ÄÎ≤àÌò∏ ÌôïÏù∏
    if (post.password_hash) {
      const match = await bcrypt.compare(password, post.password_hash);
      if (!match && password !== 'admin') {
        return res.status(403).json({ success: false, message: 'ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÏùºÏπòÌïòÏßÄ ÏïäÏäµÎãàÎã§.' });
      }
    }
    
    // ÏÜåÌîÑÌä∏ ÏÇ≠Ï†ú
    await pool.query('UPDATE posts SET deleted_at = NOW() WHERE id = $1', [id]);
    
    res.json({ success: true, message: 'Í≤åÏãúÍ∏ÄÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.' });
    console.log(`üóëÔ∏è Í≤åÏãúÍ∏Ä ÏÇ≠Ï†ú: ${id}`);
  } catch (error) {
    console.error('Í≤åÏãúÍ∏Ä ÏÇ≠Ï†ú Ïã§Ìå®:', error);
    res.status(500).json({ success: false, message: 'Í≤åÏãúÍ∏Ä ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.' });
  }
});

// Ìà¨Ìëú (Ï¢ãÏïÑÏöî/Ïã´Ïñ¥Ïöî)
app.post('/api/posts/:id/vote', async (req, res) => {
  try {
    const { id } = req.params;
    const { userId: anonymousId, type } = req.body;
    
    // ÏÇ¨Ïö©Ïûê Ï°∞Ìöå/ÏÉùÏÑ±
    const user = await getOrCreateUser(anonymousId, 'ÏùµÎ™Ö');
    
    // Í∏∞Ï°¥ Ìà¨Ìëú ÏÇ≠Ï†ú
    await pool.query('DELETE FROM votes WHERE post_id = $1 AND user_id = $2', [id, user.id]);
    
    // ÏÉà Ìà¨Ìëú Ï∂îÍ∞Ä
    if (type === 'like' || type === 'dislike') {
      await pool.query(
        'INSERT INTO votes (post_id, user_id, vote_type) VALUES ($1, $2, $3)',
        [id, user.id, type]
      );
    }
    
    // ÏóÖÎç∞Ïù¥Ìä∏Îêú Í≤åÏãúÍ∏Ä Ï°∞Ìöå
    const postResult = await pool.query('SELECT * FROM posts WHERE id = $1', [id]);
    const post = postResult.rows[0];
    
    res.json({ success: true, post, data: post });
  } catch (error) {
    console.error('Ìà¨Ìëú Ïã§Ìå®:', error);
    res.status(500).json({ success: false, message: 'Ìà¨ÌëúÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.' });
  }
});

// ============================================
// ÎåìÍ∏Ä API
// ============================================

// ÎåìÍ∏Ä ÏûëÏÑ±
app.post('/api/posts/:id/comments', async (req, res) => {
  const client = await pool.connect();
  
  try {
    await client.query('BEGIN');
    
    const { id } = req.params;
    const { author, content, userId: anonymousId, instagram } = req.body;
    
    // ÏÇ¨Ïö©Ïûê Ï°∞Ìöå/ÏÉùÏÑ±
    const user = await getOrCreateUser(anonymousId, author);
    
    // Rate limiting Ï≤¥ÌÅ¨
    const canComment = await checkRateLimit(user.id, 'comment');
    if (!canComment) {
      await client.query('ROLLBACK');
      return res.status(429).json({
        success: false,
        message: 'ÎÑàÎ¨¥ ÎßéÏùÄ ÎåìÍ∏ÄÏùÑ ÏûëÏÑ±ÌñàÏäµÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.',
      });
    }
    
    // ÎåìÍ∏Ä ÏûëÏÑ±
    const commentResult = await client.query(`
      INSERT INTO comments (post_id, user_id, author, content, instagram)
      VALUES ($1, $2, $3, $4, $5)
      RETURNING *
    `, [id, user.id, author, content, instagram]);
    
    const comment = commentResult.rows[0];
    
    await client.query('COMMIT');
    
    // Í≤åÏãúÍ∏Ä ÏûëÏÑ±ÏûêÏóêÍ≤å ÏïåÎ¶º ÏÉùÏÑ±
    const postResult = await client.query('SELECT user_id, title FROM posts WHERE id = $1', [id]);
    if (postResult.rows.length > 0) {
      const postAuthorId = postResult.rows[0].user_id;
      
      if (postAuthorId !== user.id) {
        await client.query(`
          INSERT INTO notifications (user_id, type, title, message, post_id, from_user_id)
          VALUES ($1, $2, $3, $4, $5, $6)
        `, [
          postAuthorId,
          'new_comment',
          'ÏÉà ÎåìÍ∏Ä ÏïåÎ¶º',
          `${author}ÎãòÏù¥ "${postResult.rows[0].title}" Í≤åÏãúÍ∏ÄÏóê ÎåìÍ∏ÄÏùÑ ÎÇ®Í≤ºÏäµÎãàÎã§.`,
          id,
          user.id,
        ]);
        
        // WebSocket ÏïåÎ¶º
        broadcastNotification({
          type: 'new_comment',
          userId: postAuthorId,
          postId: id,
          comment: {
            author,
            content,
          },
        });
      }
    }
    
    res.json({ success: true, comment, data: comment });
    console.log(`üí¨ ÏÉà ÎåìÍ∏Ä: ${author} on post ${id}`);
  } catch (error) {
    await client.query('ROLLBACK');
    console.error('ÎåìÍ∏Ä ÏûëÏÑ± Ïã§Ìå®:', error);
    res.status(500).json({ success: false, message: 'ÎåìÍ∏Ä ÏûëÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.' });
  } finally {
    client.release();
  }
});

// ============================================
// Í≤ÄÏÉâ API
// ============================================

// Ï†ÑÏ≤¥ Í≤ÄÏÉâ (Í≤åÏãúÍ∏Ä + ÎåìÍ∏Ä)
app.get('/api/search', async (req, res) => {
  try {
    const { q, type = 'all', page = 1, limit = 20 } = req.query;
    
    if (!q) {
      return res.status(400).json({ success: false, message: 'Í≤ÄÏÉâÏñ¥Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.' });
    }
    
    const offset = (page - 1) * limit;
    const results = {};
    
    // Í≤åÏãúÍ∏Ä Í≤ÄÏÉâ
    if (type === 'all' || type === 'posts') {
      const postsResult = await pool.query(`
        SELECT 
          p.*,
          c.name AS category_name,
          ts_rank(p.search_vector, plainto_tsquery('simple', $1)) AS rank
        FROM posts p
        LEFT JOIN categories c ON p.category_id = c.id
        WHERE p.search_vector @@ plainto_tsquery('simple', $1)
          AND p.is_blinded = FALSE
          AND p.deleted_at IS NULL
        ORDER BY rank DESC, p.created_at DESC
        LIMIT $2 OFFSET $3
      `, [q, limit, offset]);
      
      results.posts = postsResult.rows;
    }
    
    // ÎåìÍ∏Ä Í≤ÄÏÉâ
    if (type === 'all' || type === 'comments') {
      const commentsResult = await pool.query(`
        SELECT 
          c.*,
          p.title AS post_title,
          p.id AS post_id
        FROM comments c
        JOIN posts p ON c.post_id = p.id
        WHERE c.content ILIKE $1
          AND c.is_blinded = FALSE
          AND c.deleted_at IS NULL
          AND p.is_blinded = FALSE
          AND p.deleted_at IS NULL
        ORDER BY c.created_at DESC
        LIMIT $2 OFFSET $3
      `, [`%${q}%`, limit, offset]);
      
      results.comments = commentsResult.rows;
    }
    
    res.json({ success: true, query: q, results });
  } catch (error) {
    console.error('Í≤ÄÏÉâ Ïã§Ìå®:', error);
    res.status(500).json({ success: false, message: 'Í≤ÄÏÉâÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.' });
  }
});

// ============================================
// Ïπ¥ÌÖåÍ≥†Î¶¨ API
// ============================================

app.get('/api/categories', async (req, res) => {
  try {
    const result = await pool.query(`
      SELECT c.*, COUNT(p.id) AS post_count
      FROM categories c
      LEFT JOIN posts p ON c.id = p.category_id AND p.is_blinded = FALSE AND p.deleted_at IS NULL
      WHERE c.is_active = TRUE
      GROUP BY c.id
      ORDER BY c.sort_order
    `);
    
    res.json({ success: true, categories: result.rows });
  } catch (error) {
    console.error('Ïπ¥ÌÖåÍ≥†Î¶¨ Ï°∞Ìöå Ïã§Ìå®:', error);
    res.status(500).json({ success: false, message: 'Ïπ¥ÌÖåÍ≥†Î¶¨ Ï°∞ÌöåÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.' });
  }
});

// ============================================
// ÏïåÎ¶º API
// ============================================

// ÎÇ¥ ÏïåÎ¶º Ï°∞Ìöå
app.get('/api/notifications', async (req, res) => {
  try {
    const { userId: anonymousId, unreadOnly = 'false' } = req.query;
    
    // ÏÇ¨Ïö©Ïûê Ï°∞Ìöå
    const userResult = await pool.query('SELECT id FROM users WHERE anonymous_id = $1', [anonymousId]);
    if (userResult.rows.length === 0) {
      return res.json({ success: true, notifications: [] });
    }
    
    const userId = userResult.rows[0].id;
    
    let query = `
      SELECT *
      FROM notifications
      WHERE user_id = $1 AND is_deleted = FALSE
    `;
    
    if (unreadOnly === 'true') {
      query += ' AND is_read = FALSE';
    }
    
    query += ' ORDER BY created_at DESC LIMIT 50';
    
    const result = await pool.query(query, [userId]);
    
    res.json({ success: true, notifications: result.rows });
  } catch (error) {
    console.error('ÏïåÎ¶º Ï°∞Ìöå Ïã§Ìå®:', error);
    res.status(500).json({ success: false, message: 'ÏïåÎ¶º Ï°∞ÌöåÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.' });
  }
});

// ÏïåÎ¶º ÏùΩÏùå Ï≤òÎ¶¨
app.put('/api/notifications/:id/read', async (req, res) => {
  try {
    const { id } = req.params;
    
    await pool.query(
      'UPDATE notifications SET is_read = TRUE, read_at = NOW() WHERE id = $1',
      [id]
    );
    
    res.json({ success: true });
  } catch (error) {
    console.error('ÏïåÎ¶º ÏùΩÏùå Ï≤òÎ¶¨ Ïã§Ìå®:', error);
    res.status(500).json({ success: false, message: 'ÏïåÎ¶º ÏùΩÏùå Ï≤òÎ¶¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.' });
  }
});

// ============================================
// ÌÜµÍ≥Ñ API
// ============================================

app.get('/api/stats', async (req, res) => {
  try {
    const stats = {};
    
    // Ï†ÑÏ≤¥ Í≤åÏãúÍ∏Ä Ïàò
    const postsResult = await pool.query(
      'SELECT COUNT(*) FROM posts WHERE is_blinded = FALSE AND deleted_at IS NULL'
    );
    stats.totalPosts = parseInt(postsResult.rows[0].count);
    
    // Ï†ÑÏ≤¥ ÎåìÍ∏Ä Ïàò
    const commentsResult = await pool.query(
      'SELECT COUNT(*) FROM comments WHERE is_blinded = FALSE AND deleted_at IS NULL'
    );
    stats.totalComments = parseInt(commentsResult.rows[0].count);
    
    // Ï†ÑÏ≤¥ Ï°∞ÌöåÏàò
    const viewsResult = await pool.query('SELECT SUM(views) FROM posts');
    stats.totalViews = parseInt(viewsResult.rows[0].sum) || 0;
    
    // ÌôúÏÑ± ÏÇ¨Ïö©Ïûê (ÏµúÍ∑º 7Ïùº)
    const activeUsersResult = await pool.query(`
      SELECT COUNT(DISTINCT id)
      FROM users
      WHERE last_active > NOW() - INTERVAL '7 days'
    `);
    stats.activeUsers = parseInt(activeUsersResult.rows[0].count);
    
    res.json({ success: true, stats });
  } catch (error) {
    console.error('ÌÜµÍ≥Ñ Ï°∞Ìöå Ïã§Ìå®:', error);
    res.status(500).json({ success: false, message: 'ÌÜµÍ≥Ñ Ï°∞ÌöåÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.' });
  }
});

// ============================================
// WebSocket Ìï∏Îì§Îü¨
// ============================================

wss.on('connection', (ws, req) => {
  console.log('‚úÖ WebSocket Ïó∞Í≤∞:', req.socket.remoteAddress);
  
  ws.on('message', (message) => {
    try {
      const data = JSON.parse(message);
      console.log('üì® WebSocket Î©îÏãúÏßÄ:', data);
      
      // Echo back
      ws.send(JSON.stringify({ type: 'echo', data }));
    } catch (error) {
      console.error('WebSocket Î©îÏãúÏßÄ Ï≤òÎ¶¨ Ïã§Ìå®:', error);
    }
  });
  
  ws.on('close', () => {
    console.log('‚ùå WebSocket Ïó∞Í≤∞ Ï¢ÖÎ£å');
  });
  
  ws.on('error', (error) => {
    console.error('WebSocket ÏóêÎü¨:', error);
  });
  
  // Ïó∞Í≤∞ ÌôïÏù∏ Î©îÏãúÏßÄ
  ws.send(JSON.stringify({
    type: 'connected',
    message: 'WebSocket Ïó∞Í≤∞ ÏÑ±Í≥µ',
    timestamp: new Date().toISOString(),
  }));
});

// ============================================
// ÏÑúÎ≤Ñ ÏãúÏûë
// ============================================

server.listen(PORT, async () => {
  console.log(`
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë   üèÉ Athlete Time Server (PostgreSQL)    ‚ïë
‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
‚ïë  Ìè¨Ìä∏: ${PORT}                              ‚ïë
‚ïë  ÌôòÍ≤Ω: ${NODE_ENV}                         ‚ïë
‚ïë  Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§: PostgreSQL ‚úÖ                ‚ïë
‚ïë  Ïù¥ÎØ∏ÏßÄ Ï†ÄÏû•: Cloudinary ‚úÖ                 ‚ïë
‚ïë  Ïã§ÏãúÍ∞Ñ ÏïåÎ¶º: WebSocket ‚úÖ                  ‚ïë
‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
‚ïë  Ï£ºÏöî Í∏∞Îä•:                                 ‚ïë
‚ïë  ‚úÖ Í≤åÏãúÍ∏Ä CRUD + Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú            ‚ïë
‚ïë  ‚úÖ ÎåìÍ∏Ä ÏãúÏä§ÌÖú + Ïã§ÏãúÍ∞Ñ ÏïåÎ¶º              ‚ïë
‚ïë  ‚úÖ Ï†ÑÏ≤¥ Í≤ÄÏÉâ (Full-text search)          ‚ïë
‚ïë  ‚úÖ Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ ÌïÑÌÑ∞ÎßÅ                      ‚ïë
‚ïë  ‚úÖ Rate Limiting                         ‚ïë
‚ïë  ‚úÖ ÏûêÎèô Î∏îÎùºÏù∏Îìú Ï≤òÎ¶¨                     ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
  `);
  
  // Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ïó∞Í≤∞ ÌôïÏù∏
  try {
    await pool.query('SELECT NOW()');
    console.log('‚úÖ PostgreSQL Ïó∞Í≤∞ ÏÑ±Í≥µ');
  } catch (error) {
    console.error('‚ùå PostgreSQL Ïó∞Í≤∞ Ïã§Ìå®:', error);
  }
});

// Ï†ïÎ¶¨ ÏûëÏóÖ
process.on('SIGINT', async () => {
  console.log('\nüõë ÏÑúÎ≤Ñ Ï¢ÖÎ£å Ï§ë...');
  
  // WebSocket Ïó∞Í≤∞ Ï¢ÖÎ£å
  wss.clients.forEach(client => {
    client.close();
  });
  
  // Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ïó∞Í≤∞ Ï¢ÖÎ£å
  await pool.end();
  
  server.close(() => {
    console.log('‚úÖ ÏÑúÎ≤ÑÍ∞Ä Ï†ïÏÉÅÏ†ÅÏúºÎ°ú Ï¢ÖÎ£åÎêòÏóàÏäµÎãàÎã§.');
    process.exit(0);
  });
});

process.on('SIGTERM', async () => {
  console.log('\nüõë ÏÑúÎ≤Ñ Ï¢ÖÎ£å Ï§ë...');
  await pool.end();
  server.close(() => {
    console.log('‚úÖ ÏÑúÎ≤ÑÍ∞Ä Ï†ïÏÉÅÏ†ÅÏúºÎ°ú Ï¢ÖÎ£åÎêòÏóàÏäµÎãàÎã§.');
    process.exit(0);
  });
});

module.exports = { app, server, pool };
