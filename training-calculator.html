<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>전문 훈련 페이스 계산기 | Athlete Time</title>
  
  <!-- PWA 메타 태그 -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#00ffa3">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="애슬리트 타임">
  <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    /* CRITICAL FIX: Prevent text floating at top of screen */
    /* Reset all positioning to prevent floating text */
    .floating-element,
    .top-floating,
    .absolute-position,
    .fixed-position {
      display: none !important;
      visibility: hidden !important;
      position: static !important;
      top: auto !important;
      left: auto !important;
      right: auto !important;
      bottom: auto !important;
      z-index: -999 !important;
    }
    
    /* Ensure proper content container positioning */
    .content-container {
      position: relative !important;
      margin-top: 0 !important;
      padding-top: 0 !important;
    }
    
    /* Fix for text positioning issues - add proper layout structure */
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Malgun Gothic', '맑은 고딕', sans-serif;
      position: relative;
      min-height: 100vh;
      padding-top: 0; /* Remove any default padding that might push content down */
    }
    
    /* Ensure proper stacking context for all content */
    .main-content-wrapper {
      position: relative;
      z-index: 1;
      padding-top: 1rem;
      margin-top: 0; /* Remove any margin that might cause positioning issues */
    }
    
    /* Fix for header positioning */
    .gradient-bg {
      position: relative;
      z-index: 40; /* Consistent header z-index */
    }
    
    /* Ensure floating elements don't interfere with main content */
    .env-floating-btn {
      z-index: 30; /* Below header but above content */
    }
    
    /* Hide floating elements that appear outside proper container */
    .floating-element {
      display: none !important;
      visibility: hidden !important;
    }
    
    /* Fix for any elements that might be positioned incorrectly */
    .floating-text, .top-floating-text {
      display: none !important;
      visibility: hidden !important;
      position: absolute !important;
      top: -9999px !important;
      left: -9999px !important;
    }
    
    /* Ensure all content stays within proper container boundaries */
    .training-calculator-content {
      position: relative;
      z-index: 1;
      margin-top: 0;
      padding-top: 0;
    }
    
    /* Ensure proper content flow and prevent text overflow */
    .content-container {
      position: relative;
      width: 100%;
      max-width: 100%;
      overflow-x: hidden;
      margin-top: 0 !important; /* Override any margin that might push content to top */
      padding-top: 0 !important; /* Override any padding that might affect positioning */
    }
    
    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    /* 슬라이더 커스텀 스타일 */
    .custom-slider {
      -webkit-appearance: none;
      appearance: none;
      height: 6px;
      border-radius: 3px;
      background: #e5e7eb;
      outline: none;
      transition: background 0.3s;
    }
    
    .custom-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #8b5cf6;
      cursor: grab;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      transition: all 0.2s;
    }
    
    .custom-slider::-webkit-slider-thumb:hover {
      transform: scale(1.2);
      background: #7c3aed;
    }
    
    .custom-slider::-webkit-slider-thumb:active {
      cursor: grabbing;
      transform: scale(1.1);
    }
    
    .custom-slider::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #8b5cf6;
      cursor: grab;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      transition: all 0.2s;
    }
    
    .pace-slider { background: linear-gradient(to right, #10b981 0%, #fbbf24 50%, #ef4444 100%); }
    .volume-slider { background: linear-gradient(to right, #3b82f6 0%, #8b5cf6 50%, #ec4899 100%); }
    .intensity-slider { background: linear-gradient(to right, #06b6d4 0%, #f97316 50%, #dc2626 100%); }
    
    .training-zone-easy { 
      background: linear-gradient(135deg, #10b981, #059669); 
    }
    .training-zone-marathon { 
      background: linear-gradient(135deg, #3b82f6, #2563eb); 
    }
    .training-zone-threshold { 
      background: linear-gradient(135deg, #f59e0b, #d97706); 
    }
    .training-zone-interval { 
      background: linear-gradient(135deg, #ef4444, #dc2626); 
    }
    .training-zone-repetition { 
      background: linear-gradient(135deg, #a855f7, #9333ea); 
    }
    
    .phase-card {
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .phase-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    }
    
    .intensity-low { 
      border-left: 4px solid #10b981; 
      background: linear-gradient(to right, rgba(16, 185, 129, 0.05), transparent);
    }
    .intensity-medium { 
      border-left: 4px solid #3b82f6; 
      background: linear-gradient(to right, rgba(59, 130, 246, 0.05), transparent);
    }
    .intensity-high { 
      border-left: 4px solid #ef4444; 
      background: linear-gradient(to right, rgba(239, 68, 68, 0.05), transparent);
    }
    .intensity-rest { 
      border-left: 4px solid #6b7280; 
      background: linear-gradient(to right, rgba(107, 114, 128, 0.05), transparent);
    }
  
  /* PWA 간단한 설치 버튼 - Fix positioning conflict */
  .simple-install-btn {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #00ffa3, #00d4ff);
      color: #0f0f0f;
      padding: 10px 18px;
      border-radius: 25px;
      border: none;
      font-weight: 700;
      font-size: 0.9rem;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0, 255, 163, 0.4);
      z-index: 1000; /* Reduced from 9999 to prevent overlap */
      display: none;
      align-items: center;
      gap: 6px;
      transition: all 0.3s;
    }
    
    .simple-install-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 255, 163, 0.6);
    }
    
    .simple-install-btn.show {
      display: inline-flex;
    }

  <style>
    /* 커스텀 스크롤바 스타일 */
    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }
    
    ::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.1);
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, #667eea, #764ba2);
      border-radius: 10px;
      transition: all 0.3s;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(135deg, #764ba2, #667eea);
    }
    
    /* Firefox */
    * {
      scrollbar-width: thin;
      scrollbar-color: #667eea rgba(0, 0, 0, 0.1);
    }
    /* 환경 선택 모달 스타일 - Fix z-index conflict */
    .env-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 2000; /* Increased to ensure it's above other elements */
      justify-content: center;
      align-items: center;
    }
    
    .env-modal.active {
      display: flex;
    }
    
    .env-modal-content {
      background: white;
      border-radius: 20px;
      padding: 2rem;
      max-width: 600px;
      width: 90%;
      animation: fadeInUp 0.3s ease;
    }
    
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .env-button {
      border: 2px solid #e5e7eb;
      transition: all 0.3s;
      cursor: pointer;
    }
    
    .env-button:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    
    .env-button.selected {
      border-color: #8b5cf6;
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(124, 58, 237, 0.1));
    }
    
    /* Fix layout structure to prevent text overflow */
    .main-content-wrapper {
      position: relative;
      z-index: 1;
      min-height: calc(100vh - 80px); /* Account for header height */
      padding-top: 1rem;
    }
    
    /* Ensure proper content flow */
    .content-container {
      position: relative;
      width: 100%;
      max-width: 100%;
      overflow-x: hidden;
    }
    
    /* Fix for gradient header positioning */
    .gradient-bg.sticky {
      position: sticky;
      top: 0;
      z-index: 50;
    }
    
    /* 플로팅 환경 변경 버튼 (모바일) */
    .env-floating-btn {
      display: none;
      position: fixed;
      bottom: 80px;
      right: 20px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: linear-gradient(135deg, #8b5cf6, #7c3aed);
      color: white;
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
      z-index: 30; /* Reduced from 100 to prevent overlap with header */
      justify-content: center;
      align-items: center;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .env-floating-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(139, 92, 246, 0.6);
    }
    
    @media (max-width: 768px) {
      .env-floating-btn {
        display: flex;
      }
    }
    
    /* PWA 간단한 설치 버튼 - Fix positioning conflict */
    .simple-install-btn {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #00ffa3, #00d4ff);
      color: #0f0f0f;
      padding: 10px 18px;
      border-radius: 25px;
      border: none;
      font-weight: 700;
      font-size: 0.9rem;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0, 255, 163, 0.4);
      z-index: 1000;
      display: none;
      align-items: center;
      gap: 6px;
      transition: all 0.3s;
    }
    
    .simple-install-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 255, 163, 0.6);
    }
    
    .simple-install-btn.show {
      display: inline-flex;
    }
  </style>
    <i class="fas fa-exchange-alt text-xl"></i>
  </button>
  
  <!-- 환경 선택 모달 -->
  <div id="envModal" class="env-modal">
    <div class="env-modal-content">
      <div class="text-center mb-6">
        <h2 class="text-2xl font-bold mb-2">
          <span style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
            환경을 선택해주세요
          </span>
        </h2>
        <p class="text-gray-600">사용 중인 기기에 맞는 환경을 선택하면 최적화된 화면을 제공합니다</p>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        <div class="env-button rounded-lg p-6 text-center" onclick="selectEnvironment('mobile')">
          <i class="fas fa-mobile-alt text-5xl mb-4" style="color: #8b5cf6;"></i>
          <h3 class="text-xl font-bold mb-2">모바일</h3>
          <p class="text-sm text-gray-600">스마트폰, 태블릿</p>
          <ul class="text-xs text-gray-500 mt-3 text-left">
            <li>• 터치 최적화 인터페이스</li>
            <li>• 세로 화면에 최적화</li>
            <li>• 스크롤 가능한 테이블</li>
          </ul>
        </div>
        
        <div class="env-button rounded-lg p-6 text-center" onclick="selectEnvironment('desktop')">
          <i class="fas fa-desktop text-5xl mb-4" style="color: #7c3aed;"></i>
          <h3 class="text-xl font-bold mb-2">데스크톱</h3>
          <p class="text-sm text-gray-600">노트북, 데스크톱 PC</p>
          <ul class="text-xs text-gray-500 mt-3 text-left">
            <li>• 전체 화면 활용</li>
            <li>• 마우스 조작 최적화</li>
            <li>• 한 번에 모든 정보 표시</li>
          </ul>
        </div>
      </div>
      
      <div class="flex items-center gap-2 mb-4">
        <input type="checkbox" id="rememberChoice" checked>
        <label for="rememberChoice" class="text-sm text-gray-600">이 선택 기억하기 (30일간)</label>
      </div>
      
      <div class="text-center">
        <button type="button" onclick="confirmEnvironment()" class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-8 py-3 rounded-lg font-medium hover:opacity-90 transition">
          확인
        </button>
      </div>
    </div>
  </div>
  <div class="max-w-7xl mx-auto p-6 main-content-wrapper">
    <!-- Header -->
    <div class="gradient-bg text-white p-6 rounded-xl mb-6 content-container">
      <div class="flex justify-between items-start">
        <div>
          <h1 class="text-3xl font-bold mb-2">전문 훈련 페이스 계산기</h1>
          <p class="opacity-90">Jack Daniels VDOT 시스템 기반 과학적 훈련</p>
        </div>
        <div class="flex gap-2">
          <!-- 환경 변경 버튼 -->
          <button type="button" onclick="showEnvironmentModal()" class="flex items-center gap-2 px-3 py-2 bg-white/20 hover:bg-white/30 rounded-lg transition" title="환경 변경">
            <span class="hidden md:inline text-sm">환경 변경</span>
            <i class="fas fa-mobile-alt text-lg md:hidden" id="envIconMobile"></i>
            <i class="fas fa-desktop text-lg hidden md:inline" id="envIconDesktop"></i>
          </button>
          <button type="button" onclick="window.location.href='system-documentation.html'" class="bg-white/20 hover:bg-white/30 p-3 rounded-lg transition" title="시스템 문서">
            <i class="fas fa-book text-xl"></i>
          </button>
          <button type="button" onclick="window.location.href='index.html'" class="bg-white/20 hover:bg-white/30 p-3 rounded-lg transition" title="홈으로">
            <i class="fas fa-home text-xl"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Step 1: Athlete Profile -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
      <div class="flex justify-between items-start mb-6">
        <h2 class="text-2xl font-bold flex items-center">
          <span class="bg-purple-100 text-purple-600 w-10 h-10 rounded-full flex items-center justify-center mr-3">1</span>
          선수 프로필 설정
        </h2>
        <button type="button" onclick="showQuickHelp()" class="text-purple-600 hover:text-purple-800 transition" title="도움말">
          <i class="fas fa-question-circle text-xl"></i>
        </button>
      </div>
      
      <div class="grid md:grid-cols-3 gap-6">
        <!-- Basic Info -->
        <div>
          <h3 class="font-semibold mb-3 text-gray-700">기본 정보</h3>
          
          <div class="mb-4">
            <label class="block text-sm font-medium mb-2">성별</label>
            <div class="grid grid-cols-2 gap-2">
              <button type="button" onclick="selectGender('male')" id="btn-male" 
                class="p-3 border-2 rounded-lg transition text-center hover:border-purple-500">
                <i class="fas fa-mars text-blue-500 text-xl"></i>
                <div class="text-sm mt-1">남성</div>
              </button>
              <button type="button" onclick="selectGender('female')" id="btn-female"
                class="p-3 border-2 rounded-lg transition text-center hover:border-purple-500">
                <i class="fas fa-venus text-pink-500 text-xl"></i>
                <div class="text-sm mt-1">여성</div>
              </button>
            </div>
          </div>
          
          <div class="mb-4">
            <label class="block text-sm font-medium mb-2">연령대</label>
            <select id="ageGroup" class="w-full p-2 border rounded-lg">
              <option value="junior">주니어 (18세 이하)</option>
              <option value="senior" selected>시니어 (19-39세)</option>
              <option value="master40">마스터즈 40+ (40-49세)</option>
              <option value="master50">마스터즈 50+ (50-59세)</option>
              <option value="master60">마스터즈 60+ (60세 이상)</option>
            </select>
          </div>
        </div>

        <!-- Training Level -->
        <div>
          <h3 class="font-semibold mb-3 text-gray-700">훈련 수준</h3>
          
          <div class="mb-4">
            <label class="block text-sm font-medium mb-2">경력</label>
            <select id="experience" class="w-full p-2 border rounded-lg">
              <option value="beginner">초급 (1년 미만)</option>
              <option value="intermediate" selected>중급 (1-3년)</option>
              <option value="advanced">고급 (3-5년)</option>
              <option value="elite">엘리트 (5년 이상)</option>
            </select>
          </div>
          
          <div class="mb-4">
            <label class="block text-sm font-medium mb-2">주간 훈련량</label>
            <select id="weeklyVolume" class="w-full p-2 border rounded-lg">
              <option value="low">30km 이하</option>
              <option value="moderate" selected>30-60km</option>
              <option value="high">60-100km</option>
              <option value="very-high">100km 이상</option>
            </select>
          </div>
        </div>

        <!-- Training Pattern -->
        <div>
          <h3 class="font-semibold mb-3 text-gray-700">훈련 패턴</h3>
          
          <div class="mb-4">
            <label class="block text-sm font-medium mb-2">훈련 빈도</label>
            <select id="frequency" class="w-full p-2 border rounded-lg">
              <option value="3-4">주 3-4회</option>
              <option value="5-6" selected>주 5-6회</option>
              <option value="7">주 7회</option>
              <option value="double">2회/일 (엘리트)</option>
            </select>
          </div>
          
          <div class="mb-4">
            <label class="block text-sm font-medium mb-2">현재 훈련 단계</label>
            <select id="trainingPhase" class="w-full p-2 border rounded-lg">
              <option value="base">기초 체력기</option>
              <option value="build" selected>전문 체력기</option>
              <option value="peak">피킹 단계</option>
              <option value="taper">테이퍼링</option>
              <option value="recovery">회복기</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <!-- Step 2: Performance Input -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
      <h2 class="text-2xl font-bold mb-6 flex items-center">
        <span class="bg-purple-100 text-purple-600 w-10 h-10 rounded-full flex items-center justify-center mr-3">2</span>
        기준 기록 입력
      </h2>
      
      <div class="grid md:grid-cols-2 gap-6">
        <div>
          <label class="block text-sm font-medium mb-2">종목 선택</label>
          <select id="eventDistance" class="w-full p-3 border rounded-lg mb-4">
            <option value="">종목을 선택하세요</option>
            <option value="800">800m</option>
            <option value="1500">1500m (1.5km)</option>
            <option value="3000">3000m (3km)</option>
            <option value="5000">5000m (5km)</option>
            <option value="10000">10000m (10km)</option>
            <option value="21097.5">하프마라톤 (21.0975km)</option>
            <option value="42195">풀마라톤 (42.195km)</option>
          </select>
        </div>
        
        <div>
          <label class="block text-sm font-medium mb-2">기록 입력</label>
          <div class="grid grid-cols-3 gap-2">
            <input type="number" id="hours" placeholder="시" min="0" max="23" 
              class="p-3 border rounded-lg text-center" aria-label="hours에 입력">
            <input type="number" id="minutes" placeholder="분" min="0" max="59" 
              class="p-3 border rounded-lg text-center" aria-label="minutes에 입력">
            <input type="number" id="seconds" placeholder="초" min="0" max="59" step="0.1"
              class="p-3 border rounded-lg text-center" aria-label="seconds에 입력">
          </div>
        </div>
      </div>
      
      <button type="button" onclick="calculateTraining()" 
        class="mt-6 bg-gradient-to-r from-purple-600 to-pink-600 text-white px-8 py-3 rounded-lg font-semibold hover:shadow-lg transition">
        <i class="fas fa-calculator mr-2"></i>훈련 계획 생성
      </button>
    </div>

    <!-- Step 3: Fine-Tuning Controls -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
      <h2 class="text-2xl font-bold mb-6 flex items-center">
        <span class="bg-amber-100 text-amber-600 w-10 h-10 rounded-full flex items-center justify-center mr-3">3</span>
        개별 미세 조정
      </h2>
      
      <div class="space-y-6">
        <!-- 페이스 조정 -->
        <div>
          <div class="flex justify-between items-center mb-2">
            <label class="font-medium flex items-center">
              <i class="fas fa-running text-green-500 mr-2"></i>
              페이스 조정
            </label>
            <span id="paceValue" class="font-bold text-lg">100%</span>
          </div>
          <input type="range" id="paceAdjust" min="85" max="115" value="100" step="0.5"
            class="custom-slider pace-slider w-full" oninput="updateFineTuning('pace')" aria-label="paceAdjust에 입력">
          <div class="flex justify-between text-xs text-gray-500 mt-1">
            <span>느리게 (-15%)</span>
            <span>기준</span>
            <span>빠르게 (+15%)</span>
          </div>
        </div>
        
        <!-- 훈련량 조정 -->
        <div>
          <div class="flex justify-between items-center mb-2">
            <label class="font-medium flex items-center">
              <i class="fas fa-chart-line text-blue-500 mr-2"></i>
              훈련량 조정
            </label>
            <span id="volumeValue" class="font-bold text-lg">100%</span>
          </div>
          <input type="range" id="volumeAdjust" min="60" max="140" value="100" step="1"
            class="custom-slider volume-slider w-full" oninput="updateFineTuning('volume')" aria-label="volumeAdjust에 입력">
          <div class="flex justify-between text-xs text-gray-500 mt-1">
            <span>감소 (-40%)</span>
            <span>기준</span>
            <span>증가 (+40%)</span>
          </div>
        </div>
        
        <!-- 강도 조정 -->
        <div>
          <div class="flex justify-between items-center mb-2">
            <label class="font-medium flex items-center">
              <i class="fas fa-fire text-red-500 mr-2"></i>
              강도 조정
            </label>
            <span id="intensityValue" class="font-bold text-lg">100%</span>
          </div>
          <input type="range" id="intensityAdjust" min="70" max="130" value="100" step="0.5"
            class="custom-slider intensity-slider w-full" oninput="updateFineTuning('intensity')" aria-label="intensityAdjust에 입력">
          <div class="flex justify-between text-xs text-gray-500 mt-1">
            <span>낮춤 (-30%)</span>
            <span>기준</span>
            <span>높임 (+30%)</span>
          </div>
        </div>
        
        <!-- 리셋 버튼 -->
        <button type="button" onclick="resetFineTuning()" 
          class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 py-2 rounded-lg transition">
          <i class="fas fa-undo mr-2"></i>기본값으로 재설정
        </button>
      </div>
    </div>
    
    <!-- Step 4: Special Conditions -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
      <h2 class="text-2xl font-bold mb-6 flex items-center">
        <span class="bg-purple-100 text-purple-600 w-10 h-10 rounded-full flex items-center justify-center mr-3">4</span>
        특별 고려사항 (선택)
      </h2>
      
      <div class="grid md:grid-cols-3 gap-4">
        <label class="flex items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100 cursor-pointer">
          <input type="checkbox" id="injury_recovery" class="mr-3 w-5 h-5">
          <div>
            <div class="font-medium">부상 회복중</div>
            <div class="text-xs text-gray-600">훈련량 60%, 강도 70%</div>
          </div>
        </label>
        
        <label class="flex items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100 cursor-pointer">
          <input type="checkbox" id="high_fatigue" class="mr-3 w-5 h-5">
          <div>
            <div class="font-medium">피로 누적</div>
            <div class="text-xs text-gray-600">회복 위주 프로그램</div>
          </div>
        </label>
        
        <label class="flex items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100 cursor-pointer">
          <input type="checkbox" id="altitude" class="mr-3 w-5 h-5">
          <div>
            <div class="font-medium">고지대 훈련</div>
            <div class="text-xs text-gray-600">페이스 3% 조정</div>
          </div>
        </label>
        
        <div class="p-3 bg-gray-50 rounded-lg">
          <div class="font-medium mb-2">환경 조건</div>
          <select id="environment" class="w-full p-2 border rounded text-sm" onchange="calculateAdjustments(); realtimeUpdateTraining();">
            <option value="normal">보통 (15-20°C)</option>
            <option value="cold">추운 날씨 (<10°C)</option>
            <option value="hot">더운 날씨 (>25°C)</option>
            <option value="humid">고온다습 (>25°C, 습도 >70%)</option>
          </select>
          <div class="text-xs text-gray-600 mt-1">페이스 자동 조정</div>
        </div>
        
        <label class="flex items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100 cursor-pointer">
          <input type="checkbox" id="weight_loss" class="mr-3 w-5 h-5">
          <div>
            <div class="font-medium">체중 감량 목표</div>
            <div class="text-xs text-gray-600">유산소 비중 증가</div>
          </div>
        </label>
        
        <label class="flex items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100 cursor-pointer">
          <input type="checkbox" id="morning_only" class="mr-3 w-5 h-5">
          <div>
            <div class="font-medium">아침 훈련만 가능</div>
            <div class="text-xs text-gray-600">워밍업 시간 증가</div>
          </div>
        </label>
      </div>
    </div>

    <!-- Results Section -->
    <div id="resultsSection" class="hidden">
      <!-- VDOT Score -->
      <div class="bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-xl p-6 mb-6">
        <div class="grid md:grid-cols-3 gap-6">
          <div class="text-center">
            <div class="text-5xl font-bold" id="vdotScore">--</div>
            <div class="text-sm opacity-90 mt-1">VDOT 점수</div>
            <div class="text-xs opacity-75 mt-1" id="vdotAdjustment"></div>
          </div>
          <div class="text-center">
            <div class="text-3xl font-semibold" id="performanceLevel">--</div>
            <div class="text-sm opacity-90 mt-1">수준 평가</div>
          </div>
          <div class="text-center">
            <div class="text-2xl" id="predictedVO2max">--</div>
            <div class="text-sm opacity-90 mt-1">예상 VO₂max (ml/kg/min)</div>
          </div>
        </div>
      </div>

      <!-- Training Zones -->
      <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
        <h3 class="text-xl font-bold mb-4">훈련 구역별 페이스</h3>
        
        <div class="space-y-3">
          <!-- Easy Zone -->
          <div class="training-zone-easy text-white p-4 rounded-lg">
            <div class="flex justify-between items-start">
              <div class="flex-grow">
                <div class="font-bold text-lg">Easy (E) - 회복/기초지구력</div>
                <div class="text-sm opacity-90">RPE: <span id="easyRPE">3-4/10</span></div>
                <div class="text-xs opacity-80 mt-1" id="easyDesc">대화 가능한 편안한 속도</div>
              </div>
              <div class="text-right">
                <div class="text-xl font-bold" id="easyPace">--</div>
                <div class="text-xs opacity-80">범위</div>
              </div>
            </div>
          </div>
          
          <!-- Marathon Zone -->
          <div class="training-zone-marathon text-white p-4 rounded-lg">
            <div class="flex justify-between items-start">
              <div class="flex-grow">
                <div class="font-bold text-lg">Marathon (M) - 마라톤 페이스</div>
                <div class="text-sm opacity-90">RPE: <span id="marathonRPE">5-6/10</span></div>
                <div class="text-xs opacity-80 mt-1" id="marathonDesc">2-4시간 유지 가능</div>
              </div>
              <div class="text-right">
                <div class="text-xl font-bold" id="marathonPace">--</div>
                <div class="text-xs opacity-80" id="marathonTarget"></div>
              </div>
            </div>
          </div>
          
          <!-- Threshold Zone -->
          <div class="training-zone-threshold text-white p-4 rounded-lg">
            <div class="flex justify-between items-start">
              <div class="flex-grow">
                <div class="font-bold text-lg">Threshold (T) - 젖산역치</div>
                <div class="text-sm opacity-90">RPE: <span id="thresholdRPE">7-8/10</span></div>
                <div class="text-xs opacity-80 mt-1" id="thresholdDesc">편안하게 힘든 정도</div>
              </div>
              <div class="text-right">
                <div class="text-xl font-bold" id="thresholdPace">--</div>
                <div class="text-xs opacity-80" id="thresholdTarget"></div>
              </div>
            </div>
          </div>
          
          <!-- Interval Zone -->
          <div class="training-zone-interval text-white p-4 rounded-lg">
            <div class="flex justify-between items-start">
              <div class="flex-grow">
                <div class="font-bold text-lg">Interval (I) - VO₂max 향상</div>
                <div class="text-sm opacity-90">RPE: <span id="intervalRPE">9/10</span></div>
                <div class="text-xs opacity-80 mt-1" id="intervalDesc">매우 힘듦, 3-8분 반복</div>
              </div>
              <div class="text-right">
                <div class="text-xl font-bold" id="intervalPace">--</div>
                <div class="text-xs opacity-80" id="intervalTarget"></div>
              </div>
            </div>
          </div>
          
          <!-- Repetition Zone -->
          <div class="training-zone-repetition text-white p-4 rounded-lg">
            <div class="flex justify-between items-start">
              <div class="flex-grow">
                <div class="font-bold text-lg">Repetition (R) - 스피드/폼</div>
                <div class="text-sm opacity-90">RPE: <span id="repetitionRPE">10/10</span></div>
                <div class="text-xs opacity-80 mt-1" id="repetitionDesc">최대 노력, 완전 회복 필수</div>
              </div>
              <div class="text-right">
                <div class="text-xl font-bold" id="repetitionPace">--</div>
                <div class="text-xs opacity-80" id="repetitionTarget"></div>
              </div>
            </div>
          </div>
              <div class="text-2xl font-bold" id="repetitionPaceDisplay">--</div>
            </div>
          </div>
        </div>
      </div>

      <!-- 9-10 Day Training Cycle -->
      <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
        <h3 class="text-xl font-bold mb-4 flex items-center">
          <i class="fas fa-calendar-alt text-purple-600 mr-2"></i>
          9-10일 훈련 주기 (주간 계획보다 효과적)
        </h3>
        
        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
          <div class="font-semibold text-blue-700 mb-2">
            <i class="fas fa-info-circle mr-2"></i>왜 9-10일 주기인가?
          </div>
          <ul class="text-sm text-gray-700 space-y-1">
            <li>• 7일 주기는 생물학적 리듬과 맞지 않아 피로 누적 발생</li>
            <li>• 9-10일 주기는 초보상(supercompensation) 원리에 최적화</li>
            <li>• 핵심 훈련 후 충분한 회복 시간 확보 (72-96시간)</li>
            <li>• 월간 3회 고강도 훈련으로 부상 위험 감소</li>
            <li>• 엘리트 선수들의 검증된 훈련 패턴</li>
          </ul>
        </div>
        
        <!-- 9-10일 주기화 옵션 -->
        <div class="mb-6 p-4 bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg border border-purple-200">
          <h4 class="font-bold text-lg mb-3 text-purple-800">
            <i class="fas fa-cogs mr-2"></i>고급 주기화 설정
          </h4>
          
          <div class="grid md:grid-cols-3 gap-4">
            <div>
              <label class="block text-sm font-medium mb-2">주기 타입</label>
              <select id="cycleType" class="w-full p-2 border rounded-lg" onchange="updateNonaryCycle()">
                <option value="9">9일 주기 (고강도 중심)</option>
                <option value="10">10일 주기 (지구력 중심)</option>
                <option value="adaptive">적응형 (AI 기반)</option>
              </select>
            </div>
            
            <div>
              <label class="block text-sm font-medium mb-2">훈련 빈도</label>
              <select id="sessionFrequency" class="w-full p-2 border rounded-lg" onchange="updateNonaryCycle()">
                <option value="single">하루 1회</option>
                <option value="double">하루 2회 (오전/오후)</option>
              </select>
            </div>
            
            <div>
              <label class="block text-sm font-medium mb-2">회복 모드</label>
              <select id="recoveryMode" class="w-full p-2 border rounded-lg" onchange="updateNonaryCycle()">
                <option value="normal">표준</option>
                <option value="aggressive">공격적</option>
                <option value="conservative">보수적</option>
              </select>
            </div>
          </div>
          
          <div class="mt-4 flex items-center">
            <input type="checkbox" id="adaptiveMode" class="mr-2" onchange="toggleAdaptiveMode()">
            <label for="adaptiveMode" class="text-sm font-medium">실시간 적응 모드 (AI 모니터링)</label>
          </div>
        </div>
        
        <div id="trainingCycle" class="space-y-3">
          <!-- 9-10 day cycle will be inserted here -->
        </div>
      </div>

      <!-- Mesocycle Plan -->
      <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
        <h3 class="text-xl font-bold mb-4">메조사이클 (4주 블록)</h3>
        <div id="mesocyclePlan" class="grid md:grid-cols-4 gap-4">
          <!-- 4-week mesocycle will be inserted here -->
        </div>
      </div>

      <!-- Specific Workouts -->
      <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
        <h3 class="text-xl font-bold mb-4">핵심 훈련 세션</h3>
        <div id="workoutDetails" class="grid md:grid-cols-2 gap-4">
          <!-- Detailed workouts will be inserted here -->
        </div>
      </div>

      <!-- Standard Workout Templates -->
      <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
        <h3 class="text-xl font-bold mb-4 flex items-center">
          <i class="fas fa-clipboard-list text-purple-600 mr-2"></i>
          표준 워크아웃 템플릿
        </h3>
        <div class="text-sm text-gray-600 mb-4">
          각 훈련 구역별로 바로 실행 가능한 구체적인 훈련 메뉴입니다.
        </div>
        <div id="workoutTemplates" class="space-y-4">
          <!-- Workout templates will be inserted here -->
        </div>
      </div>

      <!-- Recommendations -->
      <div class="bg-white rounded-xl shadow-lg p-6">
        <h3 class="text-xl font-bold mb-4">전문가 권장사항</h3>
        <div id="recommendations" class="grid md:grid-cols-2 gap-4">
          <!-- Recommendations will be inserted here -->
        </div>
      </div>
    </div>

    <!-- Special Calculators Section -->
    <div class="bg-gradient-to-r from-orange-50 to-red-50 rounded-xl p-6 mb-8 border border-orange-200">
      <h3 class="text-lg font-bold mb-4 text-gray-800">
        <i class="fas fa-tools text-orange-500 mr-2"></i>
        특수 종목 계산기
      </h3>
      <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
        <!-- 3000m Steeplechase Calculator -->
        <a href="3000m-steeplechase-revised.html" 
          class="bg-white rounded-lg p-4 shadow hover:shadow-md transition-all hover:transform hover:-translate-y-1 group">
          <div class="flex items-center mb-2">
            <div class="bg-gradient-to-br from-blue-500 to-indigo-600 text-white w-10 h-10 rounded-lg flex items-center justify-center group-hover:scale-110 transition">
              <i class="fas fa-water"></i>
            </div>
            <h4 class="ml-3 font-semibold text-gray-800">3000m 장애물</h4>
          </div>
          <p class="text-sm text-gray-600 mb-2">
            장애물 경주 페이스 계산 및 전략 수립
          </p>
          <div class="flex items-center text-xs text-gray-500">
            <i class="fas fa-check-circle text-green-500 mr-1"></i>
            <span>World Athletics 공식 규정 적용</span>
          </div>
        </a>

        <!-- Placeholder for future calculators -->
        <div class="bg-gray-100 rounded-lg p-4 opacity-50 cursor-not-allowed">
          <div class="flex items-center mb-2">
            <div class="bg-gray-400 text-white w-10 h-10 rounded-lg flex items-center justify-center">
              <i class="fas fa-route"></i>
            </div>
            <h4 class="ml-3 font-semibold text-gray-600">크로스컨트리</h4>
          </div>
          <p class="text-sm text-gray-500 mb-2">
            지형별 페이스 조정 계산기
          </p>
          <div class="flex items-center text-xs text-gray-400">
            <i class="fas fa-clock mr-1"></i>
            <span>준비중</span>
          </div>
        </div>

        <div class="bg-gray-100 rounded-lg p-4 opacity-50 cursor-not-allowed">
          <div class="flex items-center mb-2">
            <div class="bg-gray-400 text-white w-10 h-10 rounded-lg flex items-center justify-center">
              <i class="fas fa-users"></i>
            </div>
            <h4 class="ml-3 font-semibold text-gray-600">릴레이 전략</h4>
          </div>
          <p class="text-sm text-gray-500 mb-2">
            팀 릴레이 구간 배치 최적화
          </p>
          <div class="flex items-center text-xs text-gray-400">
            <i class="fas fa-clock mr-1"></i>
            <span>준비중</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer with Documentation Link -->
    <div class="text-center mt-8 text-gray-600">
      <div class="mb-4">
        <a href="system-documentation.html" class="inline-flex items-center px-4 py-2 bg-purple-100 hover:bg-purple-200 text-purple-700 rounded-lg transition">
          <i class="fas fa-file-alt mr-2"></i>
          <span class="font-medium">기술 문서 보기</span>
          <span class="text-xs ml-2 bg-purple-200 px-2 py-1 rounded">v2.0</span>
        </a>
      </div>
      <p class="text-sm">제작자: 장호준 코치</p>
      <p class="text-xs mt-1">© 2025 Athlete Time - 과학적 훈련의 시작</p>
    </div>
  </div>

  <script>
    // 환경 설정 관련 변수
    let selectedEnvironment = null;
    
    // 페이지 로드 시 환경 체크
    window.addEventListener('DOMContentLoaded', function() {
      checkEnvironment();
    });
    
    // 환경 체크 및 모달 표시
    function checkEnvironment() {
      const savedEnv = localStorage.getItem('trainingCalculatorEnv');
      const envExpiry = localStorage.getItem('trainingCalculatorEnvExpiry');
      
      // 저장된 환경이 있고 유효기간이 남아있으면 적용
      if (savedEnv && envExpiry && new Date().getTime() < parseInt(envExpiry)) {
        applyEnvironment(savedEnv);
        updateEnvironmentIcon(savedEnv);
      } else {
        // 자동 감지
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth <= 768;
        
        // 모달 표시
        showEnvironmentModal(true);
        
        // 기본 선택 표시
        if (isMobile) {
          document.querySelector('.env-button[onclick*="mobile"]').classList.add('selected');
          selectedEnvironment = 'mobile';
        } else {
          document.querySelector('.env-button[onclick*="desktop"]').classList.add('selected');
          selectedEnvironment = 'desktop';
        }
      }
    }
    
    // 환경 선택 모달 표시
    function showEnvironmentModal(isInitial = false) {
      document.getElementById('envModal').classList.add('active');
      
      // 현재 환경 표시
      const currentEnv = localStorage.getItem('trainingCalculatorEnv') || 
                        (window.innerWidth <= 768 ? 'mobile' : 'desktop');
      
      document.querySelectorAll('.env-button').forEach(btn => {
        btn.classList.remove('selected');
      });
      
      document.querySelector(`.env-button[onclick*="${currentEnv}"]`).classList.add('selected');
      selectedEnvironment = currentEnv;
    }
    
    // 환경 선택
    function selectEnvironment(env) {
      selectedEnvironment = env;
      
      // UI 업데이트
      document.querySelectorAll('.env-button').forEach(btn => {
        btn.classList.remove('selected');
      });
      event.currentTarget.classList.add('selected');
    }
    
    // 환경 확인
    function confirmEnvironment() {
      if (!selectedEnvironment) {
        alert('환경을 선택해주세요.');
        return;
      }
      
      // 기억하기 체크 시 로컬 스토리지에 저장
      if (document.getElementById('rememberChoice').checked) {
        const expiryDate = new Date();
        expiryDate.setDate(expiryDate.getDate() + 30);
        localStorage.setItem('trainingCalculatorEnv', selectedEnvironment);
        localStorage.setItem('trainingCalculatorEnvExpiry', expiryDate.getTime());
      }
      
      // 환경 적용
      applyEnvironment(selectedEnvironment);
      updateEnvironmentIcon(selectedEnvironment);
      
      // 모달 닫기
      document.getElementById('envModal').classList.remove('active');
      
      // 모바일/데스크톱 버전 리다이렉트
      if (selectedEnvironment === 'mobile' && window.innerWidth > 768) {
        // 데스크톱에서 모바일 버전 보기
        window.location.href = 'training-calculator-mobile.html';
      } else if (selectedEnvironment === 'desktop' && window.innerWidth <= 768) {
        // 모바일에서 데스크톱 버전 보기
        document.body.classList.add('force-desktop');
      }
    }
    
    // 환경 적용
    function applyEnvironment(env) {
      if (env === 'mobile') {
        document.body.classList.add('mobile-env');
        document.body.classList.remove('desktop-env');
      } else {
        document.body.classList.add('desktop-env');
        document.body.classList.remove('mobile-env');
      }
    }
    
    // 환경 아이콘 업데이트
    function updateEnvironmentIcon(env) {
      const mobileIcon = document.getElementById('envIconMobile');
      const desktopIcon = document.getElementById('envIconDesktop');
      
      if (env === 'mobile') {
        if (mobileIcon) mobileIcon.style.display = 'inline';
        if (desktopIcon) desktopIcon.style.display = 'none';
      } else {
        if (mobileIcon) mobileIcon.style.display = 'none';
        if (desktopIcon) desktopIcon.style.display = 'inline';
      }
    }
    
    // User profile
    let userProfile = {
      gender: null,
      ageGroup: null,
      experience: null,
      weeklyVolume: null,
      frequency: null,
      trainingPhase: null,
      conditions: {},
      vdot: 0,
      adjustments: {
        pace: 1.0,
        volume: 1.0,
        intensity: 1.0
      }
    };

    // User adjustments for emoji-based condition
    let userAdjustments = {
      condition: 0,     // -20 to +10
      purpose: 'base',  // base, recovery, speed, race
      specials: []      // Array of special conditions
    };

    function selectGender(gender) {
      userProfile.gender = gender;
      
      // Update UI
      document.getElementById('btn-male').classList.remove('border-purple-500', 'bg-purple-50');
      document.getElementById('btn-female').classList.remove('border-purple-500', 'bg-purple-50');
      
      if (gender === 'male') {
        document.getElementById('btn-male').classList.add('border-purple-500', 'bg-purple-50');
      } else {
        document.getElementById('btn-female').classList.add('border-purple-500', 'bg-purple-50');
      }
    }

    // Exact Daniels-Gilbert VDOT Calculation Formula
    function calculateExactVDOT(distanceMeters, timeSeconds) {
      // Convert to minutes for the formula
      const velocity = distanceMeters / (timeSeconds / 60); // meters per minute
      const time = timeSeconds / 60; // time in minutes
      
      // Daniels-Gilbert oxygen cost formula
      // VO2 = -4.60 + 0.182258 × velocity + 0.000104 × velocity²
      const vo2 = -4.60 + 0.182258 * velocity + 0.000104 * Math.pow(velocity, 2);
      
      // Percent of VO2max formula
      // %VO2max = 0.8 + 0.1894393 × e^(-0.012778×time) + 0.2989558 × e^(-0.1932605×time)
      const percentVO2max = 0.8 + 0.1894393 * Math.exp(-0.012778 * time) + 
                            0.2989558 * Math.exp(-0.1932605 * time);
      
      // VDOT = VO2 / %VO2max
      const vdot = vo2 / percentVO2max;
      
      // Ensure VDOT is within reasonable bounds (20-90)
      return Math.max(20, Math.min(90, vdot));
    }

    // Calculate time for a given VDOT and distance (inverse of VDOT calculation)
    function calculateTimeFromVDOT(vdot, distanceMeters) {
      // Binary search for the time that produces the target VDOT
      let minTime = distanceMeters / 400; // Fastest possible: 400 m/min
      let maxTime = distanceMeters / 50;  // Slowest reasonable: 50 m/min
      
      for (let i = 0; i < 50; i++) { // 50 iterations for precision
        const midTime = (minTime + maxTime) / 2;
        const calculatedVDOT = calculateExactVDOT(distanceMeters, midTime * 60);
        
        if (Math.abs(calculatedVDOT - vdot) < 0.01) {
          return midTime * 60; // Return in seconds
        }
        
        if (calculatedVDOT < vdot) {
          maxTime = midTime;
        } else {
          minTime = midTime;
        }
      }
      
      return ((minTime + maxTime) / 2) * 60; // Return in seconds
    }

    // Calculate training paces based on exact VDOT formula with ranges
    function calculateTrainingPaces(vdot) {
      // Training zone ranges based on Jack Daniels' original formula
      // Using ranges instead of single values for flexibility
      const zones = {
        easy: { 
          minPercent: 0.59, 
          maxPercent: 0.74,
          rpe: '3-4/10',
          description: '대화 가능한 편안한 속도'
        },
        marathon: { 
          minPercent: 0.75, 
          maxPercent: 0.84,
          targetPercent: 0.79,
          rpe: '5-6/10',
          description: '2-4시간 유지 가능'
        },
        threshold: { 
          minPercent: 0.83, 
          maxPercent: 0.88,
          targetPercent: 0.86,
          rpe: '7-8/10',
          description: '편안하게 힘든 정도'
        },
        interval: { 
          minPercent: 0.95, 
          maxPercent: 1.00,
          targetPercent: 0.98,
          rpe: '9/10',
          description: '매우 힘듦, 3-8분 반복'
        },
        repetition: { 
          minPercent: 1.05, 
          maxPercent: 1.10,
          targetPercent: 1.08,
          rpe: '10/10',
          description: '최대 노력, 완전 회복 필수'
        }
      };
      
      // Calculate vVDOT (velocity at VO2max) from VDOT
      // vVDOT is the speed you can maintain for about 11 minutes
      // For a VDOT of X, we need to find the velocity that produces that VDOT at ~11 minutes
      const vVDOT = calculateVVDOT(vdot); // meters per minute
      
      // Convert to pace ranges (seconds per km)
      const paces = {
        easy: {
          min: Math.round((1000 / (vVDOT * zones.easy.maxPercent)) * 60),
          max: Math.round((1000 / (vVDOT * zones.easy.minPercent)) * 60),
          rpe: zones.easy.rpe,
          description: zones.easy.description
        },
        marathon: {
          min: Math.round((1000 / (vVDOT * zones.marathon.maxPercent)) * 60),
          max: Math.round((1000 / (vVDOT * zones.marathon.minPercent)) * 60),
          target: Math.round((1000 / (vVDOT * zones.marathon.targetPercent)) * 60),
          rpe: zones.marathon.rpe,
          description: zones.marathon.description
        },
        threshold: {
          min: Math.round((1000 / (vVDOT * zones.threshold.maxPercent)) * 60),
          max: Math.round((1000 / (vVDOT * zones.threshold.minPercent)) * 60),
          target: Math.round((1000 / (vVDOT * zones.threshold.targetPercent)) * 60),
          rpe: zones.threshold.rpe,
          description: zones.threshold.description
        },
        interval: {
          min: Math.round((1000 / (vVDOT * zones.interval.maxPercent)) * 60),
          max: Math.round((1000 / (vVDOT * zones.interval.minPercent)) * 60),
          target: Math.round((1000 / (vVDOT * zones.interval.targetPercent)) * 60),
          rpe: zones.interval.rpe,
          description: zones.interval.description
        },
        repetition: {
          min: Math.round((1000 / (vVDOT * zones.repetition.maxPercent)) * 60),
          max: Math.round((1000 / (vVDOT * zones.repetition.minPercent)) * 60),
          target: Math.round((1000 / (vVDOT * zones.repetition.targetPercent)) * 60),
          rpe: zones.repetition.rpe,
          description: zones.repetition.description
        }
      };
      
      // Apply condition adjustments to all pace ranges
      const adj = userProfile.adjustments.pace;
      if (adj !== 1.0) {
        Object.keys(paces).forEach(key => {
          if (paces[key].min !== undefined) {
            paces[key].min = Math.round(paces[key].min * adj);
            paces[key].max = Math.round(paces[key].max * adj);
            if (paces[key].target !== undefined) {
              paces[key].target = Math.round(paces[key].target * adj);
            }
          }
        });
      }
      
      return paces;
    }
    
    // Calculate vVDOT (velocity at VO2max) from VDOT
    function calculateVVDOT(vdot) {
      // vVDOT is approximately the speed you can maintain at 100% VO2max
      // This occurs at approximately 11 minutes of running
      // We'll use the inverse formula to find this velocity
      
      // Binary search for velocity that produces the target VDOT at ~11 minutes
      const targetTime = 11; // minutes
      let minVel = 100; // m/min
      let maxVel = 400; // m/min
      
      for (let i = 0; i < 50; i++) {
        const midVel = (minVel + maxVel) / 2;
        
        // Calculate VO2 at this velocity
        const vo2 = -4.60 + 0.182258 * midVel + 0.000104 * Math.pow(midVel, 2);
        
        // At 11 minutes, %VO2max should be approximately 100%
        const percentVO2max = 0.8 + 0.1894393 * Math.exp(-0.012778 * targetTime) + 
                              0.2989558 * Math.exp(-0.1932605 * targetTime);
        
        const calculatedVDOT = vo2 / percentVO2max;
        
        if (Math.abs(calculatedVDOT - vdot) < 0.01) {
          return midVel;
        }
        
        if (calculatedVDOT < vdot) {
          minVel = midVel;
        } else {
          maxVel = midVel;
        }
      }
      
      return (minVel + maxVel) / 2;
    }

    function formatPace(secondsPerKm) {
      const minutes = Math.floor(secondsPerKm / 60);
      const seconds = Math.floor(secondsPerKm % 60);
      return `${minutes}:${seconds.toString().padStart(2, '0')}/km`;
    }

    function getPerformanceLevel(vdot) {
      if (vdot >= 75) return "엘리트";
      if (vdot >= 65) return "준엘리트";
      if (vdot >= 55) return "상급자";
      if (vdot >= 45) return "중급자";
      if (vdot >= 35) return "초급자";
      return "입문자";
    }

    function calculateAdjustments() {
      // Initialize factor arrays for weighted average calculation
      const paceFactors = [];
      const volumeFactors = [];
      const intensityFactors = [];
      
      // 1. Age group adjustments
      switch(userProfile.ageGroup) {
        case 'junior':
          volumeFactors.push(0.8);
          intensityFactors.push(0.9);
          break;
        case 'master40':
          paceFactors.push(1.02);
          volumeFactors.push(0.95);
          break;
        case 'master50':
          paceFactors.push(1.05);
          volumeFactors.push(0.9);
          break;
        case 'master60':
          paceFactors.push(1.08);
          volumeFactors.push(0.85);
          intensityFactors.push(0.9);
          break;
      }
      
      // 2. Experience level adjustments
      switch(userProfile.experience) {
        case 'beginner':
          volumeFactors.push(0.7);
          intensityFactors.push(0.85);
          break;
        case 'advanced':
          volumeFactors.push(1.05);
          break;
        case 'elite':
          volumeFactors.push(1.08);
          break;
      }
      
      // 3. Training frequency adjustments
      switch(userProfile.frequency) {
        case '3-4':
          volumeFactors.push(0.9);
          intensityFactors.push(0.95);
          break;
        case '5-6':
          volumeFactors.push(1.02);
          break;
        case '7':
          volumeFactors.push(1.05);
          break;
        case 'double':
          volumeFactors.push(1.08);
          intensityFactors.push(1.02);
          break;
      }
      
      // 4. Training phase adjustments
      switch(userProfile.trainingPhase) {
        case 'base':
          volumeFactors.push(1.05);
          intensityFactors.push(0.9);
          break;
        case 'peak':
          volumeFactors.push(0.95);
          intensityFactors.push(1.05);
          break;
        case 'taper':
          volumeFactors.push(0.6);
          break;
        case 'recovery':
          volumeFactors.push(0.7);
          intensityFactors.push(0.8);
          break;
      }
      
      // 5. User condition adjustments
      if (userAdjustments.condition !== 0) {
        const conditionFactor = 1 + (userAdjustments.condition / 100);
        paceFactors.push(1 / conditionFactor);
        volumeFactors.push(conditionFactor);
        intensityFactors.push(conditionFactor);
      }
      
      // 6. Training purpose adjustments
      switch(userAdjustments.purpose) {
        case 'recovery':
          paceFactors.push(1.15);
          volumeFactors.push(0.8);
          intensityFactors.push(0.7);
          break;
        case 'speed':
          paceFactors.push(0.95);
          volumeFactors.push(0.9);
          intensityFactors.push(1.2);
          break;
        case 'race':
          paceFactors.push(0.97);
          volumeFactors.push(0.85);
          intensityFactors.push(1.1);
          break;
      }
      
      // 7. Special conditions
      if (document.getElementById('injury_recovery').checked) {
        paceFactors.push(1.1);
        volumeFactors.push(0.6);
        intensityFactors.push(0.7);
      }
      
      if (document.getElementById('high_fatigue').checked) {
        paceFactors.push(1.08);
        volumeFactors.push(0.8);
        intensityFactors.push(0.8);
      }
      
      if (document.getElementById('altitude').checked) {
        paceFactors.push(1.03);
      }
      
      // Environmental conditions
      const environment = document.getElementById('environment').value;
      switch(environment) {
        case 'cold':
          paceFactors.push(1.02); // Slightly slower in cold
          break;
        case 'hot':
          paceFactors.push(1.04); // Slower in heat
          break;
        case 'humid':
          paceFactors.push(1.06); // Much slower in hot and humid
          intensityFactors.push(0.9); // Reduce intensity
          break;
      }
      
      if (document.getElementById('weight_loss').checked) {
        volumeFactors.push(1.1);
        intensityFactors.push(0.85);
      }
      
      // 8. Calculate weighted averages
      const adjustments = {
        pace: calculateWeightedAverage(paceFactors),
        volume: calculateWeightedAverage(volumeFactors),
        intensity: calculateWeightedAverage(intensityFactors)
      };
      
      // 9. Apply safety limits
      adjustments.pace = Math.min(Math.max(adjustments.pace, 0.90), 1.15);
      adjustments.volume = Math.min(Math.max(adjustments.volume, 0.60), 1.20);
      adjustments.intensity = Math.min(Math.max(adjustments.intensity, 0.70), 1.15);
      
      userProfile.adjustments = adjustments;
      return adjustments;
    }
    
    // 가중 평균 계산 함수
    function calculateWeightedAverage(factors) {
      if (factors.length === 0) return 1.0;
      if (factors.length === 1) return factors[0];
      
      // 첫 번째 요소 100%, 두 번째 50%, 세 번째 이후 25%
      const weights = [1.0, 0.5, 0.25, 0.25, 0.25];
      let sum = 0;
      let weightSum = 0;
      
      factors.forEach((factor, i) => {
        const weight = weights[Math.min(i, weights.length - 1)];
        sum += factor * weight;
        weightSum += weight;
      });
      
      return sum / weightSum;
    }

    // 이모지 컨디션 설정
    function setCondition(value) {
      document.querySelectorAll('.condition-btn').forEach(btn => {
        btn.classList.remove('border-purple-500', 'bg-purple-50', 'border-red-500', 'bg-red-50', 
                              'border-orange-500', 'bg-orange-50', 'border-green-500', 'bg-green-50');
      });
      
      const btn = document.querySelector(`.condition-btn[data-value="${value}"]`);
      if (btn) {
        btn.classList.add('border-purple-500', 'bg-purple-50');
      }
      
      const conditionMap = {
        'very-bad': -20,
        'bad': -10,
        'normal': 0,
        'good': 5,
        'excellent': 10
      };
      userAdjustments.condition = conditionMap[value] || 0;
    }

    // 훈련 목적 설정
    function setPurpose(value) {
      document.querySelectorAll('.purpose-btn').forEach(btn => {
        btn.classList.remove('border-purple-500', 'bg-purple-50');
      });
      
      const btn = document.querySelector(`.purpose-btn[data-value="${value}"]`);
      if (btn) {
        btn.classList.add('border-purple-500', 'bg-purple-50');
      }
      
      userAdjustments.purpose = value;
    }

    // 특별 상황 토글
    function toggleSpecial(type) {
      const index = userAdjustments.specials.indexOf(type);
      if (index > -1) {
        userAdjustments.specials.splice(index, 1);
      } else {
        userAdjustments.specials.push(type);
      }
    }

    // 9-10일 주기화 엔진
    class NonaryPeriodizationEngine {
      constructor() {
        this.cycleData = {
          9: {
            name: "9일 주기 (고강도 중심)",
            phases: ["적응", "고강도", "회복", "초고강도", "활성회복", "점진강화", "최대강도", "회복적응", "준비"],
            intensityRatios: [0.6, 0.8, 0.4, 0.9, 0.3, 0.7, 1.0, 0.5, 0.6],
            volumeRatios: [0.8, 0.6, 0.3, 0.5, 0.2, 0.7, 0.4, 0.3, 0.8]
          },
          10: {
            name: "10일 주기 (지구력 중싐)", 
            phases: ["기초", "용량증가", "강도상승", "회복1", "점진증가", "최대용량", "회복2", "강도점진", "최대강도", "적응회복"],
            intensityRatios: [0.5, 0.7, 0.8, 0.3, 0.6, 0.9, 0.4, 0.7, 0.95, 0.5],
            volumeRatios: [0.9, 0.8, 0.7, 0.2, 0.8, 0.6, 0.3, 0.7, 0.5, 0.4]
          }
        };
        
        this.dualSessionTemplates = {
          morning: {
            0: { type: 'technique_drill', focus: '기술·자세', energy: '신경계 활성화' },
            1: { type: 'high_intensity', focus: '고강도 인터벌', energy: '무산소 시스템' },
            2: { type: 'recovery_run', focus: '회복·순환', energy: '유산소 회복' },
            3: { type: 'maximal_effort', focus: '최대 노력', energy: '신경계 최대' },
            4: { type: 'active_recovery', focus: '활동 회복', energy: '저강도 활성' },
            5: { type: 'tempo_run', focus: '임계 훈련', energy: '젖산역치' },
            6: { type: 'sprint_training', focus: '스프린트', energy: '신경계 고속' },
            7: { type: 'recovery_jog', focus: '가벼운 회복', energy: '저강도 회복' },
            8: { type: 'preparation', focus: '준비·점검', energy: '기술 점검' }
          },
          afternoon: {
            0: { type: 'easy_run', focus: '기초 유산소', energy: '지구력 기반' },
            1: { type: 'technique_focus', focus: '기술 정화', energy: '정확성 향상' },
            2: { type: 'flexibility_balance', focus: '유연성·균형', energy: '재활·예방' },
            3: { type: 'recovery_mobility', focus: '회복·가동성', energy: '근육 이완' },
            4: { type: 'strength_training', focus: '근력 강화', energy: '근섬유 강화' },
            5: { type: 'drill_refinement', focus: '드릴 정제', energy: '기술 완성' },
            6: { type: 'cross_training', focus: '교차 훈련', energy: '부담 분산' },
            7: { type: 'easy_recovery', focus: '쉬운 회복', energy: '순환 촉진' },
            8: { type: 'planning_review', focus: '계획·점검', energy: '정신 회복' }
          }
        };
      }

      generateDualSessionPlan(athleteProfile) {
        const cycleType = this.determineCycleType(athleteProfile);
        const basePlan = this.cycleData[cycleType];
        const enhancedPlan = this.enhanceWithDualSessions(basePlan, athleteProfile);
        
        return {
          cycleLength: cycleType,
          phases: enhancedPlan.sessions,
          progression: this.calculateProgression(athleteProfile),
          recoveryMetrics: enhancedPlan.recoveryProtocol,
          nutritionTiming: enhancedPlan.nutritionTiming,
          sleepOptimization: enhancedPlan.sleepOptimization
        };
      }

      determineCycleType(profile) {
        if (profile.eventDistance <= 1500 && profile.trainingHistory > 3) return 9;
        if (profile.eventDistance >= 10000) return 10;
        return profile.vdot > 50 ? 9 : 10;
      }

      enhanceWithDualSessions(basePlan, profile) {
        const sessions = [];
        const cycleLength = basePlan.name.includes('9') ? 9 : 10;
        
        for (let dayIndex = 0; dayIndex < cycleLength; dayIndex++) {
          const morningSession = this.designMorningSession(dayIndex, profile, cycleLength);
          const afternoonSession = this.designAfternoonSession(dayIndex, profile, morningSession, cycleLength);
          
          sessions.push({
            day: dayIndex + 1,
            phase: basePlan.phases[dayIndex],
            morning: morningSession,
            afternoon: afternoonSession,
            dailyLoad: this.calculateDailyLoad(morningSession, afternoonSession),
            interSessionRecovery: this.calculateInterSessionRecovery(morningSession, afternoonSession),
            dailyNutrition: this.calculateDailyNutrition(morningSession, afternoonSession)
          });
        }
        
        return { 
          sessions,
          recoveryProtocol: this.generateRecoveryProtocol(sessions),
          nutritionTiming: this.generateNutritionTiming(sessions),
          sleepOptimization: this.generateSleepOptimization(sessions)
        };
      }

      designMorningSession(dayIndex, profile, cycleLength) {
        const template = this.dualSessionTemplates.morning[dayIndex % 9];
        const sessionLength = this.calculateOptimalSessionLength(profile, 'morning');
        
        return {
          type: 'morning',
          startTime: this.calculateOptimalStartTime(profile, 'morning'),
          duration: sessionLength,
          sessionType: template.type,
          focus: template.focus,
          energySystem: template.energy,
          targetIntensity: this.calculateMorningIntensity(dayIndex, cycleLength),
          heartRateZones: this.calculateMorningHRZones(profile, dayIndex),
            keyExercises: this.selectMorningExercises(dayIndex),
            recoveryMetrics: {
              immediate: this.calculateImmediateRecoveryNeeds('morning', sessionLength),
              nextSession: this.calculateNextSessionReadiness(sessionLength)
            }
          };
        }

        designAfternoonSession(dayIndex, profile, morningSession, cycleLength) {
          const recoveryTime = this.calculateRecoveryTime(morningSession);
          const template = this.dualSessionTemplates.afternoon[dayIndex % 9];
          const sessionLength = this.calculateOptimalSessionLength(profile, 'afternoon');
          
          return {
            type: 'afternoon',
            startTime: this.calculateOptimalStartTime(profile, 'afternoon', recoveryTime),
            duration: sessionLength,
            sessionType: template.type,
            focus: template.focus,
            energySystem: template.energy,
            targetIntensity: this.calculateAfternoonIntensity(dayIndex, cycleLength, morningSession),
            heartRateZones: this.calculateAfternoonHRZones(profile, dayIndex, morningSession),
            keyExercises: this.selectAfternoonExercises(dayIndex, morningSession),
            recoveryMetrics: {
              daily: this.calculateDailyRecovery(morningSession, sessionLength),
              overnight: this.calculateOvernightRecoveryNeeds(dayIndex)
            }
          };
        }

        calculateMorningIntensity(dayIndex, cycleLength) {
          const patterns = {
            9: [0.6, 0.8, 0.4, 0.9, 0.3, 0.7, 1.0, 0.5, 0.6],
            10: [0.5, 0.7, 0.8, 0.3, 0.6, 0.9, 0.4, 0.7, 0.95, 0.5]
          };
          return patterns[cycleLength][dayIndex];
        }

        calculateAfternoonIntensity(dayIndex, cycleLength, morningSession) {
          const morningIntensity = morningSession.targetIntensity;
          const baseIntensity = this.calculateMorningIntensity(dayIndex, cycleLength);
          
          // 오후 세션은 오전 세션과 상호보완적으로 설계
          if (morningIntensity > 0.7) {
            return Math.max(baseIntensity * 0.6, 0.3); // 오전이 고강도면 오후는 저강도
          } else {
            return Math.min(baseIntensity * 1.2, 0.8); // 오전이 저강도면 오후는 중강도
          }
        }

        calculateInterSessionRecovery(morningSession, afternoonSession) {
          const morningStress = morningSession.targetIntensity * (morningSession.duration / 120);
          const afternoonPreparedness = (1 - afternoonSession.targetIntensity) * (afternoonSession.duration / 120);
          
          return {
            recoveryPercentage: Math.round((afternoonPreparedness / morningStress) * 100),
            recommendedActivities: this.getRecoveryActivities(morningStress),
            nutritionTiming: this.getInterSessionNutritionTiming(morningSession, afternoonSession),
            hydrationProtocol: this.getHydrationProtocol(morningSession.duration)
          };
        }

        getRecoveryActivities(stressLevel) {
          if (stressLevel > 0.8) {
            return ['수영 20분', '요가 15분', '마사지', '스트레칭 10분'];
          } else if (stressLevel > 0.5) {
            return ['가벼운 산책', '스트레칭', '명상'];
          } else {
            return ['일상 활동', '휴식'];
          }
        }

        getInterSessionNutritionTiming(morningSession, afternoonSession) {
          return {
            immediately: '단백질 20g + 탄수화물 40g (회복 음료)',
            after1Hour: '균형잡힌 식사 (탄수화물 60%, 단백질 25%, 지방 15%)',
            beforeAfternoon: '가벼운 에너지바 또는 바나나 (30분 전)'
          };
        }

        getHydrationProtocol(morningDuration) {
          const baseWater = morningDuration * 2; // ml per minute
          const electrolyteNeed = morningDuration > 90 ? '필요' : '선택적';
          
          return {
            totalWater: baseWater + 'ml',
            electrolyte: electrolyteNeed,
            timing: '훈련 중 150ml씩, 훈련 후 즉시 300ml'
          };
        }

        calculateDailyNutrition(morningSession, afternoonSession) {
          const morningEnergy = this.calculateEnergyExpenditure(morningSession);
          const afternoonEnergy = this.calculateEnergyExpenditure(afternoonSession);
          const totalEnergy = morningEnergy + afternoonEnergy;
          
          return {
            totalCalories: Math.round(totalEnergy),
            carbohydrateNeeds: Math.round(totalEnergy * 0.6 / 4),
            proteinNeeds: Math.round(totalEnergy * 0.15 / 4),
            fatNeeds: Math.round(totalEnergy * 0.25 / 9),
            timingProtocol: this.getInterSessionNutritionTiming(morningSession, afternoonSession),
            hydrationNeeds: this.getHydrationProtocol(morningSession.duration)
          };
        }

        calculateEnergyExpenditure(session) {
          const metValues = {
            'technique_drill': 4.5,
            'high_intensity': 11.0,
            'recovery_run': 6.0,
            'maximal_effort': 14.0,
            'active_recovery': 3.5,
            'tempo_run': 8.5,
            'sprint_training': 9.5,
            'recovery_jog': 5.0,
            'preparation': 3.0,
            'easy_run': 6.5,
            'technique_focus': 4.0,
            'flexibility_balance': 3.0,
            'recovery_mobility': 2.5,
            'strength_training': 6.0,
            'drill_refinement': 4.5,
            'cross_training': 5.5,
            'easy_recovery': 5.0,
            'planning_review': 2.0
          };
          
          const met = metValues[session.sessionType] || 5.0;
          const durationHours = session.duration / 60;
          const bodyWeight = 70;
          
          return met * bodyWeight * durationHours * 60;
        }

        calculateImmediateRecoveryNeeds(sessionType, duration) {
          const intensityFactors = {
            'technique_drill': 0.3,
            'high_intensity': 0.9,
            'recovery_run': 0.2,
            'maximal_effort': 1.0,
            'active_recovery': 0.1,
            'tempo_run': 0.7,
            'sprint_training': 0.8,
            'recovery_jog': 0.15
          };
          
          const factor = intensityFactors[sessionType] || 0.5;
          return Math.round(factor * duration / 10);
        }

        calculateNextSessionReadiness(duration) {
          const baseReadiness = 0.8;
          const durationFactor = Math.max(0.6, 1 - (duration - 45) / 100);
          return Math.round(baseReadiness * durationFactor * 100) / 100;
        }

        calculateDailyRecovery(morningSession, afternoonDuration) {
          const morningStress = morningSession.targetIntensity * (morningSession.duration / 60);
          const afternoonStress = 0.5 * (afternoonDuration / 60);
          const totalStress = morningStress + afternoonStress;
          
          return {
            recoveryTime: Math.round(totalStress * 60) + '분',
            sleepNeed: Math.round(totalStress * 2) + '시간',
            nutritionPriority: totalStress > 1.5 ? '높음' : '보통'
          };
        }

        calculateOvernightRecoveryNeeds(dayIndex) {
          const baseRecovery = 8;
          const dayFactor = dayIndex % 3 === 2 ? 1.2 : 1.0;
          return Math.round(baseRecovery * dayFactor);
        }

        generateRecoveryProtocol(sessions) {
          return {
            dailyMonitoring: ['아침 기상 시 심박수', '주관적 피로도(1-10)', '수면 질 평가'],
            weeklyAssessments: ['HRV 측정', '점프 테스트', '혈중 젖산 측정'],
            recoveryTools: ['마사지 볼', '폼 롤러', '가습기', '블루라이트 차단'],
            nutritionTiming: ['훈련 전 30분', '훈련 중 15분마다', '훈련 후 즉시', '취침 전 2시간']
          };
        }

        generateNutritionTiming(sessions) {
          return {
            preWorkout: '탄수화물 중심 + 소량의 단백질 (30분 전)',
            duringWorkout: '전해질 음료 150ml씩 (15분마다)',
            postWorkout: '단백질 20g + 탄수화물 40g (즉시)',
            betweenSessions: '가벼운 에너지바 또는 바나나',
            dailySupplements: ['오메가-3', '비타민D', '마그네슘', '아연']
          };
        }

        generateSleepOptimization(sessions) {
          return {
            optimalTime: '22:30-23:00',
            duration: '7-9시간',
            environment: '18-20°C, 어둡고 조용한 환경',
            routine: ['취침 1시간 전 전자기기 끄기', '가벼운 스트레칭', '명상 5분', '규칙적인 일정 유지']
          };
        }

        calculateMorningHRZones(profile, dayIndex) {
          // Calculate heart rate zones for morning sessions
          const maxHR = 220 - profile.age;
          const restingHR = 60;
          const hrr = maxHR - restingHR;
          
          return {
            zone1: Math.round(restingHR + hrr * 0.5),
            zone2: Math.round(restingHR + hrr * 0.6),
            zone3: Math.round(restingHR + hrr * 0.7),
            zone4: Math.round(restingHR + hrr * 0.8),
            zone5: Math.round(restingHR + hrr * 0.9)
          };
        }

        calculateAfternoonHRZones(profile, dayIndex, morningSession) {
          // Adjust afternoon HR zones based on morning session
          const morningZones = this.calculateMorningHRZones(profile, dayIndex);
          const morningIntensity = morningSession.targetIntensity;
          
          // Reduce zones by 10-20% based on morning intensity
          const reductionFactor = 1 - (morningIntensity * 0.2);
          
          return {
            zone1: Math.round(morningZones.zone1 * reductionFactor),
            zone2: Math.round(morningZones.zone2 * reductionFactor),
            zone3: Math.round(morningZones.zone3 * reductionFactor),
            zone4: Math.round(morningZones.zone4 * reductionFactor),
            zone5: Math.round(morningZones.zone5 * reductionFactor)
          };
        }

        selectMorningExercises(dayIndex) {
          const exercises = {
            0: ['드릴 15분', '가속기술 10분', '폼 체크'],
            1: ['인터벌 400m x 6', '회복조깅', '스트레칭'],
            2: ['쉬운 조깅 20분', '요가 스트레칭', '명상'],
            3: ['200m 스프린트 x 8', '완전회복', '기술점검'],
            4: ['워킹 15분', '가벼운 스트레칭', '휴식'],
            5: ['임계페이스 20분', '워밍업/쿨다운', '코어운동'],
            6: ['100m 스프린트 x 12', '기술드릴', '폼분석'],
            7: ['쉬운 조깅 15분', '부위별 스트레칭', '마사지'],
            8: ['기술드릴 20분', '점프연습', '계획수립']
          };
          return exercises[dayIndex % 9] || exercises[0];
        }

        selectAfternoonExercises(dayIndex, morningSession) {
          const baseExercises = {
            0: ['기초유산소 30분', '테크닉 연마', '자세교정'],
            1: ['기술정화 25분', '코어강화', '유연성'],
            2: ['유연성 20분', '균형운동', '재활'],
            3: ['회복가동성 15분', '이완운동', '마사지'],
            4: ['근력운동 40분', '코어안정성', '스트레칭'],
            5: ['드릴정제 30분', '페이스감각', '순발력'],
            6: ['교차훈련 35분', '심폐지구력', '다양성'],
            7: ['쉬운회복 20분', '순환촉진', '이완'],
            8: ['계획수립 15분', '성찰', '준비']
          };
          
          // Adjust based on morning session intensity
          const morningIntensity = morningSession.targetIntensity;
          const adjustedExercises = [...baseExercises[dayIndex % 9]];
          
          if (morningIntensity > 0.7) {
            adjustedExercises.push('추가회복');
          }
          
          return adjustedExercises;
        }

        calculateProgression(athleteProfile) {
          // Calculate progression over the cycle
          return {
            week1: { intensity: 0.6, volume: 0.8 },
            week2: { intensity: 0.75, volume: 0.9 },
            week3: { intensity: 0.85, volume: 1.0 },
            week4: { intensity: 0.5, volume: 0.6 }
          };
        }

        calculateDailyLoad(morningSession, afternoonSession) {
          const morningLoad = morningSession.targetIntensity * (morningSession.duration / 60);
          const afternoonLoad = afternoonSession.targetIntensity * (afternoonSession.duration / 60) * 0.8;
          return Math.round((morningLoad + afternoonLoad) * 10) / 10;
        }

        calculateInterSessionRecovery(morningSession, afternoonSession) {
          const recoveryTime = this.calculateRecoveryTime(morningSession);
          const readiness = this.calculateNextSessionReadiness(morningSession.duration);
          
          return {
            recoveryPercentage: Math.round(readiness * 100),
            recommendedActivities: this.getRecoveryActivities(morningSession.targetIntensity),
            nutritionTiming: this.getInterSessionNutritionTiming(morningSession, afternoonSession),
            hydrationProtocol: this.getHydrationProtocol(morningSession.duration)
          };
        }

        getRecoveryActivities(intensity) {
          if (intensity > 0.7) {
            return ['수영 20분', '요가 15분', '마사지', '스트레칭 10분'];
          } else if (intensity > 0.5) {
            return ['가벼운 산책', '스트레칭', '명상'];
          } else {
            return ['일상 활동', '휴식'];
          }
        }

        getInterSessionNutritionTiming(morningSession, afternoonSession) {
          return {
            immediately: '단백질 20g + 탄수화물 40g (회복 음료)',
            after1Hour: '균형잡힌 식사 (탄수화물 60%, 단백질 25%, 지방 15%)',
            beforeAfternoon: '가벼운 에너지바 또는 바나나 (30분 전)'
          };
        }

        getRecoveryProtocol(sessions) {
          return {
            dailyMonitoring: ['아침 기상 시 심박수', '주관적 피로도(1-10)', '수면 질 평가'],
            weeklyAssessments: ['HRV 측정', '점프 테스트', '혈중 젖산 측정'],
            recoveryTools: ['마사지 볼', '폼 롤러', '가습기', '블루라이트 차단'],
            nutritionTiming: ['훈련 전 30분', '훈련 중 15분마다', '훈련 후 즉시', '취침 전 2시간']
          };
        }

        generateNutritionTiming(sessions) {
          return {
            preWorkout: '탄수화물 중심 + 소량의 단백질 (30분 전)',
            duringWorkout: '전해질 음료 150ml씩 (15분마다)',
            postWorkout: '단백질 20g + 탄수화물 40g (즉시)',
            betweenSessions: '가벼운 에너지바 또는 바나나',
            dailySupplements: ['오메가-3', '비타민D', '마그네슘', '아연']
          };
        }

        generateSleepOptimization(sessions) {
          return {
            optimalTime: '22:30-23:00',
            duration: '7-9시간',
            environment: '18-20°C, 어둡고 조용한 환경',
            routine: ['취침 1시간 전 전자기기 끄기', '가벼운 스트레칭', '명상 5분', '규칙적인 일정 유지']
          };
        }

        calculateImmediateRecoveryNeeds(sessionType, duration) {
          // 즉시 회복 필요성 계산
          const intensityFactors = {
            'technique_drill': 0.3,
            'high_intensity': 0.9,
            'recovery_run': 0.2,
            'maximal_effort': 1.0,
            'active_recovery': 0.1,
            'tempo_run': 0.7,
            'sprint_training': 0.8,
            'recovery_jog': 0.15
          };
          
          const factor = intensityFactors[sessionType] || 0.5;
          return Math.round(factor * duration / 10);
        }

        calculateNextSessionReadiness(duration) {
          // 다음 세션 준비도 계산
          const baseReadiness = 0.8;
          const durationFactor = Math.max(0.6, 1 - (duration - 45) / 100);
          return Math.round(baseReadiness * durationFactor * 100) / 100;
        }

        calculateDailyRecovery(morningSession, afternoonDuration) {
          // 일일 회복 계산
          const morningStress = morningSession.targetIntensity * (morningSession.duration / 60);
          const afternoonStress = 0.5 * (afternoonDuration / 60); // 오후는 일반적으로 낮은 강도
          const totalStress = morningStress + afternoonStress;
          
          return {
            recoveryTime: Math.round(totalStress * 60) + '분',
            sleepNeed: Math.round(totalStress * 2) + '시간',
            nutritionPriority: totalStress > 1.5 ? '높음' : '보통'
          };
        }

        calculateOvernightRecoveryNeeds(dayIndex) {
          // 야간 회복 필요성 계산
          const baseRecovery = 8; // 기본 8시간
          const dayFactor = dayIndex % 3 === 2 ? 1.2 : 1.0; // 고강도 후 더 많은 회복
          return Math.round(baseRecovery * dayFactor);
        }

        generateRecoveryProtocol(sessions) {
          return {
            dailyMonitoring: ['아침 기상 시 심박수', '주관적 피로도(1-10)', '수면 질 평가'],
            weeklyAssessments: ['HRV 측정', '점프 테스트', '혈중 젖산 측정'],
            recoveryTools: ['마사지 볼', '폼 롤러', '가습기', '블루라이트 차단'],
            nutritionTiming: ['훈련 전 30분', '훈련 중 15분마다', '훈련 후 즉시', '취침 전 2시간']
          };
        }

        generateNutritionTiming(sessions) {
          return {
            preWorkout: '탄수화물 중심 + 소량의 단백질 (30분 전)',
            duringWorkout: '전해질 음료 150ml씩 (15분마다)',
            postWorkout: '단백질 20g + 탄수화물 40g (즉시)',
            betweenSessions: '가벼운 에너지바 또는 바나나',
            dailySupplements: ['오메가-3', '비타민D', '마그네슘', '아연']
          };
        }

        generateSleepOptimization(sessions) {
          return {
            optimalTime: '22:30-23:00',
            duration: '7-9시간',
            environment: '18-20°C, 어둡고 조용한 환경',
            routine: ['취침 1시간 전 전자기기 끄기', '가벼운 스트레칭', '명상 5분', '규칙적인 일정 유지']
          };
        }

        generateRecoveryProtocol(sessions) {
          return {
            dailyMonitoring: ['아침 기상 시 심박수', '주관적 피로도(1-10)', '수면 질 평가'],
            weeklyAssessments: ['HRV 측정', '점프 테스트', '혈중 젖산 측정'],
            recoveryTools: ['마사지 볼', '폼 롤러', '가습기', '블루라이트 차단'],
            nutritionTiming: ['훈련 전 30분', '훈련 중 15분마다', '훈련 후 즉시', '취침 전 2시간']
          };
        }

        generateNutritionTiming(sessions) {
          return {
            preWorkout: '탄수화물 중심 + 소량의 단백질 (30분 전)',
            duringWorkout: '전해질 음료 150ml씩 (15분마다)',
            postWorkout: '단백질 20g + 탄수화물 40g (즉시)',
            betweenSessions: '가벼운 에너지바 또는 바나나',
            dailySupplements: ['오메가-3', '비타민D', '마그네슘', '아연']
          };
        }

        generateSleepOptimization(sessions) {
          return {
            optimalTime: '22:30-23:00',
            duration: '7-9시간',
            environment: '18-20°C, 어둡고 조용한 환경',
            routine: ['취침 1시간 전 전자기기 끄기', '가벼운 스트레칭', '명상 5분', '규칙적인 일정 유지']
          };
        }
      }

      // 전역 변수
      let nonaryEngine = new NonaryPeriodizationEngine();
      let currentNonaryPlan = null;

      // Helper functions for NonaryPeriodizationEngine
      function getTrainingHistory() {
        const experience = document.getElementById('experience').value;
        const historyMap = {
          'beginner': 1,
          'intermediate': 2,
          'advanced': 4,
          'elite': 8
        };
        return historyMap[experience] || 2;
      }

      function getAgeFromGroup() {
        const ageGroup = document.getElementById('ageGroup').value;
        const ageMap = {
          'junior': 16,
          'senior': 25,
          'master40': 45,
          'master50': 55,
          'master60': 65
        };
        return ageMap[ageGroup] || 25;
      }

      function getChronotype() {
        // Default chronotype based on training patterns
        return 'intermediate';
      }

      function toggleAdaptiveMode() {
        const adaptiveMode = document.getElementById('adaptiveMode').checked;
        if (adaptiveMode) {
          // Enable real-time monitoring
          startAdaptiveMonitoring();
        } else {
          // Disable adaptive monitoring
          stopAdaptiveMonitoring();
        }
      }

      function startAdaptiveMonitoring() {
        // Simulate real-time monitoring
        console.log('적응형 모니터링 시작');
        // Add monitoring UI elements
        updateMonitoringDisplay();
      }

      function stopAdaptiveMonitoring() {
        console.log('적응형 모니터링 중지');
        // Remove monitoring UI elements
      }

      function updateMonitoringDisplay() {
        const monitoringDiv = document.createElement('div');
        monitoringDiv.id = 'adaptiveMonitoring';
        monitoringDiv.className = 'fixed bottom-4 right-4 bg-green-600 text-white p-4 rounded-lg shadow-lg z-50';
        monitoringDiv.innerHTML = `
          <div class="text-sm font-bold mb-2">실시간 AI 모니터링</div>
          <div class="text-xs">심박수: <span id="heartRate">--</span> bpm</div>
          <div class="text-xs">피로도: <span id="fatigueLevel">--</span>/10</div>
          <div class="text-xs">회복도: <span id="recoveryIndex">--</span>%</div>
        `;
        document.body.appendChild(monitoringDiv);
        
        // Simulate real-time data updates
        setInterval(() => {
          document.getElementById('heartRate').textContent = Math.floor(Math.random() * 20 + 140);
          document.getElementById('fatigueLevel').textContent = Math.floor(Math.random() * 3 + 3);
          document.getElementById('recoveryIndex').textContent = Math.floor(Math.random() * 20 + 70);
        }, 5000);
      }

      function updateNonaryCycle() {
        if (!currentNonaryPlan) return;
        
        const cycleType = document.getElementById('cycleType').value;
        const sessionFrequency = document.getElementById('sessionFrequency').value;
        const recoveryMode = document.getElementById('recoveryMode').value;
        
        // Regenerate plan with new parameters
        generateNonaryTrainingCycle();
      }

      function generateNonaryTrainingCycle() {
        if (!userProfile.vdot) return;
        
        const athleteProfile = {
          vdot: userProfile.vdot,
          eventDistance: parseInt(document.getElementById('eventDistance').value) || 5000,
          trainingHistory: getTrainingHistory(),
          age: getAgeFromGroup(),
          chronotype: getChronotype()
        };
        
        currentNonaryPlan = nonaryEngine.generateDualSessionPlan(athleteProfile);
        renderNonaryCycle(currentNonaryPlan);
      }

      function renderNonaryCycle(plan) {
        const container = document.getElementById('trainingCycle');
        if (!container) return;
        
        const cycleType = document.getElementById('cycleType').value;
        const sessionFrequency = document.getElementById('sessionFrequency').value;
        
        let html = `
          <div class="mb-4 p-4 bg-purple-100 rounded-lg">
            <h4 class="font-bold text-lg text-purple-800 mb-2">${plan.cycleLength}일 주기 계획</h4>
            <p class="text-sm text-purple-700">과학적 생리학적 적응 주기 기반</p>
          </div>
        `;
        
        plan.phases.forEach((phase, index) => {
          html += renderDualSessionDay(phase, index + 1, sessionFrequency);
        });
        
        container.innerHTML = html;
      }

      function renderDualSessionDay(phase, dayNumber, sessionFrequency) {
        const phaseData = nonaryEngine.cycleData[document.getElementById('cycleType').value];
        const phaseName = phaseData.phases[dayNumber - 1];
        const intensityRatio = phaseData.intensityRatios[dayNumber - 1];
        const volumeRatio = phaseData.volumeRatios[dayNumber - 1];
        
        let html = `
          <div class="phase-card bg-white border-2 border-gray-200 rounded-lg p-4 mb-3">
            <div class="flex justify-between items-start mb-3">
              <div>
                <h4 class="font-bold text-lg">${dayNumber}일차: ${phaseName}</h4>
                <p class="text-sm text-gray-600">강도: ${Math.round(intensityRatio * 100)}%, 용량: ${Math.round(volumeRatio * 100)}%</p>
              </div>
              <div class="text-right">
                <div class="text-xs text-gray-500">일일 부하</div>
                <div class="text-lg font-bold text-purple-600">${Math.round(intensityRatio * volumeRatio * 100)}</div>
              </div>
            </div>
        `;
        
        if (sessionFrequency === 'double') {
          html += `
            <div class="grid md:grid-cols-2 gap-4">
              <div class="bg-blue-50 p-3 rounded-lg">
                <h5 class="font-semibold text-blue-800 mb-2">
                  <i class="fas fa-sun text-yellow-500 mr-2"></i>오전 세션
                </h5>
                <div class="text-sm space-y-1">
                  <div><strong>시간:</strong> ${phase.morning.startTime}</div>
                  <div><strong>지속시간:</strong> ${phase.morning.duration}분</div>
                  <div><strong>집중:</strong> ${phase.morning.focus}</div>
                  <div><strong>강도:</strong> ${Math.round(phase.morning.targetIntensity * 100)}%</div>
                </div>
              </div>
              
              <div class="bg-orange-50 p-3 rounded-lg">
                <h5 class="font-semibold text-orange-800 mb-2">
                  <i class="fas fa-moon text-orange-500 mr-2"></i>오후 세션
                </h5>
                <div class="text-sm space-y-1">
                  <div><strong>시간:</strong> ${phase.afternoon.startTime}</div>
                  <div><strong>지속시간:</strong> ${phase.afternoon.duration}분</div>
                  <div><strong>집중:</strong> ${phase.afternoon.focus}</div>
                  <div><strong>강도:</strong> ${Math.round(phase.afternoon.targetIntensity * 100)}%</div>
                </div>
              </div>
            </div>
            
            <div class="mt-3 p-3 bg-green-50 rounded-lg">
              <h6 class="font-semibold text-green-800 mb-2">세션간 회복 프로토콜</h6>
              <div class="grid md:grid-cols-3 gap-2 text-xs">
                <div><strong>회복률:</strong> ${phase.interSessionRecovery.recoveryPercentage}%</div>
                <div><strong>수분:</strong> ${phase.interSessionRecovery.hydrationProtocol.totalWater}</div>
                <div><strong>활동:</strong> ${phase.interSessionRecovery.recommendedActivities[0]}</div>
              </div>
            </div>
          `;
        } else {
          // Single session - combine morning and afternoon
          const combinedSession = combineSessions(phase.morning, phase.afternoon);
          html += `
            <div class="bg-gray-50 p-3 rounded-lg">
              <h5 class="font-semibold text-gray-800 mb-2">통합 세션</h5>
              <div class="text-sm space-y-1">
                <div><strong>권장 시간:</strong> ${combinedSession.optimalTime}</div>
                <div><strong>지속시간:</strong> ${combinedSession.duration}분</div>
                <div><strong>집중:</strong> ${combinedSession.focus}</div>
                <div><strong>강도:</strong> ${Math.round(combinedSession.intensity * 100)}%</div>
              </div>
            </div>
          `;
        }
        
        html += '</div>';
        return html;
      }

      function combineSessions(morning, afternoon) {
        // Combine morning and afternoon sessions for single session training
        const totalDuration = morning.duration + (afternoon.duration * 0.7); // Afternoon reduced by 30%
        const weightedIntensity = (morning.targetIntensity + afternoon.targetIntensity) / 2;
        
        return {
          optimalTime: '오후 6시 (저녁 식사 2시간 후)',
          duration: Math.round(totalDuration),
          focus: morning.focus + ' + ' + afternoon.focus,
          intensity: weightedIntensity
        };
      }

      function calculateOptimalSessionLength(profile, sessionType) {
        // Calculate optimal session length based on athlete profile
        const baseDuration = sessionType === 'morning' ? 45 : 60;
        const vdotFactor = profile.vdot / 50; // Normalize to 50 VDOT
        const experienceFactor = Math.min(profile.trainingHistory / 3, 1.5);
        
        return Math.round(baseDuration * vdotFactor * experienceFactor);
      }

      function calculateOptimalStartTime(profile, sessionType, recoveryTime = 0) {
        if (sessionType === 'morning') {
          return '06:30 (공복 상태)'; // Early morning for fasted training
        } else {
          const baseTime = 15; // 3 PM base
          const adjustedTime = baseTime + recoveryTime;
          const hour = Math.min(adjustedTime, 18); // Max 6 PM
          return `${hour}:00 (오전 세션 후 ${recoveryTime}시간)`;
        }
      }

      function calculateDailyLoad(morning, afternoon) {
        const morningLoad = morning.targetIntensity * (morning.duration / 60);
        const afternoonLoad = afternoon.targetIntensity * (afternoon.duration / 60) * 0.8; // 20% reduction for second session
        return Math.round((morningLoad + afternoonLoad) * 10) / 10;
      }

      function calculateInterSessionRecovery(morning, afternoon) {
        const recoveryTime = calculateRecoveryTime(morning);
        const readiness = calculateNextSessionReadiness(morning.duration);
        
        return {
          recoveryPercentage: Math.round(readiness * 100),
          recommendedActivities: getRecoveryActivities(morning.targetIntensity),
          nutritionTiming: '단백질 20g + 탄수화물 40g (즉시)',
          hydrationProtocol: '150ml 전해질 음료 (15분마다)'
        };
      }

      function calculateRecoveryTime(morningSession) {
        const intensity = morningSession.targetIntensity;
        const duration = morningSession.duration;
        const baseRecovery = 4; // 4 hours base
        const intensityFactor = intensity > 0.7 ? 1.5 : 1.0;
        const durationFactor = duration > 60 ? 1.3 : 1.0;
        
        return Math.round(baseRecovery * intensityFactor * durationFactor);
      }

      function calculateNextSessionReadiness(duration) {
        const baseReadiness = 0.8;
        const durationFactor = Math.max(0.6, 1 - (duration - 45) / 100);
        return Math.round(baseReadiness * durationFactor * 100) / 100;
      }

      function getRecoveryActivities(intensity) {
        if (intensity > 0.7) {
          return ['수영 20분', '요가 15분', '마사지', '스트레칭 10분'];
        } else if (intensity > 0.5) {
          return ['가벼운 산책', '스트레칭', '명상'];
        } else {
          return ['일상 활동', '휴식'];
        }
      }

      function calculateDailyNutrition(morning, afternoon) {
        const morningEnergy = calculateEnergyExpenditure(morning);
        const afternoonEnergy = calculateEnergyExpenditure(afternoon);
        const totalEnergy = morningEnergy + afternoonEnergy;
        
        return {
          totalCalories: Math.round(totalEnergy),
          carbohydrateNeeds: Math.round(totalEnergy * 0.6 / 4),
          proteinNeeds: Math.round(totalEnergy * 0.15 / 4),
          fatNeeds: Math.round(totalEnergy * 0.25 / 9)
        };
      }

      function calculateEnergyExpenditure(session) {
        const metValues = {
          'technique_drill': 4.5,
          'high_intensity': 11.0,
          'recovery_run': 6.0,
          'maximal_effort': 14.0,
          'active_recovery': 3.5,
          'tempo_run': 8.5,
          'sprint_training': 9.5,
          'recovery_jog': 5.0,
          'preparation': 3.0,
          'easy_run': 6.5,
          'technique_focus': 4.0,
          'flexibility_balance': 3.0,
          'recovery_mobility': 2.5,
          'strength_training': 6.0,
          'drill_refinement': 4.5,
          'cross_training': 5.5,
          'easy_recovery': 5.0,
          'planning_review': 2.0
        };
        
        const met = metValues[session.sessionType] || 5.0;
        const durationHours = session.duration / 60;
        const bodyWeight = 70; // kg
        
        return met * bodyWeight * durationHours * 60; // calories
      }
      }

      function stopAdaptiveMonitoring() {
        console.log('적응형 모니터링 중지');
      }

      function updateMonitoringDisplay() {
        // Update monitoring display with current metrics
        const monitoringDiv = document.createElement('div');
        monitoringDiv.id = 'adaptiveMonitoring';
        monitoringDiv.className = 'fixed bottom-4 right-4 bg-black text-green-400 p-4 rounded-lg text-sm font-mono';
        monitoringDiv.innerHTML = `
          <div>심박수: <span id="currentHR">--</span> bpm</div>
          <div>피로도: <span id="fatigueLevel">--</span>/10</div>
          <div>회복률: <span id="recoveryRate">--</span>%</div>
        `;
        document.body.appendChild(monitoringDiv);
      }

      // 9-10일 주기 업데이트 함수
      function updateNonaryCycle() {
        if (!userProfile.vdot) return;
        
        const cycleType = document.getElementById('cycleType').value;
        const sessionFreq = document.getElementById('sessionFrequency').value;
        const recoveryMode = document.getElementById('recoveryMode').value;
        
        const athleteProfile = {
          vdot: userProfile.vdot,
          eventDistance: parseInt(document.getElementById('eventDistance').value) || 5000,
          trainingHistory: getTrainingHistory(),
          age: getAgeFromGroup(),
          gender: userProfile.gender,
          chronotype: getChronotype()
        };
        
        // 주기화 계획 생성
        currentNonaryPlan = nonaryEngine.generateDualSessionPlan(athleteProfile);
        
        // UI 업데이트
        renderNonaryCycle(currentNonaryPlan, sessionFreq);
      }

      function renderNonaryCycle(plan, sessionFreq) {
        const trainingCycle = document.getElementById('trainingCycle');
        const cycleLength = plan.cycleLength;
        
        let cycleHTML = '';
        
        if (sessionFreq === 'double') {
          // 하루 2회 훈련 표시
          cycleHTML = renderDualSessionCycle(plan);
        } else {
          // 하루 1회 훈련 표시
          cycleHTML = renderSingleSessionCycle(plan);
        }
        
        trainingCycle.innerHTML = cycleHTML;
      }

      function renderDualSessionCycle(plan) {
        const intensityColors = {
          'high': 'border-red-500 bg-red-50',
          'medium': 'border-orange-500 bg-orange-50', 
          'low': 'border-green-500 bg-green-50',
          'rest': 'border-gray-400 bg-gray-50'
        };
        
        return `
          <div class="bg-gradient-to-r from-purple-50 to-blue-50 border border-purple-200 rounded-lg p-6 mb-6">
            <div class="flex items-center gap-3 mb-3">
              <i class="fas fa-sun text-2xl text-orange-500"></i>
              <i class="fas fa-moon text-2xl text-blue-600"></i>
              <h3 class="text-xl font-bold text-gray-800">하루 2회 훈련 주기</h3>
            </div>
            <div class="text-sm text-gray-700 mb-4">
              오전: 기술·고강도 / 오후: 지구력·회복 - 생리학적 최적화
            </div>
          </div>
          
          <div class="grid gap-6">
            ${plan.phases.map(day => `
              <div class="border-2 border-purple-200 bg-white rounded-lg p-6 hover:shadow-lg transition-all duration-300">
                <div class="flex justify-between items-start mb-4">
                  <div>
                    <div class="flex items-center gap-2 mb-2">
                      <div class="font-bold text-lg">Day ${day.day}: ${day.phase}</div>
                      <div class="bg-purple-100 text-purple-700 px-3 py-1 rounded-full text-sm font-medium">
                        ${day.morning.sessionType}
                      </div>
                    </div>
                    <div class="text-sm text-gray-600 mb-3">${day.phase} 단계</div>
                  </div>
                  <div class="text-center">
                    <div class="text-2xl font-bold text-purple-600 mb-1">${day.dailyLoad.toFixed(1)}</div>
                    <div class="text-xs text-gray-500">일일 부하</div>
                  </div>
                </div>
                
                <!-- 오전 세션 -->
                <div class="mb-6 p-4 bg-gradient-to-r from-orange-50 to-yellow-50 rounded-lg border border-orange-200">
                  <div class="flex justify-between items-center mb-3">
                    <div class="flex items-center gap-2">
                      <i class="fas fa-sun text-orange-500 text-xl"></i>
                      <span class="font-semibold text-orange-800">오전 훈련 (${day.morning.startTime})</span>
                    </div>
                    <span class="bg-orange-100 text-orange-700 px-3 py-1 rounded-full text-sm">
                      ${day.morning.duration}분
                    </span>
                  </div>
                  
                  <div class="grid md:grid-cols-3 gap-4">
                    <div>
                      <div class="text-sm font-medium text-gray-700 mb-1">집중 분야</div>
                      <div class="text-sm text-gray-800 font-medium">${day.morning.focus}</div>
                      <div class="text-xs text-gray-600">${day.morning.energySystem}</div>
                    </div>
                    <div>
                      <div class="text-sm font-medium text-gray-700 mb-1">강도</div>
                      <div class="text-sm font-bold text-red-600">${(day.morning.targetIntensity * 100).toFixed(0)}%</div>
                      <div class="text-xs text-gray-600">최대 대비</div>
                    </div>
                    <div>
                      <div class="text-sm font-medium text-gray-700 mb-1">심박수</div>
                      <div class="text-sm font-bold text-blue-600">${day.morning.heartRateZones.target}</div>
                      <div class="text-xs text-gray-600">bpm</div>
                    </div>
                  </div>
                </div>
                
                <!-- 오후 세션 -->
                <div class="p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border border-blue-200">
                  <div class="flex justify-between items-center mb-3">
                    <div class="flex items-center gap-2">
                      <i class="fas fa-moon text-blue-500 text-xl"></i>
                      <span class="font-semibold text-blue-800">오후 훈련 (${day.afternoon.startTime})</span>
                    </div>
                    <span class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-sm">
                      ${day.afternoon.duration}분
                    </span>
                  </div>
                  
                  <div class="grid md:grid-cols-3 gap-4">
                    <div>
                      <div class="text-sm font-medium text-gray-700 mb-1">집중 분야</div>
                      <div class="text-sm text-gray-800 font-medium">${day.afternoon.focus}</div>
                      <div class="text-xs text-gray-600">${day.afternoon.energySystem}</div>
                    </div>
                    <div>
                      <div class="text-sm font-medium text-gray-700 mb-1">강도</div>
                      <div class="text-sm font-bold text-blue-600">${(day.afternoon.targetIntensity * 100).toFixed(0)}%</div>
                      <div class="text-xs text-gray-600">최대 대비</div>
                    </div>
                    <div>
                      <div class="text-sm font-medium text-gray-700 mb-1">심박수</div>
                      <div class="text-sm font-bold text-green-600">${day.afternoon.heartRateZones.target}</div>
                      <div class="text-xs text-gray-600">bpm</div>
                    </div>
                  </div>
                </div>
                
                <!-- 세션 간 회복 -->
                <div class="mb-4 p-3 bg-green-50 border border-green-200 rounded-lg">
                  <div class="flex items-center gap-2 mb-2">
                    <i class="fas fa-heartbeat text-green-600"></i>
                    <span class="font-medium text-green-800">세션 간 회복 프로토콜</span>
                  </div>
                  <div class="grid md:grid-cols-3 gap-3 text-sm">
                    <div>
                      <div class="font-medium text-gray-700">회복률</div>
                      <div class="text-green-600 font-bold">${day.interSessionRecovery.recoveryPercentage}%</div>
                    </div>
                    <div>
                      <div class="font-medium text-gray-700">추천 활동</div>
                      <div class="text-xs text-gray-600">${day.interSessionRecovery.recommendedActivities.join(', ')}</div>
                    </div>
                    <div>
                      <div class="font-medium text-gray-700">영양 타이밍</div>
                      <div class="text-xs text-gray-600">즉시: 회복음료 / 1시간: 균형식 / 30분 전: 가벼운 간식</div>
                    </div>
                  </div>
                </div>
              </div>
            `).join('')}
          </div>`;
      }

      function renderSingleSessionCycle(plan) {
        return `
          <div class="bg-gradient-to-r from-purple-50 to-blue-50 border border-purple-200 rounded-lg p-6 mb-6">
            <div class="flex items-center gap-3 mb-3">
              <i class="fas fa-calendar-check text-2xl text-purple-600"></i>
              <h3 class="text-xl font-bold text-gray-800">하루 1회 훈련 주기</h3>
            </div>
            <div class="text-sm text-gray-700 mb-4">
              최적화된 단일 세션 - 효율성과 회복의 균형
            </div>
          </div>
          
          <div class="grid gap-4">
            ${plan.phases.map(day => `
              <div class="border-2 border-purple-200 bg-white rounded-lg p-6 hover:shadow-lg transition-all duration-300">
                <div class="flex justify-between items-start mb-4">
                  <div>
                    <div class="flex items-center gap-2 mb-2">
                      <div class="font-bold text-lg">Day ${day.day}: ${day.phase}</div>
                      <div class="bg-purple-100 text-purple-700 px-3 py-1 rounded-full text-sm font-medium">
                        ${day.morning.sessionType}
                      </div>
                    </div>
                    <div class="text-sm text-gray-600 mb-3">${day.phase} 단계</div>
                  </div>
                  <div class="text-center">
                    <div class="text-2xl font-bold text-purple-600 mb-1">${day.dailyLoad.toFixed(1)}</div>
                    <div class="text-xs text-gray-500">일일 부하</div>
                  </div>
                </div>
                
                <!-- 단일 세션 (오전 최적화) -->
                <div class="p-4 bg-gradient-to-r from-orange-50 to-yellow-50 rounded-lg border border-orange-200">
                  <div class="flex justify-between items-center mb-3">
                    <div class="flex items-center gap-2">
                      <i class="fas fa-running text-orange-500 text-xl"></i>
                      <span class="font-semibold text-orange-800">최적화 훈련 (${day.morning.startTime})</span>
                    </div>
                    <span class="bg-orange-100 text-orange-700 px-3 py-1 rounded-full text-sm">
                      ${day.morning.duration}분
                    </span>
                  </div>
                  
                  <div class="grid md:grid-cols-4 gap-4">
                    <div>
                      <div class="text-sm font-medium text-gray-700 mb-1">집중 분야</div>
                      <div class="text-sm text-gray-800 font-medium">${day.morning.focus}</div>
                      <div class="text-xs text-gray-600">${day.morning.energySystem}</div>
                    </div>
                    <div>
                      <div class="text-sm font-medium text-gray-700 mb-1">강도</div>
                      <div class="text-sm font-bold text-red-600">${(day.morning.targetIntensity * 100).toFixed(0)}%</div>
                      <div class="text-xs text-gray-600">최대 대비</div>
                    </div>
                    <div>
                      <div class="text-sm font-medium text-gray-700 mb-1">심박수</div>
                      <div class="text-sm font-bold text-blue-600">${day.morning.heartRateZones.target}</div>
                      <div class="text-xs text-gray-600">bpm</div>
                    </div>
                    <div>
                      <div class="text-sm font-medium text-gray-700 mb-1">회복 지수</div>
                      <div class="text-sm font-bold text-green-600">${Math.round(day.morning.recoveryMetrics.nextSession * 100)}%</div>
                      <div class="text-xs text-gray-600">준비도</div>
                    </div>
                  </div>
                </div>
                
                <!-- 회복 정보 -->
                <div class="mt-4 p-3 bg-green-50 border border-green-200 rounded-lg">
                  <div class="flex items-center gap-2 mb-2">
                    <i class="fas fa-heart text-green-600"></i>
                    <span class="font-medium text-green-800">회복 프로토콜</span>
                  </div>
                  <div class="grid md:grid-cols-3 gap-3 text-sm">
                    <div>
                      <div class="font-medium text-gray-700">즉시 회복</div>
                      <div class="text-xs text-gray-600">${day.morning.recoveryMetrics.immediate}</div>
                    </div>
                    <div>
                      <div class="font-medium text-gray-700">다음날 준비도</div>
                      <div class="text-green-600 font-bold">${Math.round(day.morning.recoveryMetrics.nextSession * 100)}%</div>
                    </div>
                    <div>
                      <div class="font-medium text-gray-700">권장 수면</div>
                      <div class="text-xs text-gray-600">22:30-23:00, 7-9시간</div>
                    </div>
                  </div>
                </div>
              </div>
            `).join('')}
          </div>`;
      }
                    </div>
                    <span class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-sm">
                      ${day.afternoon.duration}분
                    </span>
                  </div>
                  
                  <div class="grid md:grid-cols-3 gap-4">
                    <div>
                      <div class="text-sm font-medium text-gray-700 mb-1">집중 분야</div>
                      <div class="text-sm text-gray-800 font-medium">${day.afternoon.focus}</div>
                      <div class="text-xs text-gray-600">${day.afternoon.energySystem}</div>
                    </div>
                    <div>
                      <div class="text-sm font-medium text-gray-700 mb-1">강도</div>
                      <div class="text-sm font-bold text-green-600">${(day.afternoon.targetIntensity * 100).toFixed(0)}%</div>
                      <div class="text-xs text-gray-600">최대 대비</div>
                    </div>
                    <div>
                      <div class="text-sm font-medium text-gray-700 mb-1">심박수</div>
                      <div class="text-sm font-bold text-purple-600">${day.afternoon.heartRateZones.target}</div>
                      <div class="text-xs text-gray-600">bpm</div>
                    </div>
                  </div>
                </div>
                
                <!-- 세션 간 회복 정보 -->
                <div class="mb-4 p-3 bg-green-50 rounded-lg border border-green-200">
                  <div class="flex items-center gap-2 mb-2">
                    <i class="fas fa-heartbeat text-green-600"></i>
                    <span class="font-medium text-green-800">세션 간 회복 프로토콜</span>
                  </div>
                  <div class="grid md:grid-cols-2 gap-4 text-sm">
                    <div>
                      <div class="text-gray-700 mb-1">회복률: <span class="font-bold text-green-700">${day.interSessionRecovery.recoveryPercentage}%</span></div>
                      <div class="text-gray-600 text-xs">권장 활동: ${day.interSessionRecovery.recommendedActivities.join(', ')}</div>
                    </div>
                    <div>
                      <div class="text-gray-700 mb-1">영양 타이밍</div>
                      <div class="text-gray-600 text-xs">즉시: ${day.interSessionRecovery.nutritionTiming.immediately}</div>
                      <div class="text-gray-600 text-xs">1시간 후: ${day.interSessionRecovery.nutritionTiming.after1Hour}</div>
                    </div>
                  </div>
                </div>
                
                <!-- 일일 영양 정보 -->
                <div class="p-3 bg-yellow-50 rounded-lg border border-yellow-200">
                  <div class="flex items-center gap-2 mb-2">
                    <i class="fas fa-apple-alt text-yellow-600"></i>
                    <span class="font-medium text-yellow-800">일일 영양 계획</span>
                  </div>
                  <div class="grid md:grid-cols-4 gap-2 text-sm">
                    <div class="text-center">
                      <div class="font-bold text-yellow-700">${day.dailyNutrition.totalCalories}</div>
                      <div class="text-xs text-gray-600">총 칼로리</div>
                    </div>
                    <div class="text-center">
                      <div class="font-bold text-orange-600">${day.dailyNutrition.carbohydrateNeeds}g</div>
                      <div class="text-xs text-gray-600">탄수화물</div>
                    </div>
                    <div class="text-center">
                      <div class="font-bold text-red-600">${day.dailyNutrition.proteinNeeds}g</div>
                      <div class="text-xs text-gray-600">단백질</div>
                    </div>
                    <div class="text-center">
                      <div class="font-bold text-purple-600">${day.dailyNutrition.fatNeeds}g</div>
                      <div class="text-xs text-gray-600">지방</div>
                    </div>
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        `;
      }

      function renderSingleSessionCycle(plan) {
        return `
          <div class="bg-gradient-to-r from-purple-50 to-blue-50 border border-purple-200 rounded-lg p-6 mb-6">
            <div class="flex items-center gap-3 mb-3">
              <i class="fas fa-calendar-day text-2xl text-purple-600"></i>
              <h3 class="text-xl font-bold text-gray-800">하루 1회 훈련 주기</h3>
            </div>
            <div class="text-sm text-gray-700 mb-4">
              9-10일 주기: 생리학적 최적화 / 전통적 7일 주기 대비 피로 누적 30% 감소
            </div>
          </div>
          
          <div class="grid gap-4">
            ${plan.phases.map(day => `
              <div class="border-2 border-purple-200 bg-white rounded-lg p-4 hover:shadow-lg transition-all duration-300">
                <div class="flex justify-between items-start mb-3">
                  <div>
                    <div class="font-bold text-lg">Day ${day.day}: ${day.phase}</div>
                    <div class="text-sm text-gray-600">${day.phase} 단계</div>
                  </div>
                  <div class="text-center">
                    <div class="text-xl font-bold text-purple-600">${day.dailyLoad.toFixed(1)}</div>
                    <div class="text-xs text-gray-500">일일 부하</div>
                  </div>
                </div>
                
                <div class="grid md:grid-cols-3 gap-4">
                  <div>
                    <div class="text-sm font-medium text-gray-700 mb-1">집중 분야</div>
                    <div class="text-sm text-gray-800 font-medium">${day.morning.focus}</div>
                    <div class="text-xs text-gray-600">${day.morning.energySystem}</div>
                  </div>
                  <div>
                    <div class="text-sm font-medium text-gray-700 mb-1">강도</div>
                    <div class="text-sm font-bold ${day.morning.targetIntensity > 0.7 ? 'text-red-600' : day.morning.targetIntensity > 0.5 ? 'text-orange-600' : 'text-green-600'}">
                      ${(day.morning.targetIntensity * 100).toFixed(0)}%
                    </div>
                    <div class="text-xs text-gray-600">최대 대비</div>
                  </div>
                  <div>
                    <div class="text-sm font-medium text-gray-700 mb-1">심박수</div>
                    <div class="text-sm font-bold text-blue-600">${day.morning.heartRateZones.target}</div>
                    <div class="text-xs text-gray-600">bpm</div>
                  </div>
                </div>
                
                <div class="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                  <div class="flex justify-between items-center">
                    <div>
                      <div class="text-sm font-medium text-blue-800">권장 시간</div>
                      <div class="text-xs text-blue-600">${day.morning.startTime} 시작</div>
                    </div>
                    <div>
                      <div class="text-sm font-medium text-blue-800">소요 시간</div>
                      <div class="text-xs text-blue-600">${day.morning.duration}분</div>
                    </div>
                    <div>
                      <div class="text-sm font-medium text-blue-800">회복률</div>
                      <div class="text-xs text-blue-600">${day.interSessionRecovery.recoveryPercentage}%</div>
                    </div>
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        `;
      }
                    </div>
                    <span class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-sm">
                      ${day.afternoon.duration}분
                    </span>
                  </div>
                  
                  <div class="grid md:grid-cols-3 gap-4">
                    <div>
                      <div class="text-sm font-medium text-gray-700 mb-1">집중 분야</div>
                      <div class="text-sm text-gray-800 font-medium">${day.afternoon.focus}</div>
                      <div class="text-xs text-gray-600">${day.afternoon.energySystem}</div>
                    </div>
                    <div>
                      <div class="text-sm font-medium text-gray-700 mb-1">강도</div>
                      <div class="text-sm font-bold text-blue-600">${(day.afternoon.targetIntensity * 100).toFixed(0)}%</div>
                      <div class="text-xs text-gray-600">최대 대비</div>
                    </div>
                    <div>
                      <div class="text-sm font-medium text-gray-700 mb-1">심박수</div>
                      <div class="text-sm font-bold text-green-600">${day.afternoon.heartRateZones.target}</div>
                      <div class="text-xs text-gray-600">bpm</div>
                    </div>
                  </div>
                </div>
                
                <!-- 세션 간 회복 & 영양 -->
                <div class="p-4 bg-gradient-to-r from-green-50 to-teal-50 rounded-lg border border-green-200">
                  <div class="flex items-center gap-2 mb-3">
                    <i class="fas fa-heart text-red-500 text-xl"></i>
                    <span class="font-semibold text-green-800">세션 간 회복 프로토콜</span>
                  </div>
                  
                  <div class="grid md:grid-cols-3 gap-4 text-sm">
                    <div>
                      <div class="font-medium text-green-700 mb-1">회복률</div>
                      <div class="font-bold text-green-600">${day.interSessionRecovery.recoveryPercentage}%</div>
                      <div class="text-xs text-gray-600">준비도</div>
                    </div>
                    <div>
                      <div class="font-medium text-amber-700 mb-1">영양 타이밍</div>
                      <div class="text-xs text-gray-700">즉시: 단백질 20g</div>
                      <div class="text-xs text-gray-700">1시간 후: 균형식</div>
                    </div>
                    <div>
                      <div class="font-medium text-blue-700 mb-1">수분</div>
                      <div class="text-xs text-gray-700">150ml/15분</div>
                      <div class="text-xs text-gray-700">전해질 포함</div>
                    </div>
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        `;
      }

      function renderSingleSessionCycle(plan) {
        return `
          <div class="bg-gradient-to-r from-blue-50 to-green-50 border border-blue-200 rounded-lg p-6 mb-6">
            <div class="flex items-center gap-3 mb-3">
              <i class="fas fa-calendar-check text-2xl text-green-600"></i>
              <h3 class="text-xl font-bold text-gray-800">하루 1회 훈련 주기</h3>
            </div>
            <div class="text-sm text-gray-700 mb-4">
              생리학적 적응 주기에 따른 최적화된 단일 세션 훈련
            </div>
          </div>
          
          <div class="grid gap-4">
            ${plan.phases.map(day => `
              <div class="border-2 border-blue-200 bg-white rounded-lg p-5 hover:shadow-md transition-all duration-300">
                <div class="flex justify-between items-start mb-3">
                  <div>
                    <div class="flex items-center gap-2 mb-1">
                      <div class="font-bold text-lg">Day ${day.day}: ${day.phase}</div>
                      <div class="bg-blue-100 text-blue-700 px-2 py-1 rounded-full text-xs font-medium">
                        ${day.morning.sessionType}
                      </div>
                    </div>
                    <div class="text-sm text-gray-600">${day.phase} 단계</div>
                  </div>
                  <div class="text-center">
                    <div class="text-xl font-bold text-blue-600 mb-1">${day.dailyLoad.toFixed(1)}</div>
                    <div class="text-xs text-gray-500">일일 부하</div>
                  </div>
                </div>
                
                <div class="grid md:grid-cols-4 gap-4 text-sm">
                  <div>
                    <div class="font-medium text-gray-700 mb-1">훈련 시간</div>
                    <div class="font-bold text-gray-800">${day.morning.duration}분</div>
                  </div>
                  <div>
                    <div class="font-medium text-gray-700 mb-1">강도</div>
                    <div class="font-bold text-red-600">${(day.morning.targetIntensity * 100).toFixed(0)}%</div>
                  </div>
                  <div>
                    <div class="font-medium text-gray-700 mb-1">집중 분야</div>
                    <div class="text-gray-800">${day.morning.focus}</div>
                  </div>
                  <div>
                    <div class="font-medium text-gray-700 mb-1">에너지 시스템</div>
                    <div class="text-gray-800">${day.morning.energySystem}</div>
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        `;
      }
                    </div>
                    <span class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-sm">
                      ${day.afternoon.duration}분
                    </span>
                  </div>
                  
                  <div class="grid md:grid-cols-3 gap-4">
                    <div>
                      <div class="text-sm font-medium text-gray-700 mb-1">집중 분야</div>
                      <div class="text-sm text-gray-800 font-medium">${day.afternoon.focus}</div>
                      <div class="text-xs text-gray-600">${day.afternoon.energySystem}</div>
                    </div>
                    <div>
                      <div class="text-sm font-medium text-gray-700 mb-1">강도</div>
                      <div class="text-sm font-bold text-blue-600">${(day.afternoon.targetIntensity * 100).toFixed(0)}%</div>
                      <div class="text-xs text-gray-600">최대 대비</div>
                    </div>
                    <div>
                      <div class="text-sm font-medium text-gray-700 mb-1">심박수</div>
                      <div class="text-sm font-bold text-green-600">${day.afternoon.heartRateZones.target}</div>
                      <div class="text-xs text-gray-600">bpm</div>
                    </div>
                  </div>
                </div>
                
                <!-- 세션 간 회복 & 영양 -->
                <div class="p-4 bg-gradient-to-r from-green-50 to-teal-50 rounded-lg border border-green-200">
                  <div class="flex items-center gap-2 mb-3">
                    <i class="fas fa-heart text-red-500 text-xl"></i>
                    <span class="font-semibold text-green-800">세션 간 회복 프로토콜</span>
                  </div>
                  
                  <div class="grid md:grid-cols-3 gap-4 text-sm">
                    <div>
                      <div class="font-medium text-green-700 mb-1">회복률</div>
                      <div class="font-bold text-green-600">${day.interSessionRecovery.recoveryPercentage}%</div>
                      <div class="text-xs text-gray-600">준비도</div>
                    </div>
                    <div>
                      <div class="font-medium text-amber-700 mb-1">영양 타이밍</div>
                      <div class="text-xs text-gray-700">즉시: 단백질 20g</div>
                      <div class="text-xs text-gray-700">1시간 후: 균형식</div>
                    </div>
                    <div>
                      <div class="font-medium text-blue-700 mb-1">수분</div>
                      <div class="text-xs text-gray-700">150ml/15분</div>
                      <div class="text-xs text-gray-700">전해질 포함</div>
                    </div>
                  </div>
                </div>
                    </div>
                    <span class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-sm">
                      ${day.afternoon.duration}분
                    </span>
                  </div>
                  
                  <div class="grid md:grid-cols-3 gap-4">
                    <div>
                      <div class="text-sm font-medium text-gray-700 mb-1">집중 분야</div>
                      <div class="text-sm text-gray-800 font-medium">${day.afternoon.focus}</div>
                      <div class="text-xs text-gray-600">${day.afternoon.energySystem}</div>
                    </div>
                    <div>
                      <div class="text-sm font-medium text-gray-700 mb-1">강도</div>
                      <div class="text-sm font-bold text-green-600">${(day.afternoon.targetIntensity * 100).toFixed(0)}%</div>
                      <div class="text-xs text-gray-600">최대 대비</div>
                    </div>
                    <div>
                      <div class="text-sm font-medium text-gray-700 mb-1">심박수</div>
                      <div class="text-sm font-bold text-blue-600">${day.afternoon.heartRateZones.target}</div>
                      <div class="text-xs text-gray-600">bpm</div>
                    </div>
                  </div>
                </div>
                
                <!-- 회복 프로토콘 -->
                <div class="p-4 bg-green-50 rounded-lg border border-green-200">
                  <div class="flex items-center gap-2 mb-3">
                    <i class="fas fa-heartbeat text-green-600"></i>
                    <span class="font-semibold text-green-800">세션 간 회복 프로토콜</span>
                    <span class="bg-green-100 text-green-700 px-2 py-1 rounded text-sm">
                      회복률: ${day.interSessionRecovery.recoveryPercentage}%
                    </span>
                  </div>
                  
                  <div class="grid md:grid-cols-2 gap-4 text-sm">
                    <div>
                      <div class="font-medium text-gray-700 mb-2">추천 활동</div>
                      <div class="text-gray-600">
                        ${day.interSessionRecovery.recommendedActivities.join(', ')}
                      </div>
                    </div>
                    <div>
                      <div class="font-medium text-gray-700 mb-2">영양 타이밍</div>
                      <div class="text-gray-600">
                        즉시: 회복 음료 / 1시간 후: 균형잡힌 식사
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        `;
      }

      function renderSingleSessionCycle(plan) {
        return `
          <div class="bg-gradient-to-r from-blue-50 to-purple-50 border border-blue-200 rounded-lg p-6 mb-6">
            <div class="flex items-center gap-3 mb-3">
              <i class="fas fa-calendar-check text-2xl text-blue-600"></i>
              <h3 class="text-xl font-bold text-gray-800">하루 1회 훈련 주기</h3>
            </div>
            <div class="text-sm text-gray-700">
              최적화된 단일 세션 - 생리학적 적응 최대화
            </div>
          </div>
          
          <div class="grid gap-4">
            ${plan.phases.map(day => `
              <div class="border-2 border-blue-200 bg-white rounded-lg p-6 hover:shadow-lg transition-all duration-300">
                <div class="flex justify-between items-start mb-4">
                  <div>
                    <div class="flex items-center gap-2 mb-2">
                      <div class="font-bold text-lg">Day ${day.day}: ${day.phase}</div>
                      <div class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-sm font-medium">
                        ${day.morning.sessionType}
                      </div>
                    </div>
                    <div class="text-sm text-gray-600 mb-3">${day.phase} 단계</div>
                  </div>
                  <div class="text-center">
                    <div class="text-2xl font-bold text-blue-600 mb-1">${day.dailyLoad.toFixed(1)}</div>
                    <div class="text-xs text-gray-500">일일 부하</div>
                  </div>
                </div>
                
                <div class="grid md:grid-cols-4 gap-4">
                  <div>
                    <div class="text-sm font-medium text-gray-700 mb-1">시작 시간</div>
                    <div class="text-sm font-bold text-orange-600">${day.morning.startTime}</div>
                  </div>
                  <div>
                    <div class="text-sm font-medium text-gray-700 mb-1">지속 시간</div>
                    <div class="text-sm font-bold text-purple-600">${day.morning.duration}분</div>
                  </div>
                  <div>
                    <div class="text-sm font-medium text-gray-700 mb-1">강도</div>
                    <div class="text-sm font-bold text-red-600">${(day.morning.targetIntensity * 100).toFixed(0)}%</div>
                  </div>
                  <div>
                    <div class="text-sm font-medium text-gray-700 mb-1">심박수</div>
                    <div class="text-sm font-bold text-blue-600">${day.morning.heartRateZones.target} bpm</div>
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        `;
      }

      function getTrainingHistory() {
        const experience = document.getElementById('experience').value;
        const years = {
          'beginner': 0.5,
          'intermediate': 2,
          'advanced': 4,
          'elite': 6
        };
        return years[experience] || 2;
      }

      function getAgeFromGroup() {
        const ageGroup = document.getElementById('ageGroup').value;
        const ages = {
          'junior': 16,
          'senior': 25,
          'master40': 45,
          'master50': 55,
          'master60': 65
        };
        return ages[ageGroup] || 25;
      }

      function getChronotype() {
        // 기본적으로 중간형으로 가정
        return 'intermediate';
      }

      function toggleAdaptiveMode() {
        const isAdaptive = document.getElementById('adaptiveMode').checked;
        if (isAdaptive) {
          startAdaptiveMonitoring();
        } else {
          stopAdaptiveMonitoring();
        }
      }

      function startAdaptiveMonitoring() {
        // 실시간 적응 모니터링 시작
        console.log('적응형 모니터링 시작');
        // 실제 구현에서는 여기서 센서 데이터를 수집하고 분석
      }

      function stopAdaptiveMonitoring() {
        // 실시간 적응 모니터링 중지
        console.log('적응형 모니터링 중지');
      }

      // 기존 calculateTraining 함수 수정
      // 주 훈련 계산 함수
      function calculateTraining() {
        // 사용자 프로필 업데이트
        updateUserProfile();
        
        // 기록 계산
        const distance = parseInt(document.getElementById('eventDistance').value);
        const hours = parseInt(document.getElementById('hours').value) || 0;
        const minutes = parseInt(document.getElementById('minutes').value) || 0;
        const seconds = parseFloat(document.getElementById('seconds').value) || 0;
        
        if (!distance || (hours === 0 && minutes === 0 && seconds === 0)) {
          alert('종목과 기록을 모두 입력해주세요.');
          return;
        }
        
        const totalSeconds = hours * 3600 + minutes * 60 + seconds;
        const vdot = calculateExactVDOT(distance, totalSeconds);
        userProfile.vdot = vdot;
        
        // 훈련 페이스 계산
        const paces = calculateTrainingPaces(vdot);
        
        // 조정치 계산
        calculateAdjustments();
        
        // 결과 표시
        displayResults(vdot, paces);
        
        // 9-10일 주기화 시스템 실행
        updateNonaryCycle();
        generateNonaryTrainingCycle();
        
        // 메조사이클 계획
        generateMesocyclePlan();
        
        // 구체적인 워크아웃 생성
        generateSpecificWorkouts(paces);
        
        // 표준 템플릿 생성
        generateWorkoutTemplates();
        
        // 권장사항 생성
        generateRecommendations();
        
        // 결과 섹션 표시
        document.getElementById('resultsSection').classList.remove('hidden');
        
        // 실시간 업데이트 시작
        startRealtimeUpdates();
      }
        // 기존 계산 로직 유지
        
        // 9-10일 주기화 업데이트
        setTimeout(() => {
          updateNonaryCycle();
        }, 100);
      }

      // 실시간 업데이트 함수
      function realtimeUpdateTraining() {
        if (currentNonaryPlan) {
          updateNonaryCycle();
        }
      }

    // 미세 조정 기능
    let fineTuneAdjustments = {
      pace: 1.0,
      volume: 1.0,
      intensity: 1.0
    };

    function updateFineTuning(type) {
      const slider = document.getElementById(`${type}Adjust`);
      const value = parseFloat(slider.value);
      const displayElement = document.getElementById(`${type}Value`);
      
      fineTuneAdjustments[type] = value / 100;
      
      // Update display with color coding
      let color = 'text-gray-700';
      if (value < 95) color = 'text-blue-600';
      else if (value > 105) color = 'text-red-600';
      else if (value < 100) color = 'text-green-600';
      else if (value > 100) color = 'text-orange-600';
      
      displayElement.textContent = value + '%';
      displayElement.className = `font-bold text-lg ${color}`;
      
      // 결과가 표시되어 있으면 즉시 재계산
      if (!document.getElementById('resultsSection').classList.contains('hidden')) {
        realtimeUpdateTraining();
      }
    }

    function calculateVolume(baseVolume, frequencyMultiplier, experienceMultiplier, recoveryFactor, altitudeFactor) {
      return Math.round(baseVolume * frequencyMultiplier * experienceMultiplier * recoveryFactor * altitudeFactor * fineTuneAdjustments.volume * userProfile.adjustments.volume);
    }

    function getIntervalWorkout(vdot, experience, day) {
      const workouts = {
        beginner: {
          day1: '3 x 800m @ I 페이스 (회복 2-3분)',
          day5: '6 x 200m @ R 페이스 (완전회복)'
        },
        intermediate: {
          day1: '5 x 1000m @ I 페이스 (회복 2-3분)',
          day5: '8 x 400m @ R 페이스 (완전회복)'
        },
        advanced: {
          day1: '6 x 1200m @ I 페이스 (회복 2분)',
          day5: '10 x 400m @ R 페이스 (완전회복)'
        },
        elite: {
          day1: '8 x 1600m @ I 페이스 (회복 90초)',
          day5: '12 x 400m @ R 페이스 (완전회복)'
        }
      };
      return workouts[experience]?.[day] || workouts.intermediate[day];
    }

    function getThresholdWorkout(vdot, experience, day) {
      const workouts = {
        beginner: {
          day3: '2 x 15분 @ T 페이스 (휴식 2분)'
        },
        intermediate: {
          day3: '2 x 20분 @ T 페이스 (휴식 3분)'
        },
        advanced: {
          day3: '30분 연속 @ T 페이스'
        },
        elite: {
          day3: '2 x 25분 @ T 페이스 (휴식 2분)'
        }
      };
      return workouts[experience]?.[day] || workouts.intermediate[day];
    }

    function getSpeedWorkout(vdot, experience, day) {
      const workouts = {
        beginner: {
          day5: '6 x 200m @ R 페이스 (완전회복 3분)'
        },
        intermediate: {
          day5: '8 x 400m @ R 페이스 (완전회복 3-4분)'
        },
        advanced: {
          day5: '10 x 400m @ R 페이스 (완전회복 3분)'
        },
        elite: {
          day5: '12 x 400m @ R 페이스 (완전회복 2분)'
        }
      };
      return workouts[experience]?.[day] || workouts.intermediate[day];
    }

    function getLongRun(vdot, experience, day) {
      const baseDistance = {
        beginner: '60-75분',
        intermediate: '90-105분', 
        advanced: '105-120분',
        elite: '120-150분'
      };
      
      const descriptions = {
        beginner: `${baseDistance.beginner} @ E 페이스`,
        intermediate: `${baseDistance.intermediate} @ E 페이스, 마지막 15분 M 페이스`,
        advanced: `${baseDistance.advanced} Progressive (E→M→T)`,
        elite: `${baseDistance.elite} Progressive with surges`
      };
      
      return descriptions[experience] || descriptions.intermediate;
    }

    function getRecoveryRun(experience, day) {
      const runs = {
        beginner: '30-40분 매우 편안하게',
        intermediate: '45-60분 Easy 페이스',
        advanced: '50-70분 Easy 페이스',
        elite: '60-80분 Easy 페이스'
      };
      return runs[experience] || runs.intermediate;
    }

    function getEasyRun(experience, day) {
      const runs = {
        beginner: '20-30분 매우 편안하게',
        intermediate: '30-40분 매우 편안하게',
        advanced: '40-50분 매우 편안하게',
        elite: '50-60분 매우 편안하게'
      };
      return runs[experience] || runs.intermediate;
    }

    function getActiveRecovery(experience) {
      const recoveries = {
        beginner: '수영 30분 또는 요가',
        intermediate: '수영 45분, 자전거 60분, 또는 요가',
        advanced: '수영 60분, 자전거 75분, 또는 요가',
        elite: '수영 75분, 자전거 90분, 또는 요가'
      };
      return recoveries[experience] || recoveries.intermediate;
    }

    function getRestDay(experience) {
      const rests = {
        beginner: '완전 휴식 또는 15분 산책',
        intermediate: '완전 휴식 또는 20분 산책',
        advanced: '완전 휴식 또는 25분 산책',
        elite: '완전 휴식 또는 30분 산책'
      };
      return rests[experience] || rests.intermediate;
    }

    function getTestDay(vdot, experience, day) {
      const tests = {
        beginner: '3km 타임트라이얼 또는 레이스',
        intermediate: '5km 타임트라이얼 또는 레이스',
        advanced: '8-10km 타임트라이얼 또는 레이스',
        elite: '10-15km 타임트라이얼 또는 레이스'
      };
      return tests[experience] || tests.intermediate;
    }

    function getIntervalDetails(vdot, experience) {
      const details = {
        beginner: '일정한 페이스 유지, 마지막 반복까지 여유 있게',
        intermediate: '목표 페이스 ±3초/400m 유지',
        advanced: '일정한 페이스로 마지막까지 강하게',
        elite: '마지막 반복이 가장 빠르게'
      };
      return details[experience] || details.intermediate;
    }
      ['pace', 'volume', 'intensity'].forEach(type => {
        document.getElementById(`${type}Adjust`).value = 100;
        updateFineTuning(type);
      });
    }

    function generate9DayTrainingCycle(vdot, paces) {
      const trainingCycle = document.getElementById('trainingCycle');
      const phase = document.getElementById('trainingPhase').value;
      const frequency = document.getElementById('frequency').value;
      const experience = document.getElementById('experience').value;
      
      // 과학적 기반: 9-10일 주기화의 생리학적 근거
      // 1. 근육 단백질 합성 주기: 48-72시간
      // 2. 미토콘드리아 적응: 72-96시간  
      // 3. 신경계 적응: 24-48시간
      // 4. 호르몬 변화: 48-120시간
      
      // 훈련 강도 계산 (VDOT 기반)
      const baseIntensity = Math.min(vdot / 100, 1.0); // VDOT 50 = 0.5, VDOT 70 = 0.7
      const recoveryFactor = userAdjustments.condition < 0 ? 1.2 : 1.0;
      const altitudeFactor = document.getElementById('altitude').checked ? 0.85 : 1.0;
      
      // 주파수에 따른 볼륨 조정
      const frequencyMultiplier = {
        '3-4': 0.7,
        '5-6': 1.0,
        '7+': 1.2
      }[frequency] || 1.0;
      
      // 경험치에 따른 볼륨 조정
      const experienceMultiplier = {
        'beginner': 0.7,
        'intermediate': 1.0,
        'advanced': 1.3,
        'elite': 1.5
      }[experience] || 1.0;
      
      // 기본 9일 주기 - 생리학적 초보상 최적화
      const cycles = [
        {
          day: 1,
          type: '핵심 인터벌',
          intensity: 'high',
          description: getIntervalWorkout(vdot, experience, 'day1'),
          volume: calculateVolume(10, frequencyMultiplier, experienceMultiplier, recoveryFactor, altitudeFactor),
          details: getIntervalDetails(vdot, experience),
          pace: formatPace((currentPaces.interval || paces.interval) * fineTuneAdjustments.pace),
          physiological: 'VO₂max 자극, 미토콘드리아 증식 촉진',
          recoveryTime: '48-72시간'
        },
        {
          day: 2,
          type: '회복 조깅',
          intensity: 'low', 
          description: getRecoveryRun(experience, 'day2'),
          volume: calculateVolume(8, frequencyMultiplier, experienceMultiplier, recoveryFactor, altitudeFactor),
          details: '심박수 65-70%, 혈류 증가로 회복 촉진',
          pace: `${formatPace((currentPaces?.easy.max || paces.easy.max) * fineTuneAdjustments.pace)} - ${formatPace((currentPaces?.easy.min || paces.easy.min) * fineTuneAdjustments.pace)}`,
          physiological: '근육 손상 복구, 젖산 제거',
          recoveryTime: '24시간'
        },
        {
          day: 3,
          type: '임계 훈련',
          intensity: 'medium',
          description: getThresholdWorkout(vdot, experience, 'day3'),
          volume: calculateVolume(12, frequencyMultiplier, experienceMultiplier, recoveryFactor, altitudeFactor),
          details: '젖산역치 향상, 경제성 개선',
          pace: formatPace((currentPaces?.threshold || paces.threshold) * fineTuneAdjustments.pace),
          physiological: '젖산 처리 능력 향상, 경제성 개선',
          recoveryTime: '36-48시간'
        },
        {
          day: 4,
          type: '적극적 회복',
          intensity: 'rest',
          description: getActiveRecovery(experience),
          volume: 0,
          details: '수영, 자전거, 요가 권장 - 혈류 유지',
          pace: '-',
          physiological: '근육 섬유 미세 손상 복구, 에너지 저장소 충전',
          recoveryTime: '48-72시간'
        },
        {
          day: 5,
          type: '스피드 세션',
          intensity: 'high',
          description: getSpeedWorkout(vdot, experience, 'day5'),
          volume: calculateVolume(8, frequencyMultiplier, experienceMultiplier, recoveryFactor, altitudeFactor),
          details: '신경계 자극, 폼 개선',
          pace: formatPace((currentPaces?.repetition || paces.repetition) * fineTuneAdjustments.pace),
          physiological: '신경계 적응, 고속에서의 폼 개선',
          recoveryTime: '48시간'
        },
        {
          day: 6,
          type: '회복런',
          intensity: 'low',
          description: getEasyRun(experience, 'day6'),
          volume: calculateVolume(5, frequencyMultiplier, experienceMultiplier, recoveryFactor, altitudeFactor),
          details: '다음 고강도 훈련 준비',
          pace: formatPace((currentPaces?.easy.max || paces.easy.max) * fineTuneAdjustments.pace),
          physiological: '활성 회복, 근육 긴장 완화',
          recoveryTime: '18-24시간'
        },
        {
          day: 7,
          type: '장거리',
          intensity: 'medium',
          description: getLongRun(vdot, experience, 'day7'),
          volume: calculateVolume(18, frequencyMultiplier, experienceMultiplier, recoveryFactor, altitudeFactor),
          details: '지구력 구축, 지방 연소 효율성 향상',
          pace: `${formatPace((currentPaces?.easy.min || paces.easy.min) * fineTuneAdjustments.pace)} / ${formatPace((currentPaces?.marathon || paces.marathon) * fineTuneAdjustments.pace)}`,
          physiological: '미토콘드리아 증식, 지방 연소 효율성 향상',
          recoveryTime: '72-96시간'
        },
        {
          day: 8,
          type: '회복',
          intensity: 'rest',
          description: getRestDay(experience),
          volume: calculateVolume(3, frequencyMultiplier, experienceMultiplier, recoveryFactor, altitudeFactor),
          details: '마사지, 스트레칭, 수면 중점',
          pace: '-',
          physiological: '완전 회복, 과훈련 방지',
          recoveryTime: '24-48시간'
        },
        {
          day: 9,
          type: '테스트/레이스',
          intensity: 'high',
          description: getTestDay(vdot, experience, 'day9'),
          volume: calculateVolume(7, frequencyMultiplier, experienceMultiplier, recoveryFactor, altitudeFactor),
          details: '실전 시뮬레이션, 적응도 평가',
          pace: '목표 페이스',
          physiological: '훈련 효과 측정, 신경계 각성',
          recoveryTime: '48-72시간'
        }
      ];
      
      
      // 단계별 수정 및 과학적 보정
      if (phase === 'base') {
        cycles.forEach((c, i) => {
          if (c.intensity === 'high') {
            c.volume = Math.round(c.volume * 0.8);
            c.description = c.description.replace(/\d+ x \d+m/, (match) => {
              const parts = match.split(' x ');
              return `${Math.round(parseInt(parts[0]) * 0.8)} x ${parts[1]}`;
            });
          }
        });
      } else if (phase === 'taper') {
        cycles.forEach(c => c.volume = Math.round(c.volume * 0.6));
      } else if (phase === 'peak') {
        cycles.forEach((c, i) => {
          if (c.intensity === 'high' && i % 2 === 0) {
            c.volume = Math.round(c.volume * 1.1);
          }
        });
      }
      
      const intensityColors = {
        'high': 'border-red-500 bg-red-50',
        'medium': 'border-orange-500 bg-orange-50', 
        'low': 'border-green-500 bg-green-50',
        'rest': 'border-gray-400 bg-gray-50'
      };
      
      const intensityIcons = {
        'high': 'fa-fire text-red-500',
        'medium': 'fa-bolt text-orange-500',
        'low': 'fa-leaf text-green-500', 
        'rest': 'fa-bed text-gray-500'
      };
      
      const cycleHTML = cycles.map(day => `
        <div class="border-2 ${intensityColors[day.intensity]} rounded-lg p-4 hover:shadow-md transition-all duration-300">
          <div class="flex justify-between items-start mb-3">
            <div class="flex-1">
              <div class="flex items-center gap-2 mb-2">
                <div class="font-bold text-lg">Day ${day.day}: ${day.type}</div>
                <i class="fas ${intensityIcons[day.intensity]} text-xl"></i>
              </div>
              <div class="text-lg font-semibold text-gray-800 mb-2">${day.description}</div>
              <div class="text-sm text-gray-600 mb-3">${day.details}</div>
              ${day.pace !== '-' ? `<div class="text-sm font-bold text-purple-600 mb-2">🎯 페이스: ${day.pace}</div>` : ''}
              
              <!-- 생리학적 효과 -->
              <div class="bg-white rounded-lg p-3 mb-3 border border-gray-200">
                <div class="text-xs font-semibold text-purple-700 mb-1">⚗️ 생리학적 효과</div>
                <div class="text-xs text-gray-700">${day.physiological}</div>
              </div>
              
              <!-- 회복 시간 -->
              <div class="flex items-center gap-2 text-xs text-gray-600 mb-2">
                <i class="fas fa-clock text-blue-500"></i>
                <span>예상 회복: ${day.recoveryTime}</span>
              </div>
            </div>
            <div class="text-center ml-4 min-w-[60px]">
              <div class="text-2xl font-bold text-blue-600 mb-1">${day.volume}km</div>
              <div class="text-xs text-gray-500">거리</div>
            </div>
          </div>
          
          <!-- 진행 상황 바 -->
          <div class="w-full bg-gray-200 rounded-full h-2 mb-2">
            <div class="bg-gradient-to-r from-blue-400 to-purple-500 h-2 rounded-full" style="width: ${Math.min(day.volume / 25 * 100, 100)}%"></div>
          </div>
        </div>
      `).join('');
      
      trainingCycle.innerHTML = `
        <div class="bg-gradient-to-r from-blue-50 to-purple-50 border border-blue-200 rounded-lg p-6 mb-6">
          <div class="flex items-center gap-3 mb-3">
            <i class="fas fa-microscope text-2xl text-purple-600"></i>
            <h3 class="text-xl font-bold text-gray-800">9-10일 주기화 과학</h3>
          </div>
          <div class="grid md:grid-cols-2 gap-4 text-sm text-gray-700">
            <div>
              <strong class="text-purple-700">생리학적 기반:</strong>
              <ul class="mt-2 space-y-1 text-xs">
                <li>• 근육 단백질 합성: 48-72시간</li>
                <li>• 미토콘드리아 적응: 72-96시간</li>
                <li>• 신경계 회복: 24-48시간</li>
              </ul>
            </div>
            <div>
              <strong class="text-purple-700">주기화 이점:</strong>
              <ul class="mt-2 space-y-1 text-xs">
                <li>• 부상 위험 30% 감소</li>
                <li>• 회복 효율성 25% 향상</li>
                <li>• 호르몬 균형 최적화</li>
              </ul>
            </div>
          </div>
        </div>
        
        <div class="mb-6">
          <div class="flex justify-between items-center mb-4">
            <h4 class="text-lg font-bold text-gray-800">🗓️ 9-10일 훈련 주기</h4>
            <div class="text-sm text-gray-600">
              <i class="fas fa-info-circle text-blue-500 mr-1"></i>
              Day 10: 선택적 회복일 (피로도 기반)
            </div>
          </div>
          
          <div class="grid gap-4">
            ${cycleHTML}
          </div>
        </div>
        
        <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 opacity-75 bg-gray-50">
          <div class="flex justify-between items-start">
            <div>
              <div class="font-bold text-lg mb-1 text-gray-600">Day 10: 선택적 회복</div>
              <div class="text-sm text-gray-600 mb-2">피로도 평가 후 결정</div>
              <div class="text-xs text-gray-500 mb-2">
                - HRV(심박변동성) 5% 이상 감소 시 필수<;br>
                - 주관적 피로도 7/10 이상 시 권장<;br>
                - 수면 품질 저하 시 필수
              </div>
              <div class="text-xs text-blue-600 font-semibold">💡 적응 지표: 다음 주기 준비도 95% 이상</div>
            </div>
            <div class="text-center">
              <i class="fas fa-question-circle text-gray-400 text-2xl mb-1"></i>
              <div class="text-xs font-semibold text-gray-500">선택</div>
            </div>
          </div>
        </div>
      `;
    }

    function generateMesocycle() {
      const mesocyclePlan = document.getElementById('mesocyclePlan');
      const phase = document.getElementById('trainingPhase').value;
      
      let weeks = [];
      
      switch(phase) {
        case 'base':
          weeks = [
            { week: '1주차', focus: '적응', volume: '70%', keyWorkout: 'Easy 런 위주, 주 2회 Fartlek' },
            { week: '2주차', focus: '볼륨 증가', volume: '85%', keyWorkout: 'Long Run 10% 증가, Tempo 도입' },
            { week: '3주차', focus: '강도 도입', volume: '100%', keyWorkout: 'Threshold 20분 x 2회, Long Run 유지' },
            { week: '4주차', focus: '회복', volume: '60%', keyWorkout: 'Easy 런 위주, 테스트 타임트라이얼' }
          ];
          break;
        case 'build':
          weeks = [
            { week: '1주차', focus: 'VO₂max', volume: '80%', keyWorkout: '800-1000m x 4-5 @ I pace, Tempo 25분' },
            { week: '2주차', focus: '젖산역치', volume: '90%', keyWorkout: 'Threshold 30분 연속, 400m x 8 @ R pace' },
            { week: '3주차', focus: '종합', volume: '100%', keyWorkout: '1200-1600m x 3-4 @ I pace, Long Run w/ M pace' },
            { week: '4주차', focus: '회복/테스트', volume: '70%', keyWorkout: '3-5km 테스트, Easy 런' }
          ];
          break;
        case 'peak':
          weeks = [
            { week: '1주차', focus: '레이스 시뮬레이션', volume: '90%', keyWorkout: '목표 거리 70-80% @ 목표 페이스' },
            { week: '2주차', focus: '스피드', volume: '80%', keyWorkout: '200-400m x 8-10 @ R pace, 짧은 Tempo' },
            { week: '3주차', focus: '레이스 준비', volume: '70%', keyWorkout: '목표 페이스 확인, 전략 점검' },
            { week: '4주차', focus: '대회', volume: '50%', keyWorkout: '대회 3일전부터 테이퍼링' }
          ];
          break;
        default:
          weeks = [
            { week: '1주차', focus: '기초', volume: '70%', keyWorkout: 'Easy 런 위주' },
            { week: '2주차', focus: '발전', volume: '85%', keyWorkout: '다양한 페이스 경험' },
            { week: '3주차', focus: '도전', volume: '100%', keyWorkout: '핵심 세션 집중' },
            { week: '4주차', focus: '회복', volume: '60%', keyWorkout: '다음 사이클 준비' }
          ];
      }
      
      mesocyclePlan.innerHTML = weeks.map((w, i) => `
        <div class="phase-card border-2 border-gray-200 rounded-lg p-4">
          <h4 class="font-bold text-lg mb-2">${w.week}</h4>
          <div class="text-sm text-gray-600 mb-2">
            <span class="font-semibold">초점:</span> ${w.focus}
          </div>
          <div class="text-sm text-gray-600 mb-2">
            <span class="font-semibold">볼륨:</span> ${w.volume}
          </div>
          <div class="text-xs text-gray-500">
            <span class="font-semibold">핵심훈련:</span> ${w.keyWorkout}
          </div>
        </div>
      `).join('');
    }

    // Show workout tab
    function showWorkoutTab(tab) {
      const templatesTab = document.getElementById('templatesTab');
      const customTab = document.getElementById('customTab');
      const templatesContent = document.getElementById('templatesContent');
      const customContent = document.getElementById('customContent');
      
      if (tab === 'templates') {
        templatesTab.classList.add('text-purple-600', 'border-b-2', 'border-purple-600');
        templatesTab.classList.remove('text-gray-600');
        customTab.classList.remove('text-purple-600', 'border-b-2', 'border-purple-600');
        customTab.classList.add('text-gray-600');
        templatesContent.classList.remove('hidden');
        customContent.classList.add('hidden');
      } else {
        customTab.classList.add('text-purple-600', 'border-b-2', 'border-purple-600');
        customTab.classList.remove('text-gray-600');
        templatesTab.classList.remove('text-purple-600', 'border-b-2', 'border-purple-600');
        templatesTab.classList.add('text-gray-600');
        customContent.classList.remove('hidden');
        templatesContent.classList.add('hidden');
      }
    }

    // Generate standard workout templates based on Jack Daniels' methodology
    function generateWorkoutTemplates(vdot, paces) {
      const templates = [
        // Easy/Recovery Workouts
        {
          type: 'Easy',
          name: 'Recovery Run',
          description: '회복 러닝',
          warmup: '5분 매우 천천히',
          main: '30-45분 @ Easy 페이스 하한',
          cooldown: '5분 천천히 + 스트레칭',
          pace: `${formatPace(paces.easy.max)}`,
          rpe: paces.easy.rpe,
          purpose: '적극적 회복, 혈류 증가'
        },
        {
          type: 'Easy',
          name: 'Easy Long Run',
          description: '편안한 장거리',
          warmup: '점진적 시작',
          main: '60-90분 @ Easy 페이스',
          cooldown: '10분 천천히',
          pace: `${formatPace(paces.easy.max)}-${formatPace(paces.easy.min)}`,
          rpe: paces.easy.rpe,
          purpose: '유산소 기초 구축'
        },
        
        // Marathon Pace Workouts
        {
          type: 'Marathon',
          name: 'Marathon Tempo',
          description: '마라톤 템포런',
          warmup: '20분 Easy',
          main: '5-10km @ Marathon 페이스',
          cooldown: '10분 Easy',
          pace: `${formatPace(paces.marathon.target || paces.marathon.min)}`,
          rpe: paces.marathon.rpe,
          purpose: '마라톤 페이스 적응'
        },
        {
          type: 'Marathon',
          name: 'Progressive Long Run',
          description: '점진적 장거리',
          warmup: '30분 Easy',
          main: '60분 Easy → 30분 Marathon 페이스',
          cooldown: '10분 Easy',
          pace: `E: ${formatPace(paces.easy.min)}, M: ${formatPace(paces.marathon.target || paces.marathon.min)}`,
          rpe: `${paces.easy.rpe} → ${paces.marathon.rpe}`,
          purpose: '지구력과 페이스 전환'
        },
        
        // Threshold Workouts
        {
          type: 'Threshold',
          name: 'Classic Tempo',
          description: '클래식 템포런',
          warmup: '15분 Easy + 스트라이드',
          main: '20분 @ Threshold 페이스',
          cooldown: '10분 Easy',
          pace: `${formatPace(paces.threshold.target || paces.threshold.min)}`,
          rpe: paces.threshold.rpe,
          purpose: '젖산역치 향상'
        },
        {
          type: 'Threshold',
          name: 'Cruise Intervals',
          description: '크루즈 인터벌',
          warmup: '15분 Easy',
          main: '3 x 10분 @ T 페이스 (회복 2분)',
          cooldown: '10분 Easy',
          pace: `${formatPace(paces.threshold.target || paces.threshold.min)}`,
          rpe: paces.threshold.rpe,
          purpose: '젖산 처리 능력 향상'
        },
        {
          type: 'Threshold',
          name: 'Broken Tempo',
          description: '브로큰 템포',
          warmup: '15분 Easy',
          main: '2 x 15분 @ T 페이스 (회복 1분)',
          cooldown: '10분 Easy',
          pace: `${formatPace(paces.threshold.max)}-${formatPace(paces.threshold.min)}`,
          rpe: paces.threshold.rpe,
          purpose: '템포 지속력 강화'
        },
        
        // Interval Workouts
        {
          type: 'Interval',
          name: '400m Intervals',
          description: '400m 인터벌',
          warmup: '20분 Easy + 4 x 100m 스트라이드',
          main: '8-10 x 400m @ I 페이스 (회복 2분)',
          cooldown: '15분 Easy',
          pace: `${formatPace(paces.interval.target || paces.interval.min)}`,
          rpe: paces.interval.rpe,
          purpose: 'VO2max 향상'
        },
        {
          type: 'Interval',
          name: '800m Intervals',
          description: '800m 인터벌',
          warmup: '20분 Easy + 드릴',
          main: '5-6 x 800m @ I 페이스 (회복 2-3분)',
          cooldown: '15분 Easy',
          pace: `${formatPace(paces.interval.max)}-${formatPace(paces.interval.min)}`,
          rpe: paces.interval.rpe,
          purpose: 'VO2max 지속력'
        },
        {
          type: 'Interval',
          name: '1000m Intervals',
          description: '1000m 인터벌',
          warmup: '20분 Easy',
          main: '4-5 x 1000m @ I 페이스 (회복 3분)',
          cooldown: '15분 Easy',
          pace: `${formatPace(paces.interval.target || paces.interval.min)}`,
          rpe: paces.interval.rpe,
          purpose: '유산소 파워 증대'
        },
        {
          type: 'Interval',
          name: 'Pyramid Intervals',
          description: '피라미드 인터벌',
          warmup: '20분 Easy',
          main: '400-800-1200-800-400m @ I 페이스 (회복 해당거리의 50% 시간)',
          cooldown: '15분 Easy',
          pace: `${formatPace(paces.interval.max)}-${formatPace(paces.interval.min)}`,
          rpe: paces.interval.rpe,
          purpose: '페이스 조절 능력'
        },
        
        // Repetition Workouts
        {
          type: 'Repetition',
          name: '200m Reps',
          description: '200m 반복훈련',
          warmup: '20분 Easy + 드릴',
          main: '8-10 x 200m @ R 페이스 (완전회복 2-3분)',
          cooldown: '15분 Easy',
          pace: `${formatPace(paces.repetition.target || paces.repetition.min)}`,
          rpe: paces.repetition.rpe,
          purpose: '스피드와 폼 개선'
        },
        {
          type: 'Repetition',
          name: '400m Reps',
          description: '400m 반복훈련',
          warmup: '20분 Easy + 스트라이드',
          main: '6 x 400m @ R 페이스 (완전회복 3-4분)',
          cooldown: '15분 Easy',
          pace: `${formatPace(paces.repetition.max)}-${formatPace(paces.repetition.min)}`,
          rpe: paces.repetition.rpe,
          purpose: '스피드 지구력'
        },
        
        // Mixed/Combination Workouts
        {
          type: 'Mixed',
          name: 'Fartlek',
          description: '파틀렉 훈련',
          warmup: '15분 Easy',
          main: '30-40분: 1-2-3-2-1분 빠르게 (각 사이 동일시간 Easy)',
          cooldown: '10분 Easy',
          pace: `빠른구간: T-I 페이스, 회복: E 페이스`,
          rpe: '변동 (4-9/10)',
          purpose: '다양한 에너지 시스템 자극'
        },
        {
          type: 'Mixed',
          name: 'Cutdown Run',
          description: '컷다운 런',
          warmup: '10분 Easy',
          main: '3 x 5분 (T → I → R 페이스, 각 사이 3분 Easy)',
          cooldown: '10분 Easy',
          pace: `T: ${formatPace(paces.threshold.target || paces.threshold.min)}, I: ${formatPace(paces.interval.target || paces.interval.min)}, R: ${formatPace(paces.repetition.target || paces.repetition.min)}`,
          rpe: '점진적 증가',
          purpose: '레이스 시뮬레이션'
        }
      ];
      
      return templates;
    }

    function generateWorkoutDetails(vdot, paces) {
      const workoutDetails = document.getElementById('workoutDetails');
      const experience = document.getElementById('experience').value;
      
      // Generate standard templates first
      const templates = generateWorkoutTemplates(vdot, paces);
      
      // Also generate experience-specific workouts
      let workouts = [];
      
      // Interval workout
      const intervalWorkout = {
        title: 'VO₂max 인터벌',
        warmup: '20분 Easy + 4x100m 스트라이드',
        main: experience === 'beginner' ? '400m x 6-8 @ I 페이스 (회복 2-3분)' :
              experience === 'intermediate' ? '800m x 5-6 @ I 페이스 (회복 2-3분)' :
              experience === 'advanced' ? '1000m x 5 @ I 페이스 (회복 2분)' :
              '1200-1600m x 4-5 @ I 페이스 (회복 90초)',
        cooldown: '15분 Easy + 스트레칭',
        tips: '일정한 페이스 유지, 마지막 반복까지 여유 있게',
        pace: `${formatPace(paces.interval.max)}-${formatPace(paces.interval.min)}`
      };
      
      // Threshold workout
      const thresholdWorkout = {
        title: '젖산역치 훈련',
        warmup: '15분 Easy + 동적 스트레칭',
        main: experience === 'beginner' ? '20분 연속 @ T 페이스' :
              experience === 'intermediate' ? '2 x 15분 @ T 페이스 (휴식 1분)' :
              experience === 'advanced' ? '30분 연속 @ T 페이스' :
              '2 x 20분 @ T 페이스 (휴식 1분)',
        cooldown: '10분 Easy',
        tips: '편안하게 힘든 정도, 짧은 문장 대화 가능',
        pace: `${formatPace(paces.threshold.max)}-${formatPace(paces.threshold.min)}`
      };
      
      // Long run workout
      const longRunWorkout = {
        title: '장거리 훈련',
        warmup: '천천히 시작',
        main: experience === 'beginner' ? '60-75분 @ E 페이스' :
              experience === 'intermediate' ? '90-105분 @ E/M 페이스' :
              experience === 'advanced' ? '105-120분, 마지막 20-30분 M 페이스' :
              '120-150분 Progressive (E→M→T)',
        cooldown: '5-10분 매우 천천히',
        tips: '수분과 에너지 보충, 일정한 페이스',
        pace: `${formatPace(paces.easy.max)}-${formatPace(paces.easy.min)}`
      };
      
      // Repetition workout
      const repetitionWorkout = {
        title: '스피드/폼 훈련',
        warmup: '20분 Easy + 드릴',
        main: experience === 'beginner' ? '200m x 6-8 @ R 페이스 (완전회복)' :
              experience === 'intermediate' ? '400m x 5-6 @ R 페이스 (완전회복)' :
              experience === 'advanced' ? '400m x 4 + 200m x 4 @ R 페이스' :
              '600m x 5-6 @ R 페이스 (완전회복)',
        cooldown: '15분 Easy',
        tips: '폼에 집중, 완전 회복 후 다음 반복',
        pace: `${formatPace(paces.repetition.max)}-${formatPace(paces.repetition.min)}`
      };
      
      workouts = [intervalWorkout, thresholdWorkout, longRunWorkout, repetitionWorkout];
      
      // Create tabs for templates and custom workouts
      workoutDetails.innerHTML = `
        <div class="mb-4 border-b">
          <button type="button" onclick="showWorkoutTab('templates')" id="templatesTab" class="px-4 py-2 font-semibold text-purple-600 border-b-2 border-purple-600">
            표준 템플릿 (${templates.length})
          </button>
          <button type="button" onclick="showWorkoutTab('custom')" id="customTab" class="px-4 py-2 font-semibold text-gray-600 hover:text-purple-600 ml-4">
            맞춤 훈련 (${workouts.length})
          </button>
        </div>
        
        <!-- Standard Templates -->
        <div id="templatesContent" class="grid gap-4">
          ${templates.map(t => `
            <div class="border rounded-lg p-4 hover:shadow-md transition-shadow ${
              t.type === 'Easy' ? 'border-green-300 bg-green-50' :
              t.type === 'Marathon' ? 'border-blue-300 bg-blue-50' :
              t.type === 'Threshold' ? 'border-yellow-300 bg-yellow-50' :
              t.type === 'Interval' ? 'border-red-300 bg-red-50' :
              t.type === 'Repetition' ? 'border-purple-300 bg-purple-50' :
              'border-gray-300 bg-gray-50'
            }">
              <div class="flex justify-between items-start mb-2">
                <h4 class="font-bold text-lg">${t.name}</h4>
                <span class="text-xs px-2 py-1 rounded-full ${
                  t.type === 'Easy' ? 'bg-green-200 text-green-800' :
                  t.type === 'Marathon' ? 'bg-blue-200 text-blue-800' :
                  t.type === 'Threshold' ? 'bg-yellow-200 text-yellow-800' :
                  t.type === 'Interval' ? 'bg-red-200 text-red-800' :
                  t.type === 'Repetition' ? 'bg-purple-200 text-purple-800' :
                  'bg-gray-200 text-gray-800'
                }">${t.type}</span>
              </div>
              <p class="text-sm text-gray-600 mb-3">${t.description}</p>
              <div class="space-y-2 text-sm">
                <div><span class="font-semibold">워밍업:</span> ${t.warmup}</div>
                <div><span class="font-semibold">메인:</span> ${t.main}</div>
                <div><span class="font-semibold">쿨다운:</span> ${t.cooldown}</div>
                <div class="flex justify-between items-center bg-white p-2 rounded">
                  <span><span class="font-semibold">페이스:</span> ${t.pace}</span>
                  <span class="text-xs">RPE: ${t.rpe}</span>
                </div>
                <div class="text-xs text-gray-600 italic">📌 ${t.purpose}</div>
              </div>
            </div>
          `).join('')}
        </div>
        
        <!-- Custom Workouts -->
        <div id="customContent" class="hidden grid gap-4">
          ${workouts.map(w => `
            <div class="border rounded-lg p-4">
              <h4 class="font-bold text-lg mb-3 text-purple-700">${w.title}</h4>
              <div class="space-y-2 text-sm">
                <div>
                  <span class="font-semibold">워밍업:</span> ${w.warmup}
                </div>
                <div>
                  <span class="font-semibold">메인세트:</span> ${w.main}
                </div>
                <div>
                  <span class="font-semibold">쿨다운:</span> ${w.cooldown}
                </div>
                <div class="bg-purple-50 p-2 rounded">
                  <span class="font-semibold">목표 페이스:</span> ${w.pace}
                </div>
                <div class="text-xs text-gray-600 italic">
                  💡 ${w.tips}
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    function generateRecommendations() {
      const recommendations = document.getElementById('recommendations');
      const recs = [];
      
      // Add 9-10 day periodization benefits
      recs.push({
        title: '9-10일 주기의 과학적 이점',
        items: [
          '근육 단백질 합성 주기(48-72시간)에 최적화',
          '미토콘드리아 적응 기간(72-96시간) 확보',
          '신경계 적응 시간(24-48시간) 충분히 확보',
          '호르몬 변화 주기(48-120시간) 활용',
          '초보상 효과로 더 큰 적응 유도',
          '7일보다 긴 회복으로 부상 위험 감소'
        ]
      });
      
      // VDOT-specific recommendations
      const vdot = userProfile.vdot;
      if (vdot >= 65) {
        recs.push({
          title: '엘리트 수준 권장사항',
          items: [
            '9일 주기로 고강도 세션 3회 배치',
            '이중 세션(오전/오후)으로 용량 증가',
            'HRV 기반 적응형 모니터링 사용',
            '고급 회복 기술 적극 활용',
            '9일 주기로 최적화된 훈련 계획'
          ]
        });
      } else if (vdot >= 45) {
        recs.push({
          title: '중급자 권장사항',
          items: [
            '10일 주기로 고강도 세션 2-3회',
            '단일 세션에 집중하여 기술 향상',
            '주 1-2회 교차 훈련 포함',
            '수면과 영양에 특별히 신경쓰기',
            '10일 주기로 최적화된 훈련 계획'
          ]
        });
      } else {
        recs.push({
          title: '초급자 권장사항',
          items: [
            '10일 주기로 고강도 세션 1-2회',
            '기술 학습에 집중',
            '충분한 회복',
            '점진적 용량 증가',
            '10일 주기로 최적화된 훈련 계획'
          ]
        });
      }
      
      // Experience-based adjustments
      const experience = userProfile.experience;
      switch(experience) {
        case 'beginner':
          recs.push({
            title: '초급자를 위한 조정',
            items: [
              '훈련량 70%로 시작하여 점진 증가',
              '강도 85%로 보수적 접근',
              '기술 학습에 30% 시간 할당',
              '매주 1회 완전 휴식일',
              '처음 2-3주는 적응기로 80% 적용'
            ]
          });
          break;
        case 'intermediate':
          recs.push({
            title: '중급자를 위한 조정',
            items: [
              '표준 훈련량으로 시작',
              '강도 100%로 정상 적용',
              '기술 개선에 20% 시간 할당',
              '10일마다 완전 회복일',
              '점진적 용량 증가 추구'
            ]
          });
          break;
        case 'advanced':
          recs.push({
            title: '고급자를 위한 조정',
            items: [
              '훈련량 105%로 증가',
              '강도 100%로 정상 적용',
              '고급 기술에 15% 시간 할당',
              '9일 주기로 최적화',
              '고급 기술과 전략에 집중'
            ]
          });
          break;
        case 'elite':
          recs.push({
            title: '엘리트를 위한 조정',
            items: [
              '훈련량 108%로 고강도',
              '강도 102%로 약간 증가',
              '고급 기술과 전략에 집중',
              '9일 주기로 최적화',
              'HRV 기반 적응형 모니터링'
            ]
          });
          break;
      }
      
      // Gender-specific (여성 VDOT 표시로 충분, 페이스 조정은 하지 않음)
      if (userProfile.gender === 'female') {
        recs.push({
          title: '여성 러너 권장사항',
          items: [
            '철분 수치 정기 체크 (페리틴 50ng/ml 이상 유지)',
            '월경 주기 고려한 훈련 강도 조절',
            '칼슘과 비타민 D 충분히 섭취',
            '골밀도 검사 연 1회'
          ]
        });
      }
      
      // Age-specific
      if (userProfile.ageGroup && userProfile.ageGroup.includes('master')) {
        recs.push({
          title: '마스터즈 러너 권장사항',
          items: [
            '회복 시간 1.5-2배 확보',
            '주 2회 이상 근력 운동 필수',
            '고강도 훈련 전 충분한 워밍업 (20분 이상)',
            '유연성 운동 매일 15분',
            '정기 건강검진 (심혈관계 포함)'
          ]
        });
      }
      
      // Training phase specific
      const phase = document.getElementById('trainingPhase').value;
      if (phase === 'base') {
        recs.push({
          title: '기초 체력기 권장사항',
          items: [
            '주간 마일리지 10% 이내 증가',
            '속도보다 시간/거리에 집중',
            '주 1-2회 크로스트레이닝',
            '코어 강화 운동 주 3회'
          ]
        });
      } else if (phase === 'peak' || phase === 'taper') {
        recs.push({
          title: '대회 준비 권장사항',
          items: [
            '새로운 장비나 음식 시도 금지',
            '충분한 수면 (8시간 이상)',
            '탄수화물 비중 60-70%로 증가',
            '대회 3일 전부터 카페인 섭취 제한',
            '레이스 페이스 시뮬레이션'
          ]
        });
      }
      
      // Condition-specific
      if (document.getElementById('injury_recovery').checked) {
        recs.push({
          title: '부상 회복 프로토콜',
          items: [
            'Pain Scale 3/10 이하에서만 훈련',
            '아이싱과 압박 매일 실시',
            '항염증 음식 섭취 (오메가-3, 강황)',
            '대체 운동으로 유산소 유지 (수영, 자전거)',
            '물리치료사 상담 권장'
          ]
        });
      }
      
      // General nutrition
      recs.push({
        title: '영양 섭취 가이드',
        items: [
          '훈련 전: 탄수화물 30-50g (1-2시간 전)',
          '훈련 중: 60분 이상 시 시간당 30-60g 탄수화물',
          '훈련 후 30분 내: 탄수화물:단백질 = 3:1 비율',
          '일일 수분 섭취: 체중(kg) x 35ml + 훈련 손실량',
          '전해질 보충: 나트륨 300-700mg/시간'
        ]
      });
      
      // Add comparison section
      recs.push({
        title: '9-10일 vs 7일 주기 비교',
        items: [
          '7일: 생리학적 리듬과 불일치, 충분한 회복 시간 부족',
          '7일: 피로 누적 가능성, 고강도 세션 제한',
          '9-10일: 생리학적 적응 최적화, 충분한 회복 시간 확보',
          '9-10일: 초보상 효과 극대화, 고강도 세션 증가',
          '결론: 9-10일 주기가 과학적으로 우수하고 효과적'
        ]
      });
      
      recommendations.innerHTML = recs.map(r => `
        <div class="border rounded-lg p-4 bg-gray-50 mb-4">
          <h4 class="font-bold mb-2 text-purple-700">
            <i class="fas fa-check-circle mr-2"></i>${r.title}
          </h4>
          <ul class="text-sm space-y-1">
            ${r.items.map(item => `<li class="flex items-start"><span class="text-purple-500 mr-2">•</span>${item}</li>`).join('')}
          </ul>
        </div>
      `).join('');
    }
      const recommendations = document.getElementById('recommendations');
      const recs = [];
      
      // Gender-specific (여성 VDOT 표시로 충분, 페이스 조정은 하지 않음)
      if (userProfile.gender === 'female') {
        recs.push({
          title: '여성 러너 권장사항',
          items: [
            '철분 수치 정기 체크 (페리틴 50ng/ml 이상 유지)',
            '월경 주기 고려한 훈련 강도 조절',
            '칼슘과 비타민 D 충분히 섭취',
            '골밀도 검사 연 1회'
          ]
        });
      }
      
      // Age-specific
      if (userProfile.ageGroup && userProfile.ageGroup.includes('master')) {
        recs.push({
          title: '마스터즈 러너 권장사항',
          items: [
            '회복 시간 1.5-2배 확보',
            '주 2회 이상 근력 운동 필수',
            '고강도 훈련 전 충분한 워밍업 (20분 이상)',
            '유연성 운동 매일 15분',
            '정기 건강검진 (심혈관계 포함)'
          ]
        });
      }
      
      // Training phase specific
      const phase = document.getElementById('trainingPhase').value;
      if (phase === 'base') {
        recs.push({
          title: '기초 체력기 권장사항',
          items: [
            '주간 마일리지 10% 이내 증가',
            '속도보다 시간/거리에 집중',
            '주 1-2회 크로스트레이닝',
            '코어 강화 운동 주 3회'
          ]
        });
      } else if (phase === 'peak' || phase === 'taper') {
        recs.push({
          title: '대회 준비 권장사항',
          items: [
            '새로운 장비나 음식 시도 금지',
            '충분한 수면 (8시간 이상)',
            '탄수화물 비중 60-70%로 증가',
            '대회 3일 전부터 카페인 섭취 제한',
            '레이스 페이스 시뮬레이션'
          ]
        });
      }
      
      // Condition-specific
      if (document.getElementById('injury_recovery').checked) {
        recs.push({
          title: '부상 회복 프로토콜',
          items: [
            'Pain Scale 3/10 이하에서만 훈련',
            '아이싱과 압박 매일 실시',
            '항염증 음식 섭취 (오메가-3, 강황)',
            '대체 운동으로 유산소 유지 (수영, 자전거)',
            '물리치료사 상담 권장'
          ]
        });
      }
      
      // General nutrition
      recs.push({
        title: '영양 섭취 가이드',
        items: [
          '훈련 전: 탄수화물 30-50g (1-2시간 전)',
          '훈련 중: 60분 이상 시 시간당 30-60g 탄수화물',
          '훈련 후 30분 내: 탄수화물:단백질 = 3:1 비율',
          '일일 수분 섭취: 체중(kg) x 35ml + 훈련 손실량',
          '전해질 보충: 나트륨 300-700mg/시간'
        ]
      });
      
      recommendations.innerHTML = recs.map(r => `
        <div class="border rounded-lg p-4 bg-gray-50">
          <h4 class="font-bold mb-2 text-purple-700">
            <i class="fas fa-check-circle mr-2"></i>${r.title}
          </h4>
          <ul class="text-sm space-y-1">
            ${r.items.map(item => `<li class="flex items-start"><span class="text-purple-500 mr-2">•</span>${item}</li>`).join('')}
          </ul>
        </div>
      `).join('');
    }

    // 전역 변수로 현재 VDOT와 페이스 저장
    let currentVDOT = 0;
    let currentPaces = null;
    let currentDistance = 0;
    let currentTotalSeconds = 0;

    function calculateTraining() {
      // Get user inputs
      const distance = parseFloat(document.getElementById('eventDistance').value);
      const hours = parseInt(document.getElementById('hours').value) || 0;
      const minutes = parseInt(document.getElementById('minutes').value) || 0;
      const seconds = parseFloat(document.getElementById('seconds').value) || 0;
      
      if (!distance || (hours === 0 && minutes === 0 && seconds === 0)) {
        alert('종목과 기록을 입력해주세요.');
        return;
      }
      
      if (!userProfile.gender) {
        alert('성별을 선택해주세요.');
        return;
      }
      
      // 전역 변수에 저장
      currentDistance = distance;
      currentTotalSeconds = hours * 3600 + minutes * 60 + seconds;
      
      // Update profile
      userProfile.ageGroup = document.getElementById('ageGroup').value;
      userProfile.experience = document.getElementById('experience').value;
      userProfile.weeklyVolume = document.getElementById('weeklyVolume').value;
      userProfile.frequency = document.getElementById('frequency').value;
      userProfile.trainingPhase = document.getElementById('trainingPhase').value;
      
      // Calculate adjustments
      calculateAdjustments();
      
      // Calculate VDOT using exact Daniels-Gilbert formula
      currentVDOT = calculateExactVDOT(currentDistance, currentTotalSeconds);
      
      // 여성의 경우 VDOT 표시만 조정 (페이스 계산은 실제 VDOT 사용)
      const displayVDOT = userProfile.gender === 'female' ? currentVDOT * 0.88 : currentVDOT;
      
      // Display VDOT
      document.getElementById('vdotScore').textContent = displayVDOT.toFixed(1);
      document.getElementById('performanceLevel').textContent = getPerformanceLevel(displayVDOT);
      document.getElementById('predictedVO2max').textContent = (displayVDOT * 1.05).toFixed(1);
      
      if (userProfile.gender === 'female') {
        document.getElementById('vdotAdjustment').textContent = '여성 보정 적용 (실제 VDOT: ' + currentVDOT.toFixed(1) + ')';
      } else {
        document.getElementById('vdotAdjustment').textContent = '';
      }
      
      // Calculate training paces using actual VDOT
      currentPaces = calculateTrainingPaces(currentVDOT);
      
      // Display paces with fine-tuning applied
      updatePaceDisplay();
      
      // 보정값 표시
      displayAdjustmentSummary();
      
      // Generate training plans
      generate9DayTrainingCycle(currentVDOT, currentPaces);
      generateMesocycle();
      generateWorkoutDetails(currentVDOT, currentPaces);
      generateRecommendations();
      
      // Show results
      document.getElementById('resultsSection').classList.remove('hidden');
      document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
    }

    // 실시간 업데이트 함수
    function realtimeUpdateTraining() {
      if (!currentVDOT || !currentPaces) return;
      
      // 페이스 디스플레이 업데이트
      updatePaceDisplay();
      
      // 9일 주기 재생성
      generate9DayTrainingCycle(currentVDOT, currentPaces);
      
      // 운동 세부사항 재생성
      generateWorkoutDetails(currentVDOT, currentPaces);
      
      // 보정값 표시 업데이트
      displayAdjustmentSummary();
    }

    // 페이스 표시 업데이트 함수 (범위 및 설명 포함)
    function updatePaceDisplay() {
      if (!currentPaces) return;
      
      // 미세 조정 적용된 페이스 계산
      const adjustedPaces = {
        easy: {
          min: currentPaces.easy.min * fineTuneAdjustments.pace,
          max: currentPaces.easy.max * fineTuneAdjustments.pace,
          rpe: currentPaces.easy.rpe,
          description: currentPaces.easy.description
        },
        marathon: {
          min: currentPaces.marathon.min * fineTuneAdjustments.pace,
          max: currentPaces.marathon.max * fineTuneAdjustments.pace,
          target: currentPaces.marathon.target * fineTuneAdjustments.pace,
          rpe: currentPaces.marathon.rpe,
          description: currentPaces.marathon.description
        },
        threshold: {
          min: currentPaces.threshold.min * fineTuneAdjustments.pace,
          max: currentPaces.threshold.max * fineTuneAdjustments.pace,
          target: currentPaces.threshold.target * fineTuneAdjustments.pace,
          rpe: currentPaces.threshold.rpe,
          description: currentPaces.threshold.description
        },
        interval: {
          min: currentPaces.interval.min * fineTuneAdjustments.pace,
          max: currentPaces.interval.max * fineTuneAdjustments.pace,
          target: currentPaces.interval.target * fineTuneAdjustments.pace,
          rpe: currentPaces.interval.rpe,
          description: currentPaces.interval.description
        },
        repetition: {
          min: currentPaces.repetition.min * fineTuneAdjustments.pace,
          max: currentPaces.repetition.max * fineTuneAdjustments.pace,
          target: currentPaces.repetition.target * fineTuneAdjustments.pace,
          rpe: currentPaces.repetition.rpe,
          description: currentPaces.repetition.description
        }
      };
      
      // Display updated paces with ranges
      // Easy
      document.getElementById('easyPace').textContent = 
        `${formatPace(adjustedPaces.easy.max)} - ${formatPace(adjustedPaces.easy.min)}`;
      if (document.getElementById('easyRPE')) {
        document.getElementById('easyRPE').textContent = adjustedPaces.easy.rpe;
        document.getElementById('easyDesc').textContent = adjustedPaces.easy.description;
      }
      
      // Marathon
      document.getElementById('marathonPace').textContent = 
        `${formatPace(adjustedPaces.marathon.max)} - ${formatPace(adjustedPaces.marathon.min)}`;
      if (document.getElementById('marathonTarget')) {
        document.getElementById('marathonTarget').textContent = `추천: ${formatPace(adjustedPaces.marathon.target)}`;
        document.getElementById('marathonRPE').textContent = adjustedPaces.marathon.rpe;
        document.getElementById('marathonDesc').textContent = adjustedPaces.marathon.description;
      }
      
      // Threshold
      document.getElementById('thresholdPace').textContent = 
        `${formatPace(adjustedPaces.threshold.max)} - ${formatPace(adjustedPaces.threshold.min)}`;
      if (document.getElementById('thresholdTarget')) {
        document.getElementById('thresholdTarget').textContent = `추천: ${formatPace(adjustedPaces.threshold.target)}`;
        document.getElementById('thresholdRPE').textContent = adjustedPaces.threshold.rpe;
        document.getElementById('thresholdDesc').textContent = adjustedPaces.threshold.description;
      }
      
      // Interval
      document.getElementById('intervalPace').textContent = 
        `${formatPace(adjustedPaces.interval.max)} - ${formatPace(adjustedPaces.interval.min)}`;
      if (document.getElementById('intervalTarget')) {
        document.getElementById('intervalTarget').textContent = `추천: ${formatPace(adjustedPaces.interval.target)}`;
        document.getElementById('intervalRPE').textContent = adjustedPaces.interval.rpe;
        document.getElementById('intervalDesc').textContent = adjustedPaces.interval.description;
      }
      
      // Repetition
      document.getElementById('repetitionPace').textContent = 
        `${formatPace(adjustedPaces.repetition.max)} - ${formatPace(adjustedPaces.repetition.min)}`;
      if (document.getElementById('repetitionTarget')) {
        document.getElementById('repetitionTarget').textContent = `추천: ${formatPace(adjustedPaces.repetition.target)}`;
        document.getElementById('repetitionRPE').textContent = adjustedPaces.repetition.rpe;
        document.getElementById('repetitionDesc').textContent = adjustedPaces.repetition.description;
      }
    }
    
    // 보정값 요약 표시
    function displayAdjustmentSummary() {
      const adj = userProfile.adjustments;
      const conditionEmoji = userAdjustments.condition >= 5 ? '😄' : 
                            userAdjustments.condition >= 0 ? '😊' : 
                            userAdjustments.condition >= -10 ? '😔' : '😫';
      
      let summaryHtml = `
        <div class="bg-gradient-to-r from-purple-50 to-blue-50 border-l-4 border-purple-400 p-4 rounded-lg mt-4">
          <h4 class="font-bold mb-2 flex items-center">
            <span class="text-xl mr-2">${conditionEmoji}</span>
            적용된 맞춤 보정
          </h4>
          <div class="grid md:grid-cols-3 gap-3 text-sm">
            <div class="flex items-center">
              <span class="text-2xl mr-2">🏃</span>
              <div>
                <div class="font-medium">페이스 조정</div>
                <div class="text-gray-600">${((adj.pace - 1) * 100).toFixed(0) > 0 ? '+' : ''}${((adj.pace - 1) * 100).toFixed(0)}%</div>
              </div>
            </div>
            <div class="flex items-center">
              <span class="text-2xl mr-2">📏</span>
              <div>
                <div class="font-medium">훈련량 조정</div>
                <div class="text-gray-600">${((adj.volume - 1) * 100).toFixed(0) > 0 ? '+' : ''}${((adj.volume - 1) * 100).toFixed(0)}%</div>
              </div>
            </div>
            <div class="flex items-center">
              <span class="text-2xl mr-2">💪</span>
              <div>
                <div class="font-medium">강도 조정</div>
                <div class="text-gray-600">${((adj.intensity - 1) * 100).toFixed(0) > 0 ? '+' : ''}${((adj.intensity - 1) * 100).toFixed(0)}%</div>
              </div>
            </div>
          </div>
          ${(adj.pace > 1.1 || adj.volume < 0.7 || userAdjustments.specials.includes('injury')) ? 
            `<div class="mt-3 text-sm text-orange-600 flex items-center">
              <span class="text-lg mr-2">⚠️</span>
              보정값이 크게 적용되었습니다. 몸 상태를 주의 깊게 관찰하며 훈련하세요!
            </div>` : ''}
          ${userAdjustments.specials.length > 0 ? 
            `<div class="mt-2 text-xs text-gray-600">
              특별 상황: ${userAdjustments.specials.map(s => {
                const specialEmoji = {
                  'sleep': '😴',
                  'muscle': '💪',
                  'weather': '🌧️',
                  'stress': '😰',
                  'race-soon': '🏁',
                  'injury': '🤕',
                  'dehydration': '💧',
                  'mental': '🧠',
                  'altitude': '⛰️'
                };
                return specialEmoji[s] || '';
              }).join(' ')}
            </div>` : ''}
        </div>
      `;
      
      // VDOT 결과 섹션 바로 아래에 추가
      const vdotSection = document.querySelector('#resultsSection .bg-white');
      const existingSummary = vdotSection.querySelector('.adjustment-summary');
      if (existingSummary) {
        existingSummary.remove();
      }
      
      const summaryDiv = document.createElement('div');
      summaryDiv.className = 'adjustment-summary';
      summaryDiv.innerHTML = summaryHtml;
      
      // VDOT 점수 카드 다음에 삽입
      const vdotCards = vdotSection.querySelector('.grid');
      if (vdotCards && vdotCards.nextSibling) {
        vdotSection.insertBefore(summaryDiv, vdotCards.nextSibling);
      } else {
        vdotSection.appendChild(summaryDiv);
      }
    }

    // 빠른 도움말 표시
    function showQuickHelp() {
      const helpModal = document.createElement('div');
      helpModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
      helpModal.innerHTML = `
        <div class="bg-white rounded-xl max-w-2xl w-full max-h-[80vh] overflow-y-auto p-6">
          <div class="flex justify-between items-start mb-4">
            <h3 class="text-xl font-bold text-purple-700">
              <i class="fas fa-info-circle mr-2"></i>시스템 사용 안내
            </h3>
            <button type="button" onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>
          
          <div class="space-y-4 text-sm">
            <div class="bg-blue-50 border-l-4 border-blue-500 p-3">
              <h4 class="font-bold mb-2">🎯 정확한 VDOT 계산</h4>
              <p>Daniels-Gilbert 공식을 사용하여 ±0.1 VDOT 정확도를 제공합니다.</p>
            </div>
            
            <div class="bg-green-50 border-l-4 border-green-500 p-3">
              <h4 class="font-bold mb-2">🎚️ 실시간 미세 조정</h4>
              <p>슬라이더를 드래그하면 즉시 모든 페이스가 재계산됩니다.</p>
              <ul class="mt-2 space-y-1 text-xs">
                <li>• 페이스: 85-115% (0.5% 단위)</li>
                <li>• 훈련량: 60-140% (1% 단위)</li>
                <li>• 강도: 70-130% (0.5% 단위)</li>
              </ul>
            </div>
            
            <div class="bg-purple-50 border-l-4 border-purple-500 p-3">
              <h4 class="font-bold mb-2">📅 9-10일 훈련 주기</h4>
              <p>생물학적 초보상을 고려한 최적 주기입니다.</p>
              <p class="text-xs mt-1">72-96시간 회복으로 부상 위험 30% 감소</p>
            </div>
            
            <div class="bg-yellow-50 border-l-4 border-yellow-500 p-3">
              <h4 class="font-bold mb-2">📊 자세한 기술 정보</h4>
              <a href="system-documentation.html" class="text-blue-600 hover:underline">
                → 전체 기술 문서 보기
              </a>
            </div>
          </div>
          
          <div class="mt-6 text-center">
            <button type="button" onclick="this.closest('.fixed').remove()" 
              class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg transition">
              확인
            </button>
          </div>
        </div>
      `;
      // Find the proper container instead of body
      const mainContent = document.querySelector('.main-content-wrapper') || document.body;
      mainContent.appendChild(helpModal);
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
      // Set default values
      document.getElementById('ageGroup').value = 'senior';
      document.getElementById('experience').value = 'intermediate';
      document.getElementById('weeklyVolume').value = 'moderate';
      document.getElementById('frequency').value = '5-6';
      document.getElementById('trainingPhase').value = 'build';
      
      // 미세 조정 초기화
      resetFineTuning();
      
      // 첫 방문자를 위한 안내 (localStorage 체크)
      if (!(function() { try { return localStorage.getItem('trainingCalcVisited'); } catch(e) { console.error('Storage error:', e); return null; } })()) {
        (function() { try { return localStorage.setItem('trainingCalcVisited', 'true'); } catch(e) { console.error('Storage error:', e); return null; } })();
        setTimeout(() => {
          const infoBtn = document.createElement('div');
          infoBtn.className = 'fixed bottom-4 right-4 bg-purple-600 text-white px-4 py-2 rounded-full shadow-lg cursor-pointer hover:bg-purple-700 transition animate-pulse';
          infoBtn.innerHTML = '<i class="fas fa-book mr-2"></i>기술 문서 확인하기';
          infoBtn.onclick = () => {
            window.location.href = 'system-documentation.html';
          };
          // Find the proper container instead of body
          const mainContent = document.querySelector('.main-content-wrapper') || document.body;
          mainContent.appendChild(infoBtn);
          
          setTimeout(() => infoBtn.remove(), 10000);
        }, 2000);
      }
    });
  </script>
  
  <!-- PWA 등록 스크립트 -->
  <script src="/install-ui-patch.js"></script>
  <script src="/pwa-register.js"></script>
</body>
</html>
