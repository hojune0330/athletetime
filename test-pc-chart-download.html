<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PC ì°¨íŠ¸ ë‹¤ìš´ë¡œë“œ í…ŒìŠ¤íŠ¸</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-gray-100 p-4">
  <div class="max-w-4xl mx-auto">
    <h1 class="text-2xl font-bold mb-6">PC ì°¨íŠ¸ ë‹¤ìš´ë¡œë“œ ë°©ì‹ í…ŒìŠ¤íŠ¸</h1>
    
    <!-- í…ŒìŠ¤íŠ¸ ì„¤ëª… -->
    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
      <h2 class="font-bold text-lg mb-2">ğŸ¯ í…ŒìŠ¤íŠ¸ ëª©ì </h2>
      <p class="text-sm text-gray-700">
        ëª¨ë°”ì¼ í˜ì´ì§€ì—ì„œ PC ë²„ì „ì˜ ì°¨íŠ¸ë¥¼ ì§ì ‘ ê°€ì ¸ì™€ì„œ ë‹¤ìš´ë¡œë“œí•˜ëŠ” ê¸°ëŠ¥ì„ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.
        <br><br>
        <strong>í•µì‹¬:</strong> ëª¨ë°”ì¼ì—ì„œ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ì„ í´ë¦­í•˜ë©´, ìˆ¨ê²¨ì§„ iframeìœ¼ë¡œ ë¡œë“œëœ PC í˜ì´ì§€ì˜ ì°¨íŠ¸ë¥¼ ê·¸ëŒ€ë¡œ ê°€ì ¸ì™€ì„œ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤.
      </p>
    </div>
    
    <!-- PC iframe (ìˆ¨ê¹€) -->
    <iframe id="pc-frame" src="pace-calculator.html" style="display: none;"></iframe>
    
    <!-- ë¡œë”© í‘œì‹œ -->
    <div id="loading" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white p-6 rounded-lg">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto"></div>
        <p class="mt-4 text-center">PC ì°¨íŠ¸ ìƒì„± ì¤‘...</p>
      </div>
    </div>
    
    <!-- í…ŒìŠ¤íŠ¸ ë²„íŠ¼ë“¤ -->
    <div class="grid grid-cols-2 gap-4 mb-6">
      <button onclick="testDownloadPCChart('chart1', 'png')" 
              class="bg-blue-500 text-white p-4 rounded-lg hover:bg-blue-600">
        <i class="fas fa-image mr-2"></i>
        ì°¨íŠ¸1 PNG ë‹¤ìš´ë¡œë“œ
        <br><span class="text-xs">(í‚¬ë¡œë¯¸í„° í˜ì´ìŠ¤)</span>
      </button>
      
      <button onclick="testDownloadPCChart('chart1', 'pdf')" 
              class="bg-red-500 text-white p-4 rounded-lg hover:bg-red-600">
        <i class="fas fa-file-pdf mr-2"></i>
        ì°¨íŠ¸1 PDF ë‹¤ìš´ë¡œë“œ
        <br><span class="text-xs">(í‚¬ë¡œë¯¸í„° í˜ì´ìŠ¤)</span>
      </button>
      
      <button onclick="testDownloadPCChart('chart2', 'png')" 
              class="bg-green-500 text-white p-4 rounded-lg hover:bg-green-600">
        <i class="fas fa-image mr-2"></i>
        ì°¨íŠ¸2 PNG ë‹¤ìš´ë¡œë“œ
        <br><span class="text-xs">(ëª©í‘œ ê¸°ë¡ë³„)</span>
      </button>
      
      <button onclick="testDownloadPCChart('chart4', 'png')" 
              class="bg-purple-500 text-white p-4 rounded-lg hover:bg-purple-600">
        <i class="fas fa-water mr-2"></i>
        ì°¨íŠ¸4 PNG ë‹¤ìš´ë¡œë“œ
        <br><span class="text-xs">(3000m ì¥ì• ë¬¼)</span>
      </button>
    </div>
    
    <!-- ê²°ê³¼ í‘œì‹œ -->
    <div id="result" class="bg-white p-4 rounded-lg shadow">
      <h3 class="font-bold mb-2">í…ŒìŠ¤íŠ¸ ê²°ê³¼:</h3>
      <div id="resultContent" class="text-sm text-gray-600">
        ì•„ì§ í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.
      </div>
    </div>
    
    <!-- ì‹¤ì œ í˜ì´ì§€ ë§í¬ -->
    <div class="mt-6 space-y-2">
      <a href="pace-calculator-mobile.html" 
         class="block bg-indigo-500 text-white p-3 rounded-lg text-center hover:bg-indigo-600">
        <i class="fas fa-mobile-alt mr-2"></i>
        ìˆ˜ì •ëœ ëª¨ë°”ì¼ í˜ì´ìŠ¤ ê³„ì‚°ê¸° ì—´ê¸°
      </a>
      <a href="pace-calculator.html" 
         class="block bg-gray-500 text-white p-3 rounded-lg text-center hover:bg-gray-600">
        <i class="fas fa-desktop mr-2"></i>
        PC í˜ì´ìŠ¤ ê³„ì‚°ê¸° ì—´ê¸°
      </a>
    </div>
  </div>
  
  <script>
    async function testDownloadPCChart(chartId, format) {
      const loading = document.getElementById('loading');
      const resultContent = document.getElementById('resultContent');
      const pcFrame = document.getElementById('pc-frame');
      
      try {
        // ë¡œë”© í‘œì‹œ
        loading.classList.remove('hidden');
        resultContent.innerHTML = `<span class="text-blue-500">ë‹¤ìš´ë¡œë“œ ì‹œì‘: ${chartId} (${format})</span>`;
        
        // iframe ë¡œë“œ ëŒ€ê¸°
        await new Promise((resolve) => {
          if (pcFrame.contentDocument?.readyState === 'complete') {
            resolve();
          } else {
            pcFrame.onload = resolve;
            setTimeout(resolve, 2000); // íƒ€ì„ì•„ì›ƒ
          }
        });
        
        // PC ë¬¸ì„œ ì ‘ê·¼
        const pcDoc = pcFrame.contentDocument;
        const pcWin = pcFrame.contentWindow;
        
        // ë°©ë²• 1: PC í˜ì´ì§€ì˜ downloadChart í•¨ìˆ˜ ì§ì ‘ í˜¸ì¶œ
        if (pcWin && typeof pcWin.downloadChart === 'function') {
          resultContent.innerHTML += '<br>âœ… PCì˜ downloadChart í•¨ìˆ˜ ë°œê²¬';
          
          const timestamp = new Date().toISOString().slice(0,10).replace(/-/g, '');
          const filename = `í…ŒìŠ¤íŠ¸_${chartId}`;
          
          await pcWin.downloadChart(chartId, filename, format);
          resultContent.innerHTML += `<br><span class="text-green-500">âœ… ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!</span>`;
        } else {
          // ë°©ë²• 2: ì°¨íŠ¸ ìš”ì†Œ ì§ì ‘ ë³µì‚¬
          resultContent.innerHTML += '<br>âš ï¸ downloadChart í•¨ìˆ˜ ì—†ìŒ, ì§ì ‘ ë³µì‚¬ ì‹œë„';
          
          const chartElement = pcDoc.getElementById(chartId);
          if (!chartElement) {
            throw new Error('ì°¨íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
          }
          
          // ì°¨íŠ¸ ë³µì‚¬ ë° ë‹¤ìš´ë¡œë“œ
          await downloadChartDirect(chartElement, chartId, format);
          resultContent.innerHTML += `<br><span class="text-green-500">âœ… ì§ì ‘ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!</span>`;
        }
        
      } catch (error) {
        console.error('ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨:', error);
        resultContent.innerHTML += `<br><span class="text-red-500">âŒ ì˜¤ë¥˜: ${error.message}</span>`;
      } finally {
        loading.classList.add('hidden');
      }
    }
    
    async function downloadChartDirect(chartElement, chartId, format) {
      const timestamp = new Date().toISOString().slice(0,10).replace(/-/g, '');
      const filename = `AthleteTime_ì¥í˜¸ì¤€ì½”ì¹˜ì œì‘_${chartId}_${timestamp}`;
      
      // ì»¨í…Œì´ë„ˆ ìƒì„±
      const container = document.createElement('div');
      container.style.cssText = 'position: absolute; left: -9999px; width: 1200px; background: white; padding: 40px;';
      
      // ì°¨íŠ¸ ë³µì‚¬
      const clone = document.importNode(chartElement, true);
      clone.querySelectorAll('.download-btn, .no-print').forEach(el => el.remove());
      container.appendChild(clone);
      
      document.body.appendChild(container);
      
      try {
        const canvas = await html2canvas(container, {
          scale: 2,
          backgroundColor: '#ffffff'
        });
        
        if (format === 'png') {
          canvas.toBlob(blob => {
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.download = filename + '.png';
            link.href = url;
            link.click();
            URL.revokeObjectURL(url);
          });
        } else if (format === 'pdf') {
          const { jsPDF } = window.jspdf;
          const pdf = new jsPDF('l', 'mm', 'a4');
          const dataUrl = canvas.toDataURL('image/png');
          pdf.addImage(dataUrl, 'PNG', 10, 10, 277, 190);
          pdf.save(filename + '.pdf');
        }
      } finally {
        document.body.removeChild(container);
      }
    }
  </script>
</body>
</html>