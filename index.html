<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>애슬리트 타임 - 러닝 커뮤니티 & 페이스 계산기</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Malgun Gothic', sans-serif;
      background: #0a0a0a;
      color: #ffffff;
      min-height: 100vh;
    }
    
    /* 그라디언트 배경 */
    .hero-gradient {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      background-size: 200% 200%;
      animation: gradient 15s ease infinite;
    }
    
    @keyframes gradient {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    
    /* 글라스모피즘 효과 */
    .glass {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .glass-dark {
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    /* 네온 효과 */
    .neon-text {
      text-shadow: 0 0 10px rgba(102, 126, 234, 0.8),
                   0 0 20px rgba(102, 126, 234, 0.6),
                   0 0 30px rgba(102, 126, 234, 0.4);
    }
    
    .neon-border {
      box-shadow: 0 0 20px rgba(102, 126, 234, 0.5),
                  inset 0 0 20px rgba(102, 126, 234, 0.1);
    }
    
    /* 채팅 패널 */
    .chat-panel {
      position: fixed;
      right: 0;
      top: 0;
      width: 380px;
      height: 100vh;
      background: rgba(10, 10, 10, 0.95);
      backdrop-filter: blur(20px);
      border-left: 1px solid rgba(102, 126, 234, 0.3);
      transform: translateX(100%);
      transition: transform 0.3s ease-out;
      z-index: 1000;
      display: flex;
      flex-direction: column;
    }
    
    .chat-panel.active {
      transform: translateX(0);
    }
    
    .chat-header {
      background: linear-gradient(135deg, #667eea, #764ba2);
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background: #0a0a0a;
    }
    
    .chat-message {
      margin-bottom: 15px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      position: relative;
      animation: fadeInUp 0.3s ease-out;
    }
    
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .chat-message.own {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.2));
      margin-left: 50px;
    }
    
    .chat-message.activity {
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(16, 185, 129, 0.1));
      border-left: 3px solid #22c55e;
    }
    
    .chat-username {
      font-weight: bold;
      color: #667eea;
      font-size: 14px;
      margin-bottom: 4px;
    }
    
    .chat-text {
      color: #e0e0e0;
      font-size: 14px;
      line-height: 1.5;
    }
    
    .chat-time {
      font-size: 11px;
      color: #666;
      margin-top: 4px;
    }
    
    .chat-input-container {
      padding: 20px;
      background: rgba(20, 20, 20, 0.95);
      border-top: 1px solid rgba(102, 126, 234, 0.3);
    }
    
    .chat-input {
      display: flex;
      gap: 10px;
    }
    
    .chat-input input {
      flex: 1;
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(102, 126, 234, 0.3);
      border-radius: 25px;
      color: white;
      font-size: 14px;
      outline: none;
      transition: all 0.3s;
    }
    
    .chat-input input:focus {
      border-color: #667eea;
      background: rgba(255, 255, 255, 0.08);
    }
    
    .chat-input button {
      padding: 12px 24px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
    }
    
    .chat-input button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }
    
    /* 플로팅 채팅 버튼 */
    .chat-toggle {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 999;
      transition: all 0.3s;
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }
    
    .chat-toggle:hover {
      transform: scale(1.1);
    }
    
    .chat-toggle.active {
      right: 400px;
    }
    
    .notification-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: #ef4444;
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
    }
    
    /* 실시간 활동 피드 */
    .activity-feed {
      position: fixed;
      left: 30px;
      bottom: 30px;
      width: 300px;
      max-height: 200px;
      background: rgba(20, 20, 20, 0.9);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(102, 126, 234, 0.3);
      border-radius: 16px;
      padding: 15px;
      overflow: hidden;
    }
    
    .activity-item {
      padding: 8px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      animation: slideInLeft 0.5s ease-out;
      font-size: 13px;
      color: #a0a0a0;
    }
    
    @keyframes slideInLeft {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    /* 메인 컨텐츠 */
    .main-container {
      padding-right: 0;
      transition: padding-right 0.3s ease-out;
    }
    
    .main-container.chat-open {
      padding-right: 380px;
    }
    
    /* 퀵 액션 카드 */
    .quick-action {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(102, 126, 234, 0.3);
      border-radius: 16px;
      padding: 24px;
      transition: all 0.3s;
      cursor: pointer;
    }
    
    .quick-action:hover {
      transform: translateY(-5px);
      background: rgba(255, 255, 255, 0.08);
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
    }
    
    /* 실시간 통계 */
    .stat-card {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
      border: 1px solid rgba(102, 126, 234, 0.3);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }
    
    .stat-number {
      font-size: 32px;
      font-weight: bold;
      background: linear-gradient(135deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .stat-label {
      color: #999;
      font-size: 14px;
      margin-top: 5px;
    }
    
    /* 반응형 */
    @media (max-width: 768px) {
      .chat-panel {
        width: 100%;
      }
      
      .main-container.chat-open {
        padding-right: 0;
        transform: scale(0.9);
        opacity: 0.3;
      }
      
      .chat-toggle.active {
        right: 30px;
      }
      
      .activity-feed {
        display: none;
      }
    }
  </style>
</head>
<body>
  <!-- 메인 컨테이너 -->
  <div class="main-container" id="mainContainer">
    <!-- 히어로 섹션 -->
    <div class="hero-gradient min-h-screen">
      <nav class="glass-dark">
        <div class="container mx-auto px-6 py-4">
          <div class="flex justify-between items-center">
            <div class="flex items-center space-x-2">
              <i class="fas fa-running text-2xl"></i>
              <span class="text-xl font-bold neon-text">애슬리트 타임</span>
            </div>
            <div class="flex space-x-6">
              <a href="pace-calculator.html" class="hover:text-purple-400 transition">페이스 계산기</a>
              <a href="chat-websocket.html" class="hover:text-purple-400 transition">채팅</a>
              <a href="community.html" class="hover:text-purple-400 transition">커뮤니티</a>
            </div>
          </div>
        </div>
      </nav>
      
      <div class="container mx-auto px-6 py-20">
        <div class="text-center mb-16">
          <h1 class="text-6xl font-bold mb-6 neon-text">러너들의 실시간 공간</h1>
          <p class="text-xl text-gray-300">페이스 계산, 실시간 채팅, 커뮤니티가 하나로</p>
        </div>
        
        <!-- 실시간 통계 -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-12">
          <div class="stat-card">
            <div class="stat-number" id="onlineCount">0</div>
            <div class="stat-label">온라인 러너</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="messageCount">0</div>
            <div class="stat-label">오늘의 메시지</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="calculationCount">0</div>
            <div class="stat-label">페이스 계산</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="activeRooms">3</div>
            <div class="stat-label">활성 채널</div>
          </div>
        </div>
        
        <!-- 퀵 액션 -->
        <div class="grid md:grid-cols-3 gap-6">
          <a href="pace-calculator.html" class="quick-action">
            <div class="flex items-center mb-4">
              <i class="fas fa-calculator text-3xl text-purple-400 mr-4"></i>
              <h3 class="text-xl font-bold">페이스 계산기</h3>
            </div>
            <p class="text-gray-400">목표 시간과 거리로 페이스를 계산하고 스플릿 차트를 생성하세요</p>
            <div class="mt-4 flex items-center text-sm text-green-400">
              <i class="fas fa-circle text-xs mr-2"></i>
              <span id="calcActive">12명 사용 중</span>
            </div>
          </a>
          
          <div class="quick-action" onclick="toggleChat()">
            <div class="flex items-center mb-4">
              <i class="fas fa-comments text-3xl text-purple-400 mr-4"></i>
              <h3 class="text-xl font-bold">실시간 채팅</h3>
            </div>
            <p class="text-gray-400">다른 러너들과 실시간으로 대화하고 정보를 공유하세요</p>
            <div class="mt-4 flex items-center text-sm text-green-400">
              <i class="fas fa-circle text-xs mr-2"></i>
              <span id="chatActive">채팅 활성화</span>
            </div>
          </div>
          
          <a href="community.html" class="quick-action">
            <div class="flex items-center mb-4">
              <i class="fas fa-users text-3xl text-purple-400 mr-4"></i>
              <h3 class="text-xl font-bold">커뮤니티</h3>
            </div>
            <p class="text-gray-400">러닝 일지를 공유하고 다른 러너들과 소통하세요</p>
            <div class="mt-4 flex items-center text-sm text-blue-400">
              <i class="fas fa-arrow-up text-xs mr-2"></i>
              <span>새 글 3개</span>
            </div>
          </a>
        </div>
      </div>
    </div>
  </div>
  
  <!-- 채팅 패널 -->
  <div class="chat-panel" id="chatPanel">
    <div class="chat-header">
      <div>
        <h3 class="text-lg font-bold">💬 러닝톡</h3>
        <div class="text-sm text-green-300" id="onlineStatus">
          <i class="fas fa-circle text-xs"></i> 온라인
        </div>
      </div>
      <button onclick="toggleChat()" class="text-white hover:text-gray-300">
        <i class="fas fa-times text-xl"></i>
      </button>
    </div>
    
    <div class="chat-messages" id="chatMessages">
      <div class="text-center py-10 text-gray-500">
        <i class="fas fa-comments text-4xl mb-4"></i>
        <p>채팅에 참여해보세요!</p>
      </div>
    </div>
    
    <div class="chat-input-container">
      <div class="chat-input">
        <input type="text" id="messageInput" placeholder="메시지를 입력하세요..." 
               onkeypress="if(event.key==='Enter') sendMessage()">
        <button onclick="sendMessage()">
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
    </div>
  </div>
  
  <!-- 플로팅 채팅 버튼 -->
  <div class="chat-toggle" id="chatToggle" onclick="toggleChat()">
    <i class="fas fa-comments text-2xl text-white"></i>
    <div class="notification-badge" id="notificationBadge" style="display: none;">0</div>
  </div>
  
  <!-- 실시간 활동 피드 -->
  <div class="activity-feed" id="activityFeed">
    <h4 class="text-sm font-bold mb-3 text-purple-400">실시간 활동</h4>
    <div id="activityList">
      <div class="activity-item">
        <i class="fas fa-calculator text-xs text-green-400"></i>
        시스템이 시작되었습니다...
      </div>
    </div>
  </div>
  
  <script>
    let ws = null;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 5;
    let unreadCount = 0;
    let username = localStorage.getItem('username') || `러너${Math.floor(Math.random() * 1000)}`;
    localStorage.setItem('username', username);
    
    // 채팅 패널 토글
    function toggleChat() {
      const panel = document.getElementById('chatPanel');
      const toggle = document.getElementById('chatToggle');
      const container = document.getElementById('mainContainer');
      const badge = document.getElementById('notificationBadge');
      
      panel.classList.toggle('active');
      toggle.classList.toggle('active');
      container.classList.toggle('chat-open');
      
      if (panel.classList.contains('active')) {
        badge.style.display = 'none';
        unreadCount = 0;
        document.getElementById('messageInput').focus();
      }
    }
    
    // WebSocket 연결
    function connectWebSocket() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      
      try {
        ws = new WebSocket(`${protocol}//${window.location.hostname}:3002`);
        
        ws.onopen = () => {
          console.log('WebSocket 연결됨');
          reconnectAttempts = 0;
          updateStatus('online');
          
          // 입장 메시지
          ws.send(JSON.stringify({
            type: 'join',
            data: { username, page: 'index' }
          }));
          
          addSystemMessage('채팅 서버에 연결되었습니다');
        };
        
        ws.onmessage = (event) => {
          const data = JSON.parse(event.data);
          handleMessage(data);
        };
        
        ws.onclose = () => {
          console.log('WebSocket 연결 종료');
          updateStatus('offline');
          addSystemMessage('채팅 서버 연결이 끊어졌습니다');
          
          // 자동 재연결
          if (reconnectAttempts < maxReconnectAttempts) {
            reconnectAttempts++;
            const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 10000);
            setTimeout(connectWebSocket, delay);
          }
        };
        
        ws.onerror = (error) => {
          console.error('WebSocket 오류:', error);
        };
        
      } catch (error) {
        console.error('WebSocket 연결 실패:', error);
        useFallbackMode();
      }
    }
    
    // 메시지 처리
    function handleMessage(data) {
      switch(data.type) {
        case 'message':
          addChatMessage(data.data.username, data.data.text, false);
          updateNotification();
          break;
          
        case 'activity':
          addChatMessage(data.data.username, data.data.text, false, true);
          addActivityItem(data.data);
          break;
          
        case 'user_joined':
          addSystemMessage(`${data.data.username}님이 입장했습니다`);
          break;
          
        case 'user_left':
          addSystemMessage(`${data.data.username}님이 퇴장했습니다`);
          break;
          
        case 'users_online':
          updateOnlineCount(data.data.count);
          break;
          
        case 'stats':
          updateStats(data.data);
          break;
      }
    }
    
    // 메시지 전송
    function sendMessage() {
      const input = document.getElementById('messageInput');
      const text = input.value.trim();
      
      if (!text) return;
      
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({
          type: 'message',
          data: {
            text,
            username,
            source: 'index',
            timestamp: new Date().toISOString()
          }
        }));
        
        addChatMessage(username, text, true);
        input.value = '';
      } else {
        // 폴백 모드
        saveFallbackMessage(username, text);
        addChatMessage(username, text, true);
        input.value = '';
      }
    }
    
    // 채팅 메시지 추가
    function addChatMessage(user, text, isOwn = false, isActivity = false) {
      const container = document.getElementById('chatMessages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `chat-message ${isOwn ? 'own' : ''} ${isActivity ? 'activity' : ''}`;
      
      const time = new Date().toLocaleTimeString('ko-KR', { 
        hour: '2-digit', 
        minute: '2-digit' 
      });
      
      messageDiv.innerHTML = `
        <div class="chat-username">${user}</div>
        <div class="chat-text">${text}</div>
        <div class="chat-time">${time}</div>
      `;
      
      container.appendChild(messageDiv);
      container.scrollTop = container.scrollHeight;
    }
    
    // 시스템 메시지
    function addSystemMessage(text) {
      const container = document.getElementById('chatMessages');
      const messageDiv = document.createElement('div');
      messageDiv.className = 'text-center text-gray-500 text-sm py-2';
      messageDiv.textContent = text;
      container.appendChild(messageDiv);
      container.scrollTop = container.scrollHeight;
    }
    
    // 활동 피드 업데이트
    function addActivityItem(data) {
      const list = document.getElementById('activityList');
      const item = document.createElement('div');
      item.className = 'activity-item';
      
      let icon = 'fa-info-circle';
      let color = 'text-blue-400';
      
      if (data.activity === 'pace_calculated') {
        icon = 'fa-calculator';
        color = 'text-green-400';
      } else if (data.activity === 'message') {
        icon = 'fa-comment';
        color = 'text-purple-400';
      }
      
      item.innerHTML = `
        <i class="fas ${icon} text-xs ${color}"></i>
        ${data.username}: ${data.text}
      `;
      
      list.insertBefore(item, list.firstChild);
      
      // 최대 5개 항목만 유지
      while (list.children.length > 5) {
        list.removeChild(list.lastChild);
      }
    }
    
    // 알림 업데이트
    function updateNotification() {
      const panel = document.getElementById('chatPanel');
      const badge = document.getElementById('notificationBadge');
      
      if (!panel.classList.contains('active')) {
        unreadCount++;
        badge.textContent = unreadCount;
        badge.style.display = 'flex';
      }
    }
    
    // 상태 업데이트
    function updateStatus(status) {
      const statusEl = document.getElementById('onlineStatus');
      if (status === 'online') {
        statusEl.innerHTML = '<i class="fas fa-circle text-xs"></i> 온라인';
        statusEl.className = 'text-sm text-green-300';
      } else {
        statusEl.innerHTML = '<i class="fas fa-circle text-xs"></i> 오프라인';
        statusEl.className = 'text-sm text-gray-400';
      }
    }
    
    // 통계 업데이트
    function updateOnlineCount(count) {
      document.getElementById('onlineCount').textContent = count;
    }
    
    function updateStats(stats) {
      if (stats.messages !== undefined) {
        document.getElementById('messageCount').textContent = stats.messages;
      }
      if (stats.calculations !== undefined) {
        document.getElementById('calculationCount').textContent = stats.calculations;
      }
    }
    
    // 폴백 모드
    function useFallbackMode() {
      addSystemMessage('로컬 모드로 실행 중입니다');
      
      // 로컬 스토리지에서 메시지 로드
      const messages = JSON.parse(localStorage.getItem('fallbackMessages') || '[]');
      messages.forEach(msg => {
        addChatMessage(msg.username, msg.text);
      });
    }
    
    function saveFallbackMessage(user, text) {
      const messages = JSON.parse(localStorage.getItem('fallbackMessages') || '[]');
      messages.push({ 
        username: user, 
        text, 
        timestamp: new Date().toISOString() 
      });
      
      if (messages.length > 100) {
        messages.shift();
      }
      
      localStorage.setItem('fallbackMessages', JSON.stringify(messages));
    }
    
    // 초기화
    document.addEventListener('DOMContentLoaded', () => {
      connectWebSocket();
      
      // 가짜 실시간 통계 (데모용)
      setInterval(() => {
        const online = document.getElementById('onlineCount');
        const current = parseInt(online.textContent);
        online.textContent = Math.max(1, current + Math.floor(Math.random() * 3) - 1);
        
        const msgs = document.getElementById('messageCount');
        msgs.textContent = parseInt(msgs.textContent) + Math.floor(Math.random() * 2);
        
        const calcs = document.getElementById('calculationCount');
        if (Math.random() > 0.7) {
          calcs.textContent = parseInt(calcs.textContent) + 1;
        }
      }, 5000);
    });
  </script>
</body>
</html>