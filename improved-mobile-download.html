<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>개선된 모바일 다운로드 테스트</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Malgun Gothic', '맑은 고딕', sans-serif;
    }
    
    /* PC 스타일 차트 */
    .pc-style-chart {
      width: 1200px;
      background: white;
      padding: 40px;
      position: absolute;
      left: -9999px;
    }
    
    .chart-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 12px 12px 0 0;
      margin: -40px -40px 30px -40px;
    }
    
    .pace-table-full {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    
    .pace-table-full th {
      background: #f3f4f6;
      padding: 8px;
      border: 1px solid #e5e7eb;
      font-weight: bold;
    }
    
    .pace-table-full td {
      padding: 6px;
      border: 1px solid #e5e7eb;
      text-align: center;
    }
    
    .pace-table-full .highlight-row {
      background: #fef3c7;
    }
    
    .pace-table-full .highlight-cell {
      background: #fbbf24;
      font-weight: bold;
    }
    
    .developer-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 20px;
      padding: 15px;
      background: #f9fafb;
      border-radius: 8px;
    }
  </style>
</head>
<body class="bg-gray-100 p-4">
  
  <div class="max-w-lg mx-auto">
    <h1 class="text-2xl font-bold mb-4">개선된 다운로드 테스트</h1>
    
    <div class="bg-white rounded-lg p-4 mb-4">
      <h2 class="text-lg font-bold mb-3">다운로드 옵션</h2>
      
      <div class="space-y-2">
        <button onclick="generateAndDownloadFullChart()" 
                class="w-full bg-blue-500 text-white py-3 rounded-lg font-bold">
          <i class="fas fa-download mr-2"></i>
          전체 페이스 차트 다운로드
        </button>
        
        <button onclick="showPreview()"
                class="w-full bg-green-500 text-white py-3 rounded-lg font-bold">
          <i class="fas fa-eye mr-2"></i>
          미리보기
        </button>
      </div>
    </div>
    
    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
      <h3 class="font-bold mb-2">특징:</h3>
      <ul class="text-sm space-y-1">
        <li>• PC 버전과 동일한 전문적인 차트</li>
        <li>• 장호준 코치 정보 포함</li>
        <li>• 전체 테이블 데이터 표시</li>
        <li>• 고해상도 이미지 출력</li>
      </ul>
    </div>
  </div>

  <!-- 숨겨진 차트 컨테이너 (PC 스타일) -->
  <div id="fullChartContainer" class="pc-style-chart">
    <!-- 헤더 -->
    <div class="chart-header">
      <div class="flex justify-between items-center">
        <div>
          <h1 class="text-3xl font-bold mb-2">트랙 레인별 페이스 차트</h1>
          <p class="opacity-90">과학적 훈련을 위한 정밀 분석 도구</p>
        </div>
        <div class="text-right">
          <p class="text-sm opacity-90">Developer</p>
          <p class="text-2xl font-bold">장호준 코치</p>
          <p class="font-semibold">ATHLETE TIME</p>
        </div>
      </div>
    </div>
    
    <!-- 차트 내용 -->
    <div id="chartContent">
      <!-- 동적으로 생성 -->
    </div>
    
    <!-- 푸터 -->
    <div class="developer-info">
      <div>
        <p class="text-sm text-gray-600">생성일: <span id="generateDate"></span></p>
        <p class="text-xs text-gray-500">© 2024 Athlete Time</p>
      </div>
      <div class="text-right">
        <p class="text-sm font-bold text-gray-700">제작: 장호준 코치 (KAMA 한국 지도자)</p>
        <p class="text-xs text-gray-500">www.athletetime.com</p>
      </div>
    </div>
  </div>

  <script>
    // 전체 페이스 차트 생성
    function generateFullChart() {
      const chartContent = document.getElementById('chartContent');
      
      // 날짜 설정
      document.getElementById('generateDate').textContent = 
        new Date().toLocaleDateString('ko-KR', { 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        });
      
      // 전체 페이스 테이블 생성 (PC 버전과 동일)
      let html = `
        <h2 class="text-2xl font-bold mb-4 text-center">
          <i class="fas fa-tachometer-alt text-blue-500 mr-2"></i>
          킬로미터 페이스 → 거리별 완주 시간
        </h2>
        
        <table class="pace-table-full">
          <thead>
            <tr>
              <th rowspan="2">목표<br>속도(km/h)</th>
              <th rowspan="2">Pace<br>(mins/km)</th>
              <th colspan="10">Track Running Event (거리별 완주 시간)</th>
            </tr>
            <tr>
              <th>100m</th>
              <th>200m</th>
              <th>400m</th>
              <th>800m</th>
              <th>1km</th>
              <th>1.5km</th>
              <th>3km</th>
              <th>5km</th>
              <th>10km</th>
              <th>21.1km</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      // 페이스 데이터 생성 (2:00/km부터 6:00/km까지)
      const paces = [
        { speed: 30, pace: '2:00', times: ['00:20', '00:40', '01:20', '02:40', '03:20', '05:00', '10:00', '16:40', '33:20', '1:10:20'] },
        { speed: 24, pace: '2:30', times: ['00:25', '00:50', '01:40', '03:20', '04:10', '06:15', '12:30', '20:50', '41:40', '1:27:55'] },
        { speed: 20, pace: '3:00', times: ['00:30', '01:00', '02:00', '04:00', '05:00', '07:30', '15:00', '25:00', '50:00', '1:45:30'] },
        { speed: 17.14, pace: '3:30', times: ['00:35', '01:10', '02:20', '04:40', '05:50', '08:45', '17:30', '29:10', '58:20', '2:03:05'] },
        { speed: 15, pace: '4:00', times: ['00:40', '01:20', '02:40', '05:20', '06:40', '10:00', '20:00', '33:20', '1:06:40', '2:20:40'] },
        { speed: 13.33, pace: '4:30', times: ['00:45', '01:30', '03:00', '06:00', '07:30', '11:15', '22:30', '37:30', '1:15:00', '2:38:15'] },
        { speed: 12, pace: '5:00', times: ['00:50', '01:40', '03:20', '06:40', '08:20', '12:30', '25:00', '41:40', '1:23:20', '2:55:50'] },
        { speed: 10.91, pace: '5:30', times: ['00:55', '01:50', '03:40', '07:20', '09:10', '13:45', '27:30', '45:50', '1:31:40', '3:13:25'] },
        { speed: 10, pace: '6:00', times: ['01:00', '02:00', '04:00', '08:00', '10:00', '15:00', '30:00', '50:00', '1:40:00', '3:31:00'] }
      ];
      
      paces.forEach((data, index) => {
        const isHighlight = index % 2 === 0;
        html += `<tr class="${isHighlight ? 'highlight-row' : ''}">`;
        html += `<td class="font-bold">${data.speed}</td>`;
        html += `<td class="font-bold ${data.pace === '3:00' || data.pace === '4:00' || data.pace === '5:00' ? 'highlight-cell' : ''}">${data.pace}</td>`;
        data.times.forEach(time => {
          html += `<td>${time}</td>`;
        });
        html += '</tr>';
      });
      
      html += `
          </tbody>
        </table>
      `;
      
      // 3000m 장애물 차트도 추가
      html += `
        <h2 class="text-2xl font-bold mt-8 mb-4 text-center">
          <i class="fas fa-water text-blue-500 mr-2"></i>
          3000m 장애물 페이스 차트
        </h2>
        
        <table class="pace-table-full">
          <thead>
            <tr>
              <th>km 페이스</th>
              <th>400m</th>
              <th>800m</th>
              <th>1000m</th>
              <th>1200m</th>
              <th>1600m</th>
              <th>2000m</th>
              <th>2400m</th>
              <th>2800m</th>
              <th>3000m</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      // 3000m 데이터 추가
      const steeplechasePaces = [
        { pace: '2:30', splits: ['1:02', '2:04', '2:35', '3:06', '4:08', '5:10', '6:12', '7:14', '7:45'] },
        { pace: '3:00', splits: ['1:14', '2:28', '3:05', '3:42', '4:56', '6:10', '7:24', '8:38', '9:15'] },
        { pace: '3:30', splits: ['1:26', '2:52', '3:35', '4:18', '5:44', '7:10', '8:36', '10:02', '10:45'] },
        { pace: '4:00', splits: ['1:38', '3:16', '4:05', '4:54', '6:32', '8:10', '9:48', '11:26', '12:15'] },
        { pace: '4:30', splits: ['1:50', '3:40', '4:35', '5:30', '7:20', '9:10', '11:00', '12:50', '13:45'] },
        { pace: '5:00', splits: ['2:02', '4:04', '5:05', '6:06', '8:08', '10:10', '12:12', '14:14', '15:15'] }
      ];
      
      steeplechasePaces.forEach((data, index) => {
        const isHighlight = index % 2 === 0;
        html += `<tr class="${isHighlight ? 'highlight-row' : ''}">`;
        html += `<td class="font-bold">${data.pace}</td>`;
        data.splits.forEach(time => {
          html += `<td>${time}</td>`;
        });
        html += '</tr>';
      });
      
      html += `
          </tbody>
        </table>
      `;
      
      chartContent.innerHTML = html;
    }
    
    // 차트 생성 및 다운로드
    async function generateAndDownloadFullChart() {
      // 차트 생성
      generateFullChart();
      
      const container = document.getElementById('fullChartContainer');
      
      // 잠시 DOM에 추가 (렌더링을 위해)
      container.style.left = '0';
      container.style.position = 'fixed';
      container.style.top = '0';
      container.style.zIndex = '9999';
      
      try {
        // html2canvas로 캡처
        const canvas = await html2canvas(container, {
          scale: 2,
          backgroundColor: '#ffffff',
          logging: false,
          useCORS: true,
          windowWidth: 1200,
          windowHeight: 2000
        });
        
        // 이미지로 다운로드
        canvas.toBlob(blob => {
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.download = `pace-chart-${new Date().getTime()}.png`;
          link.href = url;
          link.click();
          URL.revokeObjectURL(url);
        }, 'image/png', 1.0);
        
      } catch (error) {
        console.error('다운로드 실패:', error);
        alert('다운로드 중 오류가 발생했습니다');
      } finally {
        // 다시 숨기기
        container.style.left = '-9999px';
        container.style.position = 'absolute';
      }
    }
    
    // 미리보기
    function showPreview() {
      generateFullChart();
      
      const container = document.getElementById('fullChartContainer');
      
      // 새 창에서 미리보기
      const previewWindow = window.open('', '_blank');
      previewWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>페이스 차트 미리보기</title>
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <script src="https://cdn.tailwindcss.com"><\/script>
          <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
          <style>
            body { font-family: -apple-system, BlinkMacSystemFont, 'Malgun Gothic', sans-serif; }
            .download-btn {
              position: fixed;
              bottom: 20px;
              right: 20px;
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
              color: white;
              padding: 15px 30px;
              border-radius: 50px;
              font-weight: bold;
              cursor: pointer;
              box-shadow: 0 4px 15px rgba(0,0,0,0.2);
              z-index: 1000;
            }
          </style>
        </head>
        <body>
          <div style="max-width: 1200px; margin: 0 auto; padding: 20px;">
            ${container.innerHTML}
          </div>
          <button class="download-btn" onclick="window.print()">
            <i class="fas fa-download mr-2"></i>다운로드
          </button>
        </body>
        </html>
      `);
    }
  </script>
</body>
</html>