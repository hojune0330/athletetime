<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>ì‹¤ì‹œê°„ ì±„íŒ… | ì• ìŠ¬ë¦¬íŠ¸ íƒ€ì„</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Malgun Gothic', sans-serif;
      -webkit-tap-highlight-color: transparent;
      overscroll-behavior-y: contain;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .chat-container {
      max-width: 1200px;
      margin: 0 auto;
      height: 100vh;
      display: flex;
      background: white;
    }
    
    .room-list {
      width: 280px;
      background: #2d3748;
      color: white;
      padding: 1rem;
      overflow-y: auto;
    }
    
    .chat-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #f7fafc;
    }
    
    .chat-header {
      background: white;
      padding: 1rem;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .messages-container {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      scroll-behavior: smooth;
    }
    
    .message {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 1rem;
      animation: slideInLeft 0.3s ease;
    }
    
    .message-system {
      text-align: center;
      color: #718096;
      font-size: 0.875rem;
      padding: 0.5rem;
      margin: 0.5rem 0;
    }
    
    .message-bot {
      background: #edf2f7;
      padding: 0.75rem;
      border-radius: 0.5rem;
      margin: 0.5rem 0;
      border-left: 4px solid #4299e1;
    }
    
    @keyframes slideInLeft {
      from {
        transform: translateX(-20px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: white;
      flex-shrink: 0;
    }
    
    .room-item {
      padding: 0.75rem;
      margin-bottom: 0.5rem;
      border-radius: 0.5rem;
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    .room-item:hover {
      background: #374151;
    }
    
    .room-item.active {
      background: #4f46e5;
    }
    
    .room-icon {
      width: 40px;
      height: 40px;
      border-radius: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.1);
      font-size: 1.25rem;
    }
    
    .unread-badge {
      background: #ef4444;
      color: white;
      font-size: 0.75rem;
      padding: 0.125rem 0.375rem;
      border-radius: 9999px;
      margin-left: auto;
    }
    
    .auto-scroll-toggle {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: #4f46e5;
      color: white;
      border-radius: 9999px;
      cursor: pointer;
      transition: all 0.2s;
      user-select: none;
    }
    
    .auto-scroll-toggle:hover {
      background: #6366f1;
    }
    
    .auto-scroll-toggle.disabled {
      background: #9ca3af;
    }
    
    .scroll-to-bottom {
      position: absolute;
      bottom: 100px;
      right: 20px;
      background: #4f46e5;
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transition: all 0.2s;
      opacity: 0;
      pointer-events: none;
    }
    
    .scroll-to-bottom.visible {
      opacity: 1;
      pointer-events: auto;
    }
    
    .scroll-to-bottom:hover {
      transform: scale(1.1);
      background: #6366f1;
    }
    
    @media (max-width: 768px) {
      .room-list {
        position: fixed;
        left: -280px;
        z-index: 50;
        height: 100vh;
        transition: left 0.3s;
      }
      
      .room-list.open {
        left: 0;
      }
      
      .menu-toggle {
        display: block !important;
      }
    }
    
    .menu-toggle {
      display: none;
    }
    
    .back-button {
      padding: 0.5rem 1rem;
      background: #e2e8f0;
      border-radius: 0.5rem;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .back-button:hover {
      background: #cbd5e0;
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <!-- ì±„íŒ…ë°© ëª©ë¡ -->
    <div id="roomList" class="room-list">
      <div class="mb-4">
        <h2 class="text-xl font-bold mb-4">ì±„íŒ…ë°© ëª©ë¡</h2>
        <button onclick="window.location.href='index.html'" class="back-button w-full text-center">
          <i class="fas fa-arrow-left mr-2"></i>ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°
        </button>
      </div>
      
      <div id="roomsContainer">
        <!-- ì±„íŒ…ë°©ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
      </div>
    </div>
    
    <!-- ì±„íŒ… ì˜ì—­ -->
    <div class="chat-area">
      <!-- í—¤ë” -->
      <div class="chat-header">
        <button class="menu-toggle" onclick="toggleRoomList()">
          <i class="fas fa-bars text-xl"></i>
        </button>
        
        <div class="flex items-center gap-3">
          <div id="currentRoomIcon" class="text-2xl">ğŸ’¬</div>
          <div>
            <h3 id="currentRoomName" class="font-bold">ë©”ì¸ ì±„íŒ…ë°©</h3>
            <span id="onlineCount" class="text-sm text-gray-500">ì ‘ì†ì 0ëª…</span>
          </div>
        </div>
        
        <div class="flex items-center gap-2">
          <!-- ìë™ ìŠ¤í¬ë¡¤ í† ê¸€ -->
          <div id="autoScrollToggle" class="auto-scroll-toggle" onclick="toggleAutoScroll()">
            <i class="fas fa-arrow-down"></i>
            <span>ìë™ ìŠ¤í¬ë¡¤</span>
          </div>
        </div>
      </div>
      
      <!-- ë©”ì‹œì§€ ì˜ì—­ -->
      <div id="messagesContainer" class="messages-container relative">
        <div id="messagesList">
          <!-- ë©”ì‹œì§€ë“¤ì´ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
        </div>
        
        <!-- ë§¨ ì•„ë˜ë¡œ ì´ë™ ë²„íŠ¼ -->
        <div id="scrollToBottom" class="scroll-to-bottom" onclick="scrollToBottom()">
          <i class="fas fa-chevron-down"></i>
        </div>
      </div>
      
      <!-- ì…ë ¥ ì˜ì—­ -->
      <div class="bg-white border-t p-4">
        <div class="flex gap-2">
          <input 
            id="nicknameInput" 
            type="text" 
            placeholder="ë‹‰ë„¤ì„" 
            class="px-3 py-2 border rounded-lg"
            style="width: 100px;"
          />
          <input 
            id="messageInput" 
            type="text" 
            placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." 
            class="flex-1 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            onkeypress="handleKeyPress(event)"
          />
          <button 
            onclick="sendMessage()" 
            class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition"
          >
            ì „ì†¡
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- ë°±ì—”ë“œ ì„¤ì • ë¡œë“œ -->
  <script src="backend-config.js"></script>
  
  <script>
    // ìƒíƒœ ë³€ìˆ˜ë“¤
    let ws = null;
    let currentRoom = 'main';
    let nickname = localStorage.getItem('chatNickname') || 'ìµëª…' + Math.floor(Math.random() * 1000);
    let autoScroll = true;
    let isNearBottom = true;
    let unreadCounts = {};
    let roomMessages = {
      main: [],
      running: [],
      free: []
    };
    
    // ì±„íŒ…ë°© ì •ë³´
    const rooms = [
      { id: 'main', name: 'ë©”ì¸ ì±„íŒ…ë°©', icon: 'ğŸ’¬', description: 'ëª¨ë“  ëŸ¬ë„ˆë“¤ì˜ ì†Œí†µ ê³µê°„' },
      { id: 'running', name: 'ëŸ¬ë‹ ì±„íŒ…ë°©', icon: 'ğŸƒ', description: 'ëŸ¬ë‹ ì •ë³´ì™€ íŒ ê³µìœ ' },
      { id: 'free', name: 'ììœ  ì±„íŒ…ë°©', icon: 'ğŸˆ', description: 'ììœ ë¡œìš´ ëŒ€í™”' }
    ];
    
    // ì´ˆê¸°í™”
    window.onload = function() {
      document.getElementById('nicknameInput').value = nickname;
      initializeRooms();
      connectWebSocket();
      setupScrollDetection();
    };
    
    // WebSocket ì—°ê²°
    function connectWebSocket() {
      const wsUrl = BackendConfig.getWebSocketURL();
      console.log('WebSocket ì—°ê²°:', wsUrl);
      
      ws = new WebSocket(wsUrl);
      
      ws.onopen = () => {
        console.log('âœ… WebSocket ì—°ê²° ì„±ê³µ');
        joinRoom(currentRoom);
        addSystemMessage('ì±„íŒ…ë°©ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.');
      };
      
      ws.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          handleServerMessage(data);
        } catch (error) {
          console.error('ë©”ì‹œì§€ íŒŒì‹± ì˜¤ë¥˜:', error);
        }
      };
      
      ws.onerror = (error) => {
        console.error('âŒ WebSocket ì˜¤ë¥˜:', error);
        addSystemMessage('ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      };
      
      ws.onclose = () => {
        console.log('WebSocket ì—°ê²° ì¢…ë£Œ');
        addSystemMessage('ì„œë²„ì™€ì˜ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤. ì¬ì—°ê²° ì¤‘...');
        setTimeout(connectWebSocket, 3000);
      };
    }
    
    // ì„œë²„ ë©”ì‹œì§€ ì²˜ë¦¬
    function handleServerMessage(data) {
      switch(data.type) {
        case 'room_joined':
          console.log('ë°© ì…ì¥:', data.data);
          loadRoomMessages(data.data);
          break;
        case 'message':
          handleNewMessage(data.data);
          break;
        case 'user_joined':
          addBotMessage(`${data.data.nickname}ë‹˜ì´ ì…ì¥í–ˆìŠµë‹ˆë‹¤.`, data.data.room);
          break;
        case 'user_left':
          addBotMessage(`${data.data.nickname}ë‹˜ì´ í‡´ì¥í–ˆìŠµë‹ˆë‹¤.`, data.data.room);
          break;
        case 'user_count':
          updateOnlineCount(data.data.count);
          break;
      }
    }
    
    // ìƒˆ ë©”ì‹œì§€ ì²˜ë¦¬
    function handleNewMessage(message) {
      // ë©”ì‹œì§€ë¥¼ í•´ë‹¹ ë°©ì˜ ë°°ì—´ì— ì €ì¥
      if (roomMessages[message.room]) {
        roomMessages[message.room].push(message);
      }
      
      // í˜„ì¬ ë°©ì˜ ë©”ì‹œì§€ì¸ ê²½ìš°ë§Œ í‘œì‹œ
      if (message.room === currentRoom) {
        addMessage(message);
      } else {
        // ë‹¤ë¥¸ ë°©ì˜ ë©”ì‹œì§€ì¸ ê²½ìš° ì•Œë¦¼ ì¹´ìš´íŠ¸ ì¦ê°€
        if (!unreadCounts[message.room]) {
          unreadCounts[message.room] = 0;
        }
        unreadCounts[message.room]++;
        updateRoomBadge(message.room);
      }
    }
    
    // ë©”ì‹œì§€ ì¶”ê°€
    function addMessage(message) {
      const messagesList = document.getElementById('messagesList');
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message';
      
      const time = new Date(message.timestamp).toLocaleTimeString('ko-KR', {
        hour: '2-digit',
        minute: '2-digit'
      });
      
      messageDiv.innerHTML = `
        <div class="avatar">${message.avatar || message.nickname.charAt(0).toUpperCase()}</div>
        <div class="flex-1">
          <div class="flex items-center gap-2 mb-1">
            <span class="font-semibold">${escapeHtml(message.nickname)}</span>
            <span class="text-xs text-gray-500">${time}</span>
          </div>
          <div class="bg-white rounded-lg px-3 py-2 inline-block">
            ${escapeHtml(message.text)}
          </div>
        </div>
      `;
      
      messagesList.appendChild(messageDiv);
      
      // ìë™ ìŠ¤í¬ë¡¤
      if (autoScroll && isNearBottom) {
        scrollToBottom();
      }
      
      // ì˜¤ë˜ëœ ë©”ì‹œì§€ ì œê±° (100ê°œ ì œí•œ)
      while (messagesList.children.length > 100) {
        messagesList.removeChild(messagesList.firstChild);
      }
    }
    
    // ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì¶”ê°€
    function addSystemMessage(text) {
      const messagesList = document.getElementById('messagesList');
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message-system';
      messageDiv.textContent = text;
      messagesList.appendChild(messageDiv);
    }
    
    // ë´‡ ë©”ì‹œì§€ ì¶”ê°€
    function addBotMessage(text, room = currentRoom) {
      if (room !== currentRoom) return;
      
      const messagesList = document.getElementById('messagesList');
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message-bot';
      messageDiv.innerHTML = `
        <div class="flex items-center gap-2">
          <i class="fas fa-robot text-blue-500"></i>
          <span class="font-semibold text-blue-700">ì•Œë¦¼ë´‡</span>
        </div>
        <div class="mt-1">${escapeHtml(text)}</div>
      `;
      messagesList.appendChild(messageDiv);
    }
    
    // ë©”ì‹œì§€ ì „ì†¡
    function sendMessage() {
      const input = document.getElementById('messageInput');
      const text = input.value.trim();
      
      if (!text) return;
      
      // ë‹‰ë„¤ì„ ì—…ë°ì´íŠ¸
      const nicknameInput = document.getElementById('nicknameInput');
      nickname = nicknameInput.value.trim() || 'ìµëª…';
      localStorage.setItem('chatNickname', nickname);
      
      // ëª…ë ¹ì–´ ì²˜ë¦¬
      if (text.startsWith('/')) {
        handleCommand(text);
        input.value = '';
        return;
      }
      
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({
          type: 'message',
          data: {
            text: text,
            nickname: nickname,
            avatar: nickname.charAt(0).toUpperCase()
          }
        }));
        input.value = '';
      }
    }
    
    // ëª…ë ¹ì–´ ì²˜ë¦¬
    function handleCommand(command) {
      const parts = command.split(' ');
      const cmd = parts[0].toLowerCase();
      
      switch(cmd) {
        case '/help':
        case '/ë„ì›€':
          addBotMessage(`
            ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´:
            /help, /ë„ì›€ - ë„ì›€ë§ í‘œì‹œ
            /clear, /ì²­ì†Œ - ì±„íŒ…ì°½ ì²­ì†Œ
            /users, /ìœ ì € - ì ‘ì†ì ìˆ˜ í™•ì¸
            /nick [ë‹‰ë„¤ì„] - ë‹‰ë„¤ì„ ë³€ê²½
          `);
          break;
        case '/clear':
        case '/ì²­ì†Œ':
          document.getElementById('messagesList').innerHTML = '';
          addSystemMessage('ì±„íŒ…ì°½ì„ ì²­ì†Œí–ˆìŠµë‹ˆë‹¤.');
          break;
        case '/nick':
          if (parts[1]) {
            nickname = parts.slice(1).join(' ');
            document.getElementById('nicknameInput').value = nickname;
            localStorage.setItem('chatNickname', nickname);
            addSystemMessage(`ë‹‰ë„¤ì„ì´ '${nickname}'ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
          }
          break;
        default:
          addBotMessage('ì•Œ ìˆ˜ ì—†ëŠ” ëª…ë ¹ì–´ì…ë‹ˆë‹¤. /helpë¥¼ ì…ë ¥í•˜ì—¬ ë„ì›€ë§ì„ í™•ì¸í•˜ì„¸ìš”.');
      }
    }
    
    // ì±„íŒ…ë°© ì „í™˜
    function switchRoom(roomId) {
      if (roomId === currentRoom) return;
      
      // ì´ì „ ë°© ë– ë‚˜ê¸°
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({
          type: 'leave',
          data: { room: currentRoom, nickname: nickname }
        }));
      }
      
      // ìƒˆ ë°© ì…ì¥
      currentRoom = roomId;
      joinRoom(roomId);
      
      // UI ì—…ë°ì´íŠ¸
      updateRoomUI();
      
      // ì½ì§€ ì•Šì€ ë©”ì‹œì§€ ì´ˆê¸°í™”
      unreadCounts[roomId] = 0;
      updateRoomBadge(roomId);
      
      // ë©”ì‹œì§€ ëª©ë¡ ì—…ë°ì´íŠ¸
      displayRoomMessages(roomId);
      
      // ëª¨ë°”ì¼ì—ì„œ ë°© ëª©ë¡ ë‹«ê¸°
      if (window.innerWidth <= 768) {
        document.getElementById('roomList').classList.remove('open');
      }
    }
    
    // ë°© ì…ì¥
    function joinRoom(roomId) {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({
          type: 'join',
          data: { room: roomId, nickname: nickname }
        }));
      }
    }
    
    // ë°© ë©”ì‹œì§€ ë¡œë“œ
    function loadRoomMessages(data) {
      const messages = data.messages || [];
      
      // í•´ë‹¹ ë°©ì˜ ë©”ì‹œì§€ ì €ì¥
      roomMessages[data.room] = messages;
      
      // í˜„ì¬ ë°©ì´ë©´ í‘œì‹œ
      if (data.room === currentRoom) {
        displayRoomMessages(data.room);
        addBotMessage(`${data.roomName}ì— ì…ì¥í–ˆìŠµë‹ˆë‹¤.`);
      }
    }
    
    // ë°© ë©”ì‹œì§€ í‘œì‹œ
    function displayRoomMessages(roomId) {
      const messagesList = document.getElementById('messagesList');
      messagesList.innerHTML = '';
      
      const messages = roomMessages[roomId] || [];
      messages.forEach(msg => addMessage(msg));
      
      if (messages.length === 0) {
        addSystemMessage('ì•„ì§ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤. ì²« ë²ˆì§¸ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ë³´ì„¸ìš”!');
      }
      
      scrollToBottom();
    }
    
    // ì±„íŒ…ë°© ëª©ë¡ ì´ˆê¸°í™”
    function initializeRooms() {
      const container = document.getElementById('roomsContainer');
      
      rooms.forEach(room => {
        const roomDiv = document.createElement('div');
        roomDiv.className = `room-item ${room.id === currentRoom ? 'active' : ''}`;
        roomDiv.onclick = () => switchRoom(room.id);
        roomDiv.id = `room-${room.id}`;
        
        roomDiv.innerHTML = `
          <div class="room-icon">${room.icon}</div>
          <div class="flex-1">
            <div class="font-semibold">${room.name}</div>
            <div class="text-xs opacity-75">${room.description}</div>
          </div>
          <span id="badge-${room.id}" class="unread-badge" style="display: none;">0</span>
        `;
        
        container.appendChild(roomDiv);
      });
    }
    
    // ë°© UI ì—…ë°ì´íŠ¸
    function updateRoomUI() {
      // í™œì„± ë°© í‘œì‹œ
      document.querySelectorAll('.room-item').forEach(item => {
        item.classList.remove('active');
      });
      document.getElementById(`room-${currentRoom}`).classList.add('active');
      
      // í—¤ë” ì—…ë°ì´íŠ¸
      const room = rooms.find(r => r.id === currentRoom);
      if (room) {
        document.getElementById('currentRoomIcon').textContent = room.icon;
        document.getElementById('currentRoomName').textContent = room.name;
      }
    }
    
    // ì½ì§€ ì•Šì€ ë©”ì‹œì§€ ë°°ì§€ ì—…ë°ì´íŠ¸
    function updateRoomBadge(roomId) {
      const badge = document.getElementById(`badge-${roomId}`);
      if (badge) {
        const count = unreadCounts[roomId] || 0;
        if (count > 0) {
          badge.textContent = count > 99 ? '99+' : count;
          badge.style.display = 'block';
        } else {
          badge.style.display = 'none';
        }
      }
    }
    
    // ì˜¨ë¼ì¸ ìˆ˜ ì—…ë°ì´íŠ¸
    function updateOnlineCount(count) {
      document.getElementById('onlineCount').textContent = `ì ‘ì†ì ${count}ëª…`;
    }
    
    // ìë™ ìŠ¤í¬ë¡¤ í† ê¸€
    function toggleAutoScroll() {
      autoScroll = !autoScroll;
      const toggle = document.getElementById('autoScrollToggle');
      
      if (autoScroll) {
        toggle.classList.remove('disabled');
        scrollToBottom();
      } else {
        toggle.classList.add('disabled');
      }
    }
    
    // ìŠ¤í¬ë¡¤ ê°ì§€
    function setupScrollDetection() {
      const container = document.getElementById('messagesContainer');
      const scrollButton = document.getElementById('scrollToBottom');
      
      container.addEventListener('scroll', () => {
        const scrollTop = container.scrollTop;
        const scrollHeight = container.scrollHeight;
        const clientHeight = container.clientHeight;
        const distanceFromBottom = scrollHeight - scrollTop - clientHeight;
        
        isNearBottom = distanceFromBottom < 100;
        
        // ìŠ¤í¬ë¡¤ ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€
        if (distanceFromBottom > 200) {
          scrollButton.classList.add('visible');
        } else {
          scrollButton.classList.remove('visible');
        }
      });
    }
    
    // ë§¨ ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤
    function scrollToBottom() {
      const container = document.getElementById('messagesContainer');
      container.scrollTop = container.scrollHeight;
    }
    
    // ë°© ëª©ë¡ í† ê¸€ (ëª¨ë°”ì¼)
    function toggleRoomList() {
      document.getElementById('roomList').classList.toggle('open');
    }
    
    // ì—”í„°í‚¤ ì²˜ë¦¬
    function handleKeyPress(event) {
      if (event.key === 'Enter') {
        sendMessage();
      }
    }
    
    // HTML ì´ìŠ¤ì¼€ì´í”„
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì—°ê²° ì¢…ë£Œ
    window.addEventListener('beforeunload', () => {
      if (ws) {
        ws.close();
      }
    });
  </script>
</body>
</html>