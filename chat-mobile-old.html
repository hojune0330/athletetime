<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>실시간 채팅 | 애슬리트 타임</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
  <style>
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Malgun Gothic', '맑은 고딕', sans-serif;
      -webkit-tap-highlight-color: transparent;
      overscroll-behavior: none;
      touch-action: pan-y;
    }
    
    /* Safe area handling */
    .safe-top { 
      padding-top: env(safe-area-inset-top);
      padding-top: constant(safe-area-inset-top);
    }
    .safe-bottom { 
      padding-bottom: env(safe-area-inset-bottom);
      padding-bottom: constant(safe-area-inset-bottom);
    }
    
    /* 스크롤 숨기기 */
    .no-scrollbar {
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    .no-scrollbar::-webkit-scrollbar {
      display: none;
    }
    
    /* 메시지 버블 */
    .message-bubble {
      max-width: 75%;
      word-break: break-word;
    }
    
    .message-bubble.own {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .message-bubble.other {
      background: #f3f4f6;
      color: #1f2937;
    }
    
    /* 애니메이션 */
    @keyframes slideIn {
      from { 
        opacity: 0; 
        transform: translateY(10px);
      }
      to { 
        opacity: 1; 
        transform: translateY(0);
      }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .slide-in { animation: slideIn 0.3s ease-out; }
    .fade-in { animation: fadeIn 0.2s ease-out; }
    
    /* 타이핑 인디케이터 */
    .typing-dot {
      width: 6px;
      height: 6px;
      background: #9ca3af;
      border-radius: 50%;
      animation: pulse 1.4s infinite;
    }
    
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    
    /* 방 카드 */
    .room-card {
      transition: all 0.2s;
    }
    
    .room-card:active {
      transform: scale(0.98);
    }
    
    .room-card.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    /* 입력창 포커스 */
    .input-focus:focus {
      outline: none;
      border-color: #667eea;
    }
    
    /* 모달 백드롭 */
    .modal-backdrop {
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    
    /* 플로팅 버튼 */
    .fab {
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    /* 온라인 인디케이터 */
    .online-dot {
      width: 8px;
      height: 8px;
      background: #10b981;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    
    /* 스와이프 힌트 */
    .swipe-hint {
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
      animation: swipe 2s infinite;
    }
    
    @keyframes swipe {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    
    /* iOS 고정 입력창 처리 */
    .message-input-container {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      border-top: 1px solid #e5e7eb;
      z-index: 30;
    }
    
    /* 메시지 컨테이너 패딩 */
    .messages-container {
      padding-bottom: calc(60px + env(safe-area-inset-bottom));
    }
  </style>
</head>
<body class="bg-gray-50">
  
  <!-- 메인 컨테이너 -->
  <div class="h-screen flex flex-col">
    
    <!-- 헤더 (고정) -->
    <header class="bg-gradient-to-r from-purple-600 to-pink-600 text-white safe-top flex-shrink-0">
      <div class="flex items-center justify-between p-4">
        <div class="flex items-center gap-3">
          <button onclick="goBack()" class="p-1">
            <i class="fas fa-arrow-left text-lg"></i>
          </button>
          <div>
            <h1 class="font-bold text-lg">실시간 채팅</h1>
            <p class="text-xs opacity-90 flex items-center gap-1">
              <span class="online-dot"></span>
              <span id="onlineCount">1</span>명 온라인
            </p>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <button onclick="toggleRoomList()" class="p-2">
            <i class="fas fa-comments text-lg"></i>
          </button>
          <button onclick="showSettings()" class="p-2">
            <i class="fas fa-cog text-lg"></i>
          </button>
        </div>
      </div>
      
      <!-- 현재 방 정보 -->
      <div id="currentRoomInfo" class="px-4 pb-2 border-t border-white/20">
        <div class="flex items-center justify-between pt-2">
          <div class="flex items-center gap-2">
            <span id="roomIcon" class="text-xl">🏠</span>
            <div>
              <h2 id="roomName" class="font-medium text-sm">메인 채팅방</h2>
              <p id="roomDesc" class="text-xs opacity-75">모두가 함께하는 공간</p>
            </div>
          </div>
          <span id="roomTimer" class="text-xs bg-white/20 px-2 py-1 rounded-full hidden">
            <i class="fas fa-clock mr-1"></i><span id="timeLeft">30:00</span>
          </span>
        </div>
      </div>
    </header>
    
    <!-- 메시지 영역 -->
    <div class="flex-1 overflow-hidden relative">
      <!-- Room Discovery (메인 채팅방에서만 표시) -->
      <div id="roomDiscovery" class="bg-white border-b p-3 hidden">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-xs font-bold text-gray-600">
            <i class="fas fa-fire text-orange-500 mr-1"></i>활발한 채팅방
          </h3>
          <button onclick="toggleRoomDiscovery()" class="text-xs text-gray-500">
            <i class="fas fa-chevron-down"></i>
          </button>
        </div>
        <div id="activeRooms" class="flex gap-2 overflow-x-auto no-scrollbar pb-1">
          <!-- 활성 룸 카드들 -->
        </div>
      </div>
      
      <!-- 메시지 목록 -->
      <div id="messagesList" class="flex-1 overflow-y-auto messages-container p-4 space-y-3">
        <!-- 환영 메시지 -->
        <div class="text-center py-8 fade-in">
          <div class="bg-gradient-to-r from-purple-100 to-pink-100 rounded-2xl p-6 inline-block max-w-xs">
            <div class="text-4xl mb-3">👋</div>
            <h3 class="font-bold text-gray-800 mb-2">채팅에 오신 것을 환영합니다!</h3>
            <p class="text-sm text-gray-600 mb-3">육상인들과 실시간으로 소통하세요</p>
            <div class="bg-white/80 rounded-lg p-2 text-xs text-gray-500">
              <i class="fas fa-info-circle text-blue-500 mr-1"></i>
              닉네임 설정: 우측 상단 ⚙️ 설정 버튼
            </div>
          </div>
        </div>
      </div>
      
      <!-- 타이핑 인디케이터 -->
      <div id="typingIndicator" class="hidden px-4 py-2 bg-white/90 border-t">
        <div class="flex items-center gap-2">
          <span class="text-xs text-gray-500">누군가 입력중</span>
          <div class="flex gap-1">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 입력 영역 (고정) -->
    <div class="message-input-container safe-bottom">
      <div class="p-3">
        <div class="flex gap-2">
          <button onclick="showEmojiPicker()" class="p-2 text-gray-600">
            <i class="far fa-smile text-xl"></i>
          </button>
          <div class="flex-1 relative">
            <textarea 
              id="messageInput"
              placeholder="메시지 입력..."
              class="w-full px-3 py-2 border rounded-2xl resize-none input-focus text-sm"
              rows="1"
              maxlength="500"
            ></textarea>
            <span id="charCount" class="absolute right-2 bottom-2 text-xs text-gray-400 hidden">0/500</span>
          </div>
          <button onclick="sendMessage()" id="sendBtn" class="px-4 py-2 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-2xl font-medium disabled:opacity-50">
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- 채팅방 목록 (슬라이드 패널) -->
  <div id="roomListPanel" class="fixed inset-0 z-40 hidden">
    <div class="absolute inset-0 bg-black/50 modal-backdrop" onclick="toggleRoomList()"></div>
    <div class="absolute right-0 top-0 bottom-0 w-80 max-w-[85vw] bg-white slide-in">
      <div class="flex flex-col h-full">
        <!-- 패널 헤더 -->
        <div class="bg-gradient-to-r from-purple-600 to-pink-600 text-white p-4 safe-top">
          <div class="flex items-center justify-between">
            <h3 class="font-bold">채팅방 목록</h3>
            <button onclick="toggleRoomList()" class="p-1">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>
        
        <!-- 새 채팅방 만들기 버튼 -->
        <div class="p-3 border-b">
          <button onclick="showCreateRoom()" class="w-full py-2 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg font-medium">
            <i class="fas fa-plus mr-2"></i>새 채팅방 만들기
          </button>
        </div>
        
        <!-- 메인 채팅방 -->
        <div class="p-3 border-b">
          <div onclick="selectRoom('main')" class="room-card p-3 rounded-lg border cursor-pointer" data-room="main">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <span class="text-2xl">🏠</span>
                <div>
                  <h4 class="font-medium text-sm">메인 채팅방</h4>
                  <p class="text-xs text-gray-500">모두가 함께하는 공간</p>
                </div>
              </div>
              <span class="bg-red-500 text-white text-xs px-2 py-1 rounded-full">HOT</span>
            </div>
            <div class="flex items-center gap-3 mt-2 text-xs text-gray-500">
              <span><i class="fas fa-users"></i> <span id="mainUsers">0</span></span>
              <span><i class="fas fa-comment"></i> <span id="mainMsgs">0</span></span>
            </div>
          </div>
        </div>
        
        <!-- 사용자 생성 채팅방 목록 -->
        <div class="flex-1 overflow-y-auto p-3">
          <div id="userRoomsList" class="space-y-2">
            <!-- 동적으로 채팅방 추가 -->
          </div>
        </div>
        
        <!-- 하단 안내 -->
        <div class="p-3 border-t bg-gray-50 text-center">
          <p class="text-xs text-gray-500">
            <i class="fas fa-info-circle"></i> 30분간 활동이 없으면 자동 삭제
          </p>
        </div>
      </div>
    </div>
  </div>
  
  <!-- 설정 모달 -->
  <div id="settingsModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/50 modal-backdrop" onclick="closeSettings()"></div>
    <div class="relative bg-white rounded-2xl w-full max-w-sm slide-in">
      <div class="p-6">
        <h3 class="text-lg font-bold mb-4">채팅 설정</h3>
        
        <div class="space-y-4">
          <div>
            <label class="text-sm font-medium text-gray-700 mb-1 block">닉네임 설정</label>
            <input 
              id="nicknameInput"
              type="text"
              placeholder="원하는 닉네임 입력"
              maxlength="20"
              class="w-full px-3 py-2 border rounded-lg input-focus"
            >
            <p class="text-xs text-gray-500 mt-1">비워두면 랜덤 닉네임이 생성됩니다</p>
          </div>
          
          <div class="bg-gray-50 rounded-lg p-3">
            <p class="text-sm text-gray-600">현재 닉네임</p>
            <p id="currentNickname" class="font-medium text-purple-600"></p>
          </div>
          
          <div class="border-t pt-4">
            <label class="flex items-center gap-2">
              <input type="checkbox" id="soundEnabled" class="rounded">
              <span class="text-sm">알림음 켜기</span>
            </label>
          </div>
        </div>
        
        <div class="flex gap-2 mt-6">
          <button onclick="closeSettings()" class="flex-1 py-2 border rounded-lg">
            취소
          </button>
          <button onclick="saveSettings()" class="flex-1 py-2 bg-purple-600 text-white rounded-lg">
            저장
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- 채팅방 생성 모달 -->
  <div id="createRoomModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/50 modal-backdrop" onclick="closeCreateRoom()"></div>
    <div class="relative bg-white rounded-2xl w-full max-w-sm slide-in">
      <div class="p-6">
        <h3 class="text-lg font-bold mb-4">새 채팅방 만들기</h3>
        
        <div class="space-y-4">
          <div>
            <label class="text-sm font-medium text-gray-700 mb-1 block">채팅방 이름</label>
            <input 
              id="newRoomName"
              type="text"
              placeholder="예: 100m 스프린터 모임"
              maxlength="30"
              class="w-full px-3 py-2 border rounded-lg input-focus"
            >
          </div>
          
          <div>
            <label class="text-sm font-medium text-gray-700 mb-1 block">설명 (선택)</label>
            <input 
              id="newRoomDesc"
              type="text"
              placeholder="예: 단거리 선수들 환영!"
              maxlength="50"
              class="w-full px-3 py-2 border rounded-lg input-focus"
            >
          </div>
          
          <div>
            <label class="text-sm font-medium text-gray-700 mb-1 block">아이콘 선택</label>
            <div class="grid grid-cols-8 gap-1">
              <button type="button" onclick="selectIcon('🏃')" class="icon-btn p-2 border rounded hover:bg-purple-100" data-icon="🏃">🏃</button>
              <button type="button" onclick="selectIcon('🏃‍♀️')" class="icon-btn p-2 border rounded hover:bg-purple-100" data-icon="🏃‍♀️">🏃‍♀️</button>
              <button type="button" onclick="selectIcon('🏅')" class="icon-btn p-2 border rounded hover:bg-purple-100" data-icon="🏅">🏅</button>
              <button type="button" onclick="selectIcon('🏆')" class="icon-btn p-2 border rounded hover:bg-purple-100" data-icon="🏆">🏆</button>
              <button type="button" onclick="selectIcon('⚡')" class="icon-btn p-2 border rounded hover:bg-purple-100" data-icon="⚡">⚡</button>
              <button type="button" onclick="selectIcon('💪')" class="icon-btn p-2 border rounded hover:bg-purple-100" data-icon="💪">💪</button>
              <button type="button" onclick="selectIcon('🔥')" class="icon-btn p-2 border rounded hover:bg-purple-100" data-icon="🔥">🔥</button>
              <button type="button" onclick="selectIcon('🎯')" class="icon-btn p-2 border rounded hover:bg-purple-100" data-icon="🎯">🎯</button>
            </div>
            <input type="hidden" id="selectedIcon" value="🏃">
          </div>
        </div>
        
        <div class="flex gap-2 mt-6">
          <button onclick="closeCreateRoom()" class="flex-1 py-2 border rounded-lg">
            취소
          </button>
          <button onclick="createRoom()" class="flex-1 py-2 bg-purple-600 text-white rounded-lg">
            만들기
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- 이모지 피커 -->
  <div id="emojiPicker" class="fixed bottom-20 left-4 right-4 bg-white rounded-2xl shadow-xl p-4 hidden z-30 safe-bottom">
    <div class="grid grid-cols-8 gap-2 max-h-48 overflow-y-auto">
      <!-- 이모지 동적 추가 -->
    </div>
  </div>
  
  <!-- 토스트 메시지 -->
  <div id="toast" class="fixed top-20 left-4 right-4 bg-black/90 text-white px-4 py-3 rounded-lg hidden z-50 text-sm text-center">
    <span id="toastMsg"></span>
  </div>
  
  <script src="active-users.js"></script>
  <script src="chat-mobile-system.js"></script>
</body>
</html>