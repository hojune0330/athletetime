<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>ìœ¡ìƒí†¡ - ì‹¤ì‹œê°„ ì±„íŒ… | ì• ìŠ¬ë¦¬íŠ¸ íƒ€ì„</title>
  
  <!-- PWA ë©”íƒ€ íƒœê·¸ -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#667eea">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="ìœ¡ìƒí†¡">
  <link rel="apple-touch-icon" href="/icon-192.png">
  
  <script src="event-chat-rooms.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    html {
      height: 100%;
      overflow: hidden;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Malgun Gothic', sans-serif;
      background: #0a0a0a;
      color: #ffffff;
      height: 100%;
      height: 100vh;
      height: 100dvh; /* Dynamic viewport height for mobile */
      height: -webkit-fill-available;
      overflow: hidden;
      position: fixed;
      width: 100%;
      top: 0;
      left: 0;
      display: flex;
      flex-direction: column;
    }
    
    /* ë ˆì´ì•„ì›ƒ */
    .chat-container {
      display: flex;
      height: 100%;
      width: 100%;
      position: relative;
      overflow: hidden;
      flex: 1;
    }
    
    /* ì‚¬ì´ë“œë°” */
    .sidebar {
      width: 280px;
      background: #111111;
      border-right: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      flex-direction: column;
    }
    
    .sidebar-header {
      padding: 20px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .logo {
      font-size: 1.2rem;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .home-button {
      padding: 8px 16px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.3s;
      text-decoration: none;
      color: white;
    }
    
    .home-button:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    
    /* í”„ë¡œí•„ ì„¹ì…˜ */
    .profile-section {
      padding: 15px;
      background: rgba(255, 255, 255, 0.02);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .profile-info {
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      padding: 10px;
      border-radius: 8px;
      transition: background 0.3s;
    }
    
    .profile-info:hover {
      background: rgba(255, 255, 255, 0.05);
    }
    
    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea, #ec4899);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1.2rem;
    }
    
    .username {
      flex: 1;
    }
    
    .username-main {
      font-weight: 600;
      font-size: 0.95rem;
    }
    
    .username-status {
      font-size: 0.75rem;
      color: #10b981;
      display: flex;
      align-items: center;
      gap: 4px;
      margin-top: 2px;
    }
    
    /* í†µê³„ ì„¹ì…˜ */
    .stats-section {
      padding: 15px;
      background: rgba(102, 126, 234, 0.05);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }
    
    .stat-item {
      text-align: center;
    }
    
    .stat-value {
      font-size: 1.2rem;
      font-weight: bold;
      color: #667eea;
    }
    
    .stat-label {
      font-size: 0.7rem;
      color: #999;
      margin-top: 2px;
    }
    
    /* ì±„íŒ…ë°© ë¦¬ìŠ¤íŠ¸ */
    .room-list {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }
    
    .room-section-title {
      font-size: 0.75rem;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 10px 10px 5px;
      font-weight: 600;
    }
    
    .room-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      margin-bottom: 4px;
      position: relative;
    }
    
    .room-item:hover {
      background: rgba(255, 255, 255, 0.05);
    }
    
    .room-item.active {
      background: rgba(102, 126, 234, 0.15);
      border-left: 3px solid #667eea;
    }
    
    .room-icon {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      background: linear-gradient(135deg, #667eea, #764ba2);
    }
    
    .room-info {
      flex: 1;
    }
    
    .room-name {
      font-weight: 600;
      font-size: 0.9rem;
      margin-bottom: 2px;
    }
    
    .room-meta {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.75rem;
      color: #999;
    }
    
    .room-users {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .room-timer {
      position: absolute;
      top: 5px;
      right: 10px;
      font-size: 0.65rem;
      color: #f59e0b;
      display: flex;
      align-items: center;
      gap: 3px;
    }
    
    /* ì´ë²¤íŠ¸ ë£¸ ìŠ¤íƒ€ì¼ */
    .event-room {
      position: relative;
      overflow: hidden;
    }
    
    .event-room::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(245, 158, 11, 0.2), transparent);
      animation: shimmer 3s infinite;
    }
    
    @keyframes shimmer {
      0% { left: -100%; }
      100% { left: 100%; }
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    /* ìƒˆ ë°© ë§Œë“¤ê¸° ë²„íŠ¼ */
    .create-room-btn {
      margin: 10px;
      padding: 12px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border: none;
      border-radius: 8px;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .create-room-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }
    
    /* ë©”ì¸ ì±„íŒ… ì˜ì—­ */
    .chat-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #0a0a0a;
      position: relative;
      min-height: 0; /* Important for flex children */
      overflow: hidden; /* Prevent overflow */
      height: 100%;
    }
    
    .chat-header {
      height: 60px;
      background: #111111;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      padding: 0 20px;
      justify-content: space-between;
    }
    
    .chat-header-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .chat-header-title {
      font-size: 1.1rem;
      font-weight: 600;
    }
    
    .chat-header-users {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 20px;
      font-size: 0.85rem;
    }
    
    .online-dot {
      width: 8px;
      height: 8px;
      background: #10b981;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.2); opacity: 0.8; }
    }
    
    /* ë©”ì‹œì§€ ì˜ì—­ */
    .messages-container {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 15px;
      min-height: 0; /* Important for proper scrolling */
      -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
    }
    
    /* ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
    .message {
      display: flex;
      gap: 12px;
      animation: fadeInUp 0.3s ease-out;
      max-width: 100%;
    }
    
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .message-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea, #ec4899);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 0.9rem;
      flex-shrink: 0;
    }
    
    .message-content {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    
    .message-header {
      display: flex;
      align-items: baseline;
      gap: 10px;
      margin-bottom: 4px;
    }
    
    .message-username {
      font-weight: 600;
      font-size: 0.9rem;
      color: #667eea;
    }
    
    .message-time {
      font-size: 0.75rem;
      color: #666;
    }
    
    .message-text {
      color: #e0e0e0;
      line-height: 1.5;
      word-wrap: break-word;
      max-width: 70%;
      display: inline-block;
      background: rgba(255, 255, 255, 0.05);
      padding: 10px 15px;
      border-radius: 12px;
    }
    
    .message.own {
      flex-direction: row-reverse;
    }
    
    .message.own .message-content {
      align-items: flex-end;
      text-align: right;
    }
    
    .message.own .message-header {
      flex-direction: row-reverse;
      justify-content: flex-start;
    }
    
    .message.own .message-username {
      color: #ec4899;
    }
    
    .message.own .message-text {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(236, 72, 153, 0.1));
      padding: 10px 15px;
      border-radius: 12px;
      display: inline-block;
      max-width: 70%;
    }
    
    /* ì‹œìŠ¤í…œ ë©”ì‹œì§€ */
    .message.system {
      justify-content: center;
      font-size: 0.85rem;
      color: #666;
      font-style: italic;
    }
    
    /* ì´ë¯¸ì§€ ì—…ë¡œë“œ ê´€ë ¨ ìŠ¤íƒ€ì¼ */
    .message-image {
      margin-top: 8px;
      max-width: 300px;
      cursor: pointer;
      border-radius: 8px;
      transition: transform 0.2s;
    }
    
    .message-image:hover {
      transform: scale(1.02);
    }
    
    .message-image img {
      width: 100%;
      border-radius: 8px;
      display: block;
    }
    
    /* ì´ëª¨ì§€ ë°˜ì‘ */
    .message-reactions {
      display: flex;
      gap: 4px;
      margin-top: 4px;
      flex-wrap: wrap;
    }
    
    .reaction-button {
      padding: 2px 6px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      cursor: pointer;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 3px;
      transition: all 0.2s;
    }
    
    .reaction-button:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: scale(1.05);
    }
    
    /* ë‹µì¥ */
    .message-reply {
      background: rgba(102, 126, 234, 0.1);
      border-left: 2px solid #667eea;
      padding: 4px 8px;
      margin-bottom: 4px;
      border-radius: 4px;
      font-size: 12px;
      color: #999;
    }
    
    .message-actions {
      opacity: 0;
      display: flex;
      gap: 8px;
      margin-top: 4px;
      transition: opacity 0.2s;
    }
    
    .message:hover .message-actions {
      opacity: 1;
    }
    
    .action-button {
      background: none;
      border: none;
      color: #666;
      cursor: pointer;
      font-size: 12px;
      padding: 2px 4px;
      transition: color 0.2s;
    }
    
    .action-button:hover {
      color: #667eea;
    }
    
    /* íƒ€ì´í•‘ í‘œì‹œ */
    .typing-indicator {
      display: none;
      padding: 10px 20px;
      font-size: 0.85rem;
      color: #999;
      font-style: italic;
    }
    
    .typing-indicator.show {
      display: block;
    }
    
    /* ì…ë ¥ ì˜ì—­ */
    .input-container {
      padding: 20px;
      background: #111111;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      flex-shrink: 0; /* Prevent shrinking */
      position: relative;
      z-index: 10; /* Ensure it stays above other content */
      margin-top: auto; /* Push to bottom */
    }
    
    .input-wrapper {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .attachment-button {
      padding: 10px;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      border-radius: 8px;
      color: #999;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .attachment-button:hover:not(:disabled) {
      background: rgba(102, 126, 234, 0.2);
      color: #667eea;
    }
    
    .attachment-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .image-preview {
      margin-top: 10px;
      position: relative;
      max-width: 200px;
    }
    
    .image-preview img {
      width: 100%;
      border-radius: 8px;
      border: 2px solid rgba(102, 126, 234, 0.3);
    }
    
    .cancel-upload {
      position: absolute;
      top: -8px;
      right: -8px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #ef4444;
      border: none;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }
    
    .message-input {
      flex: 1;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 25px;
      padding: 12px 20px;
      color: white;
      font-size: 0.95rem;
      outline: none;
      transition: all 0.3s;
    }
    
    .message-input:focus {
      border-color: #667eea;
      background: rgba(255, 255, 255, 0.08);
    }
    
    .send-button {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border: none;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }
    
    .send-button:hover {
      transform: scale(1.05);
    }
    
    .send-button:active {
      transform: scale(0.95);
    }
    
    /* ëª¨ë‹¬ */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .modal.active {
      display: flex;
    }
    
    /* ë¼ì´íŠ¸ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
    #imageLightbox {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    }
    
    .lightbox-content {
      position: relative;
      max-width: 90vw;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .lightbox-close {
      position: absolute;
      top: -40px;
      right: 0;
      color: white;
      font-size: 36px;
      cursor: pointer;
      transition: color 0.3s;
    }
    
    .lightbox-close:hover {
      color: #667eea;
    }
    
    .modal-content {
      background: #1a1a1a;
      border-radius: 16px;
      padding: 30px;
      max-width: 400px;
      width: 100%;
      animation: modalSlideUp 0.3s ease-out;
    }
    
    @keyframes modalSlideUp {
      from {
        transform: translateY(50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    /* ëª¨ë°”ì¼ ëŒ€ì‘ */
    @media (max-width: 768px) {
      body {
        height: 100vh;
        height: 100dvh;
        height: -webkit-fill-available;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        overflow: hidden;
      }
      
      .chat-container {
        height: 100vh;
        height: 100dvh;
        height: -webkit-fill-available;
        display: flex;
        flex-direction: row;
        position: relative;
        overflow: hidden;
      }
      
      .sidebar {
        position: fixed;
        left: -280px;
        z-index: 100;
        transition: left 0.3s;
        height: 100vh;
        height: 100dvh;
        height: -webkit-fill-available;
        top: 0;
        bottom: 0;
      }
      
      .sidebar.open {
        left: 0;
      }
      
      .chat-main {
        width: 100%;
        height: 100vh;
        height: 100dvh;
        height: -webkit-fill-available;
        display: flex;
        flex-direction: column;
        position: relative;
        overflow: hidden;
      }
      
      .chat-header {
        flex-shrink: 0;
        flex-grow: 0;
        height: 60px;
        position: sticky;
        top: 0;
        z-index: 50;
      }
      
      .messages-container {
        flex: 1 1 auto;
        min-height: 0;
        overflow-y: auto;
        overflow-x: hidden;
        -webkit-overflow-scrolling: touch;
        padding: 20px;
        padding-bottom: 30px;
        position: relative;
      }
      
      .input-container {
        flex-shrink: 0;
        flex-grow: 0;
        padding: 12px;
        padding-bottom: calc(12px + env(safe-area-inset-bottom, 0)); /* iOS safe area */
        position: sticky;
        bottom: 0;
        background: #111111;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        z-index: 100;
        width: 100%;
      }
      
      .mobile-menu-btn {
        display: flex;
      }
      
      .stats-section {
        display: none;
      }
      
      /* Adjust message spacing for mobile */
      .message-text {
        max-width: 85%;
      }
      
      /* Adjust image preview for mobile */
      .image-preview {
        max-width: 150px;
      }
      
      /* Input styling for mobile */
      .message-input {
        font-size: 16px !important; /* Prevent zoom on iOS */
      }
      
      .input-wrapper {
        flex-wrap: nowrap;
        gap: 8px;
      }
      
      .attachment-button,
      .send-button {
        flex-shrink: 0;
        padding: 8px;
        min-width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      /* Keyboard visible adjustment */
      .keyboard-visible .messages-container {
        padding-bottom: 60px; /* Extra space when keyboard is visible */
      }
      
      .keyboard-visible .input-container {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 1000;
        transform: translateY(0);
      }
      
      /* iOS specific fixes */
      @supports (-webkit-touch-callout: none) {
        .chat-container {
          height: -webkit-fill-available;
        }
        
        .chat-main {
          height: -webkit-fill-available;
          display: grid;
          grid-template-rows: auto 1fr auto;
          grid-template-areas: 
            "header"
            "messages"
            "input";
        }
        
        .chat-header {
          grid-area: header;
        }
        
        .messages-container {
          grid-area: messages;
          padding-bottom: 20px;
        }
        
        .input-container {
          grid-area: input;
        }
      }
      
      /* Alternative layout using flexbox with better constraints */
      .chat-main {
        max-height: 100vh;
        max-height: 100dvh;
      }
      
      /* Ensure input is always visible */
      .input-container {
        position: sticky;
        bottom: 0;
        min-height: 60px;
        max-height: 120px;
      }
    }
    
    @media (min-width: 769px) {
      .mobile-menu-btn {
        display: none;
      }
    }
    
    /* ìŠ¤í¬ë¡¤ë°” ì»¤ìŠ¤í…€ */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: #111;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #333;
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #444;
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <!-- ì‚¬ì´ë“œë°” -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="logo">
          <i class="fas fa-running"></i>
          <span>ìœ¡ìƒí†¡</span>
        </div>
        <a href="index.html" class="home-button">
          <i class="fas fa-home"></i> ë©”ì¸
        </a>
      </div>
      
      <!-- í”„ë¡œí•„ ì„¹ì…˜ -->
      <div class="profile-section">
        <div class="profile-info" onclick="openProfileModal()">
          <div class="avatar" id="userAvatar">?</div>
          <div class="username">
            <div class="username-main" id="userNickname">ì—°ê²° ì¤‘...</div>
            <div class="username-status">
              <i class="fas fa-circle" style="font-size: 6px;"></i>
              <span id="connectionStatus">ì—°ê²° ì¤‘</span>
            </div>
          </div>
          <i class="fas fa-cog" style="color: #666;"></i>
        </div>
      </div>
      
      <!-- ì‹¤ì‹œê°„ í†µê³„ -->
      <div class="stats-section">
        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-value" id="onlineCount">0</div>
            <div class="stat-label">ì ‘ì†ì</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="roomCount">0</div>
            <div class="stat-label">ì±„íŒ…ë°©</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="messageCount">0</div>
            <div class="stat-label">ë©”ì‹œì§€</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="roomUserCount">0</div>
            <div class="stat-label">í˜„ì¬ë°©</div>
          </div>
        </div>
      </div>
      
      <!-- ì±„íŒ…ë°© ë¦¬ìŠ¤íŠ¸ -->
      <div class="room-list" id="roomList">
        <div class="room-section-title">ë©”ì¸ ì±„íŒ…ë°©</div>
        <!-- ë™ì ìœ¼ë¡œ ìƒì„± -->
      </div>
      
      <!-- ìƒˆ ë°© ë§Œë“¤ê¸° ë²„íŠ¼ -->
      <button type="button" class="create-room-btn" onclick="openCreateRoomModal()">
        <i class="fas fa-plus"></i>
        <span>ìƒˆ ì±„íŒ…ë°© ë§Œë“¤ê¸°</span>
      </button>
    </div>
    
    <!-- ë©”ì¸ ì±„íŒ… ì˜ì—­ -->
    <div class="chat-main">
      <div class="chat-header">
        <div class="chat-header-info">
          <button type="button" onclick="toggleSidebar()" class="mobile-menu-btn" style="background: none; border: none; color: white; font-size: 1.2rem;">
            <i class="fas fa-bars"></i>
          </button>
          <div class="chat-header-title" id="currentRoomName">ì±„íŒ…ë°© ì„ íƒ</div>
          <div class="chat-header-users">
            <div class="online-dot"></div>
            <span id="currentRoomUsers">0ëª…</span>
          </div>
        </div>
        <button type="button" onclick="openGuideModal()" style="background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: #999; padding: 6px 12px; border-radius: 8px; font-size: 0.8rem; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 5px;" onmouseover="this.style.background='rgba(255, 255, 255, 0.2)'; this.style.color='white'" onmouseout="this.style.background='rgba(255, 255, 255, 0.1)'; this.style.color='#999'">
          <i class="fas fa-info-circle"></i>
          <span>ì•ˆë‚´</span>
        </button>
      </div>
      
      <!-- ë©”ì‹œì§€ ì˜ì—­ -->
      <div class="messages-container" id="messagesContainer">
        <div class="message system">
          <span>ì±„íŒ…ë°©ì„ ì„ íƒí•˜ì„¸ìš”</span>
        </div>
      </div>
      
      <!-- íƒ€ì´í•‘ í‘œì‹œ -->
      <div class="typing-indicator" id="typingIndicator"></div>
      
      <!-- ì…ë ¥ ì˜ì—­ -->
      <div class="input-container">
        <div class="input-wrapper">
          <button type="button" class="attachment-button" onclick="triggerImageUpload()" id="attachBtn" disabled>
            <i class="fas fa-image"></i>
          </button>
          <input type="file" id="imageUpload" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
          <input type="text" class="message-input" id="messageInput" 
                 placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." 
                 onkeypress="if(event.key==='Enter' && !event.shiftKey) sendMessage()"
                 oninput="handleTyping()"
                 disabled aria-label="messageInputì— ì…ë ¥">
          <button type="button" class="send-button" onclick="sendMessage()" id="sendBtn" disabled>
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
        <!-- ì´ë¯¸ì§€ í”„ë¦¬ë·° ì˜ì—­ -->
        <div id="imagePreview" class="image-preview" style="display: none;">
          <img id="previewImg" src="" alt="Preview">
          <button type="button" onclick="cancelImageUpload()" class="cancel-upload">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- í”„ë¡œí•„ ì„¤ì • ëª¨ë‹¬ -->
  <div class="modal" id="profileModal">
    <div class="modal-content">
      <h3 style="font-size: 1.3rem; font-weight: 700; margin-bottom: 20px; background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
        í”„ë¡œí•„ ì„¤ì •
      </h3>
      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; color: #999; font-size: 0.85rem;">ë‹‰ë„¤ì„</label>
        <input type="text" id="nicknameInput" placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="20"
               style="width: 100%; padding: 12px 16px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; color: white; font-size: 0.95rem; outline: none;" aria-label="nicknameInputì— ì…ë ¥">
      </div>
      <div style="margin-bottom: 15px;">
        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
          <input type="checkbox" id="anonymousCheck" style="width: 18px; height: 18px;">
          <span style="color: #999; font-size: 0.9rem;">ìµëª…ìœ¼ë¡œ í™œë™í•˜ê¸°</span>
        </label>
      </div>
      <div style="margin-bottom: 20px;">
        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
          <input type="checkbox" id="soundCheck" style="width: 18px; height: 18px;" checked>
          <span style="color: #999; font-size: 0.9rem;">ğŸ”” ìƒˆ ë©”ì‹œì§€ ì•Œë¦¼ìŒ</span>
        </label>
      </div>
      <div style="display: flex; gap: 10px; justify-content: flex-end;">
        <button type="button" onclick="closeProfileModal()" style="padding: 10px 20px; background: rgba(255, 255, 255, 0.1); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
          ì·¨ì†Œ
        </button>
        <button type="button" onclick="saveProfile()" style="padding: 10px 20px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
          ì €ì¥
        </button>
      </div>
    </div>
  </div>
  
  <!-- ì±„íŒ…ë°© ìƒì„± ëª¨ë‹¬ -->
  <div class="modal" id="createRoomModal">
    <div class="modal-content">
      <h3 style="font-size: 1.3rem; font-weight: 700; margin-bottom: 20px; background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
        ìƒˆ ì±„íŒ…ë°© ë§Œë“¤ê¸°
      </h3>
      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; color: #999; font-size: 0.85rem;">ì±„íŒ…ë°© ì´ë¦„</label>
        <input type="text" id="roomNameInput" placeholder="ì±„íŒ…ë°© ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="30"
               style="width: 100%; padding: 12px 16px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; color: white; font-size: 0.95rem; outline: none;" aria-label="roomNameInputì— ì…ë ¥">
      </div>
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 5px; color: #999; font-size: 0.85rem;">ì„¤ëª… (ì„ íƒ)</label>
        <input type="text" id="roomDescInput" placeholder="ì±„íŒ…ë°© ì„¤ëª…" maxlength="100"
               style="width: 100%; padding: 12px 16px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; color: white; font-size: 0.95rem; outline: none;" aria-label="roomDescInputì— ì…ë ¥">
      </div>
      <div style="padding: 15px; background: rgba(243, 158, 11, 0.1); border-radius: 8px; margin-bottom: 20px;">
        <p style="color: #f59e0b; font-size: 0.85rem; line-height: 1.5;">
          <i class="fas fa-info-circle"></i> 
          ìƒì„±ëœ ì±„íŒ…ë°©ì€ 30ë¶„ê°„ í™œë™ì´ ì—†ìœ¼ë©´ ìë™ìœ¼ë¡œ ì‚­ì œë©ë‹ˆë‹¤.
        </p>
      </div>
      <div style="display: flex; gap: 10px; justify-content: flex-end;">
        <button type="button" onclick="closeCreateRoomModal()" style="padding: 10px 20px; background: rgba(255, 255, 255, 0.1); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
          ì·¨ì†Œ
        </button>
        <button type="button" onclick="createRoom()" style="padding: 10px 20px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
          ë§Œë“¤ê¸°
        </button>
      </div>
    </div>
  </div>
  
  <!-- ì´ë¯¸ì§€ ë¼ì´íŠ¸ë°•ìŠ¤ ëª¨ë‹¬ -->
  <div class="modal" id="imageLightbox" onclick="closeLightbox(event)" style="display: none; z-index: 10000;">
    <div class="lightbox-content" onclick="event.stopPropagation()">
      <span class="lightbox-close" onclick="closeLightbox()">&times;</span>
      <img id="lightboxImage" src="" alt="Full size image" style="max-width: 90vw; max-height: 90vh;">
      <div class="lightbox-controls" style="margin-top: 20px; text-align: center;">
        <button onclick="downloadImage()" class="lightbox-btn" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">
          <i class="fas fa-download"></i> ë‹¤ìš´ë¡œë“œ
        </button>
      </div>
    </div>
  </div>
  
  <!-- ì´ëª¨ì§€ ì„ íƒê¸° -->
  <div id="emojiPicker" class="emoji-picker" style="display: none; position: absolute; background: #1a1a1a; border: 1px solid #333; border-radius: 8px; padding: 8px; z-index: 1000;">
    <div class="emoji-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px;">
      <span onclick="addReaction('ğŸ‘')" style="cursor: pointer; padding: 4px; font-size: 20px;">ğŸ‘</span>
      <span onclick="addReaction('â¤ï¸')" style="cursor: pointer; padding: 4px; font-size: 20px;">â¤ï¸</span>
      <span onclick="addReaction('ğŸ˜‚')" style="cursor: pointer; padding: 4px; font-size: 20px;">ğŸ˜‚</span>
      <span onclick="addReaction('ğŸ˜®')" style="cursor: pointer; padding: 4px; font-size: 20px;">ğŸ˜®</span>
      <span onclick="addReaction('ğŸ˜¢')" style="cursor: pointer; padding: 4px; font-size: 20px;">ğŸ˜¢</span>
      <span onclick="addReaction('ğŸ”¥')" style="cursor: pointer; padding: 4px; font-size: 20px;">ğŸ”¥</span>
      <span onclick="addReaction('ğŸ‘')" style="cursor: pointer; padding: 4px; font-size: 20px;">ğŸ‘</span>
      <span onclick="addReaction('ğŸ’¯')" style="cursor: pointer; padding: 4px; font-size: 20px;">ğŸ’¯</span>
    </div>
  </div>
  
  <!-- ì±„íŒ… ì•ˆë‚´ì‚¬í•­ ëª¨ë‹¬ -->
  <div id="guideModal" class="modal">
    <div class="modal-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
        <h2 style="font-size: 1.5rem; font-weight: 700; background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
          ğŸ“œ ì±„íŒ…ë°© ì´ìš© ì•ˆë‚´
        </h2>
        <button type="button" onclick="closeGuideModal()" style="background: none; border: none; color: #999; font-size: 1.5rem; cursor: pointer; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">
          Ã—
        </button>
      </div>
      
      <div style="space-y: 20px;">
        <!-- ê¸°ë³¸ ì •ë³´ -->
        <div style="margin-bottom: 20px;">
          <h3 style="color: #667eea; font-size: 1.1rem; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
            <i class="fas fa-clock"></i> ë©”ì‹œì§€ ë³´ê´€ ì •ì±…
          </h3>
          <div style="background: rgba(102, 126, 234, 0.1); padding: 12px; border-radius: 8px; border-left: 3px solid #667eea;">
            <p style="color: #e0e0e0; line-height: 1.6; font-size: 0.9rem;">
              â€¢ ëª¨ë“  ì±„íŒ… ë©”ì‹œì§€ëŠ” <strong style="color: #ec4899;">24ì‹œê°„ í›„ ìë™ ì‚­ì œ</strong>ë©ë‹ˆë‹¤.<br>
              â€¢ ì‚¬ìš©ì ìƒì„± ì±„íŒ…ë°©ì€ <strong style="color: #ec4899;">30ë¶„ê°„ í™œë™ì´ ì—†ìœ¼ë©´ ìë™ ì‚­ì œ</strong>ë©ë‹ˆë‹¤.<br>
              â€¢ ì¤‘ìš”í•œ ëŒ€í™”ëŠ” ê°œì¸ì ìœ¼ë¡œ ì €ì¥í•´ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.
            </p>
          </div>
        </div>

        <!-- ê²½ê³  ì‚¬í•­ -->
        <div style="margin-bottom: 20px;">
          <h3 style="color: #ef4444; font-size: 1.1rem; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
            <i class="fas fa-exclamation-triangle"></i> ê¸ˆì§€ í–‰ìœ„ ë° ì²˜ë²Œ
          </h3>
          <div style="background: rgba(239, 68, 68, 0.1); padding: 12px; border-radius: 8px; border-left: 3px solid #ef4444;">
            <p style="color: #fca5a5; line-height: 1.8; font-size: 0.9rem; font-weight: 500;">
              ë‹¤ìŒ í–‰ìœ„ëŠ” <strong>ì—„ê²©íˆ ê¸ˆì§€</strong>ë˜ë©°, ìœ„ë°˜ ì‹œ <strong>ê²€ì°° ê³ ë°œ ë° ë²•ì  ì²˜ë²Œ</strong>ì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:
            </p>
            <ul style="color: #fca5a5; line-height: 1.8; font-size: 0.85rem; margin-top: 10px; padding-left: 20px;">
              <li>ğŸš« <strong>ë¶ˆë²• ì½˜í…ì¸ </strong>: ìŒë€ë¬¼, ë„ë°•, ì•½ë¬¼ ê±°ë˜ ë“±</li>
              <li>ğŸ“¢ <strong>ìŠ¤íŒ¸ ë° ê´‘ê³ </strong>: ë¬´ë‹¨ í™ë³´, ìƒì—…ì  ê´‘ê³ </li>
              <li>ğŸ¤¬ <strong>ìš•ì„¤ ë° ë¹„ë°©</strong>: íƒ€ì¸ì— ëŒ€í•œ ëª¨ìš•, ëª…ì˜ˆí›¼ì†</li>
              <li>ğŸ™… <strong>ì„±í¬ë¡±</strong>: ì„±ì  ëª¨ìš•, í˜‘ë°•, ìŠ¤í† í‚¹</li>
              <li>ğŸ†˜ <strong>ê°œì¸ì •ë³´ ìœ ì¶œ</strong>: íƒ€ì¸ì˜ ê°œì¸ì •ë³´ ë¬´ë‹¨ ê³µê°œ</li>
              <li>âš ï¸ <strong>í—ˆìœ„ ì‚¬ì‹¤ ìœ í¬</strong>: ê°€ì§œë‰´ìŠ¤, ì˜ëª»ëœ ì •ë³´ í™•ì‚°</li>
            </ul>
            <p style="color: #fbbf24; margin-top: 15px; font-size: 0.85rem; padding: 10px; background: rgba(251, 191, 36, 0.1); border-radius: 4px;">
              âš ï¸ <strong>ì²˜ë²Œ</strong>: í˜•ë²• ë° ê´€ë ¨ ë²•ë¥ ì— ë”°ë¼ <strong>ì§•ì—­ ë˜ëŠ” ë²Œê¸ˆí˜•</strong>ì— ì²˜í•´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </p>
          </div>
        </div>

        <!-- ê°œì¸ì •ë³´ ë³´í˜¸ -->
        <div style="margin-bottom: 20px;">
          <h3 style="color: #10b981; font-size: 1.1rem; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
            <i class="fas fa-shield-alt"></i> ê°œì¸ì •ë³´ ë³´í˜¸
          </h3>
          <div style="background: rgba(16, 185, 129, 0.1); padding: 12px; border-radius: 8px; border-left: 3px solid #10b981;">
            <p style="color: #e0e0e0; line-height: 1.6; font-size: 0.9rem;">
              â€¢ ë‹‰ë„¤ì„ê³¼ ì±„íŒ… ë‚´ìš©ë§Œ ì €ì¥ë˜ë©°, ê°œì¸ ì‹ë³„ ì •ë³´ëŠ” ìˆ˜ì§‘í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.<br>
              â€¢ ìµëª… ëª¨ë“œë¥¼ ì‚¬ìš©í•˜ì—¬ ì™„ì „í•œ ìµëª…ì„±ì„ ë³´ì¥ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
              â€¢ IP ì£¼ì†ŒëŠ” ë²•ì  ìš”ì²­ ì‹œì—ë§Œ ì œê³µë©ë‹ˆë‹¤.<br>
              â€¢ ëª¨ë“  ë°ì´í„°ëŠ” SSL ì•”í˜¸í™”ë¥¼ í†µí•´ ì•ˆì „í•˜ê²Œ ì „ì†¡ë©ë‹ˆë‹¤.
            </p>
          </div>
        </div>

        <!-- ì´ìš© íŒ -->
        <div style="margin-bottom: 20px;">
          <h3 style="color: #f59e0b; font-size: 1.1rem; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
            <i class="fas fa-lightbulb"></i> ì´ìš© íŒ
          </h3>
          <div style="background: rgba(245, 158, 11, 0.1); padding: 12px; border-radius: 8px; border-left: 3px solid #f59e0b;">
            <ul style="color: #e0e0e0; line-height: 1.6; font-size: 0.9rem; padding-left: 20px;">
              <li>ìƒˆ ì±„íŒ…ë°© ìƒì„±: í•˜ë‹¨ "+" ë²„íŠ¼ í´ë¦­</li>
              <li>í”„ë¡œí•„ ë³€ê²½: ì¢Œì¸¡ ìƒë‹¨ í”„ë¡œí•„ í´ë¦­</li>
              <li>ìµëª… ëª¨ë“œ: í”„ë¡œí•„ ì„¤ì •ì—ì„œ í™œì„±í™”</li>
              <li>ë°© ë‚˜ê°€ê¸°: ë‹¤ë¥¸ ë°© ì„ íƒ ì‹œ ìë™ í‡´ì¥</li>
            </ul>
          </div>
        </div>

        <!-- ë¬¸ì˜ ì •ë³´ -->
        <div>
          <h3 style="color: #8b5cf6; font-size: 1.1rem; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
            <i class="fas fa-envelope"></i> ë¬¸ì˜ ë° ì‹ ê³ 
          </h3>
          <div style="background: rgba(139, 92, 246, 0.1); padding: 12px; border-radius: 8px; border-left: 3px solid #8b5cf6;">
            <p style="color: #e0e0e0; line-height: 1.6; font-size: 0.9rem;">
              ë¶€ì ì ˆí•œ í–‰ìœ„ë¥¼ ë°œê²¬í•˜ì‹  ê²½ìš° ì¦‰ì‹œ ì‹ ê³ í•´ ì£¼ì„¸ìš”.<br>
              ë¬¸ì˜: admin@athletetime.com
            </p>
          </div>
        </div>
      </div>
      
      <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid rgba(255, 255, 255, 0.1); text-align: center;">
        <button type="button" onclick="closeGuideModal()" style="padding: 12px 30px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.95rem;">
          í™•ì¸í–ˆìŠµë‹ˆë‹¤
        </button>
      </div>
    </div>
  </div>
  
  <script>
    // ì „ì—­ ë³€ìˆ˜
    let ws = null;
    let currentRoom = null;
    let userProfile = {
      nickname: null,
      avatar: '?',
      anonymous: false,
      userId: null,
      soundEnabled: true  // ì•Œë¦¼ìŒ ê¸°ë³¸ í™œì„±í™”
    };
    let typingTimeout = null;
    let isTyping = false;
    let reconnectAttempts = 0;
    let roomTimers = new Map();
    let unreadCount = 0;
    let isPageVisible = true;
    let pendingImage = null;  // ì—…ë¡œë“œ ëŒ€ê¸° ì¤‘ì¸ ì´ë¯¸ì§€
    let replyToMessage = null;  // ë‹µì¥í•  ë©”ì‹œì§€
    let currentEmojiTarget = null;  // ì´ëª¨ì§€ ë°˜ì‘ ëŒ€ìƒ ë©”ì‹œì§€
    let messageReactions = new Map();  // ë©”ì‹œì§€ë³„ ë°˜ì‘ ì €ì¥
    let userStatuses = new Map();  // ì‚¬ìš©ì ìƒíƒœ ì €ì¥
    
    // ì´ˆê¸°í™”
    function init() {
      loadProfile();
      connectWebSocket();
      
      // UI ì´ˆê¸° ì„¤ì •
      document.getElementById('currentRoomName').textContent = 'ë©”ì¸ ì±„íŒ…ë°©';
      document.getElementById('messageInput').placeholder = 'ì—°ê²° ì¤‘...';
      
      // ëª¨ë°”ì¼ í‚¤ë³´ë“œ ê°ì§€
      setupMobileKeyboardDetection();
    }
    
    // ëª¨ë°”ì¼ í‚¤ë³´ë“œ ê°ì§€ ì„¤ì •
    function setupMobileKeyboardDetection() {
      const isMobile = window.innerWidth <= 768;
      if (!isMobile) return;
      
      const input = document.getElementById('messageInput');
      const chatMain = document.querySelector('.chat-main');
      
      // Visual Viewport API ì‚¬ìš© (ë” ì •í™•í•œ í‚¤ë³´ë“œ ê°ì§€)
      if ('visualViewport' in window) {
        let lastHeight = window.visualViewport.height;
        
        window.visualViewport.addEventListener('resize', () => {
          const currentHeight = window.visualViewport.height;
          const hasKeyboard = currentHeight < window.screen.height * 0.75;
          
          if (hasKeyboard) {
            document.body.classList.add('keyboard-visible');
            // ì±„íŒ… ì˜ì—­ ë†’ì´ ì¡°ì ˆ
            if (chatMain) {
              const keyboardHeight = window.screen.height - currentHeight;
              chatMain.style.paddingBottom = `${keyboardHeight}px`;
            }
            scrollToBottom();
          } else {
            document.body.classList.remove('keyboard-visible');
            if (chatMain) {
              chatMain.style.paddingBottom = '0';
            }
          }
          
          lastHeight = currentHeight;
        });
      } else {
        // Fallback for older browsers
        let initialHeight = window.innerHeight;
        
        input.addEventListener('focus', function() {
          setTimeout(() => {
            const currentHeight = window.innerHeight;
            if (currentHeight < initialHeight * 0.75) {
              document.body.classList.add('keyboard-visible');
              scrollToBottom();
            }
          }, 300);
        });
        
        input.addEventListener('blur', function() {
          document.body.classList.remove('keyboard-visible');
          initialHeight = window.innerHeight;
        });
      }
      
      // iOS specific: prevent viewport bounce
      if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
        document.addEventListener('touchmove', function(e) {
          if (e.target.closest('.messages-container')) return;
          e.preventDefault();
        }, { passive: false });
      }
    }
    
    // ë©”ì‹œì§€ ì˜ì—­ ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ
    function scrollToBottom() {
      const container = document.getElementById('messagesContainer');
      if (container) {
        // ì¦‰ì‹œ ì‹¤í–‰
        container.scrollTop = container.scrollHeight;
        
        // ì• ë‹ˆë©”ì´ì…˜ í›„ ë‹¤ì‹œ ì‹¤í–‰
        requestAnimationFrame(() => {
          container.scrollTop = container.scrollHeight;
        });
        
        // ì´ë¯¸ì§€ ë¡œë“œ ë“±ì„ ìœ„í•´ ì§€ì—° ì‹¤í–‰
        setTimeout(() => {
          container.scrollTop = container.scrollHeight;
        }, 100);
      }
    }
    
    // í”„ë¡œí•„ ë¡œë“œ
    function loadProfile() {
      const saved = (function() { try { return localStorage.getItem('runningChatProfile'); } catch(e) { console.error('Storage error:', e); return null; } })();
      if (saved) {
        userProfile = JSON.parse(saved);
      } else {
        userProfile.userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        userProfile.nickname = `ìœ¡ìƒì¸${Math.floor(Math.random() * 10000)}`;
        userProfile.avatar = userProfile.nickname.substring(0, 1);
        userProfile.anonymous = false;
        saveProfileToStorage();
      }
      updateProfileUI();
    }
    
    // í”„ë¡œí•„ ì €ì¥
    function saveProfileToStorage() {
      (function() { try { return localStorage.setItem('runningChatProfile', JSON.stringify(userProfile)); } catch(e) { console.error('Storage error:', e); return null; } })();
    }
    
    // í”„ë¡œí•„ UI ì—…ë°ì´íŠ¸
    function updateProfileUI() {
      const displayName = userProfile.anonymous ? 'ìµëª…ì„ ìˆ˜' : userProfile.nickname;
      const displayAvatar = userProfile.anonymous ? 'ìµ' : userProfile.avatar;
      
      document.getElementById('userNickname').textContent = displayName;
      document.getElementById('userAvatar').textContent = displayAvatar;
    }
    
    // WebSocket ì—°ê²°
    function connectWebSocket() {
      // WebSocket URL ìë™ ê°ì§€ - ì‹¤ì œ í˜¸ìŠ¤íŒ… í™˜ê²½ ì§€ì›
      let wsUrl;
      const hostname = window.location.hostname;
      const protocol = window.location.protocol;
      
      // ë‹¤ì–‘í•œ í˜¸ìŠ¤íŒ… í™˜ê²½ ì²˜ë¦¬
      if (hostname.includes('e2b.dev')) {
        // E2B sandbox í™˜ê²½
        const sandboxId = hostname.split('.')[0].split('-').slice(1).join('-');
        wsUrl = `wss://3004-${sandboxId}.e2b.dev`;
      } else if (hostname === 'localhost' || hostname === '127.0.0.1') {
        // ë¡œì»¬ ê°œë°œ í™˜ê²½
        wsUrl = `ws://${hostname}:3004`;
      } else if (protocol === 'https:') {
        // HTTPS í˜¸ìŠ¤íŒ… í™˜ê²½ (Vercel, Netlify ë“±)
        // Render.com WebSocket ì„œë²„
        wsUrl = 'wss://athletetime-backend.onrender.com/ws';
      } else {
        // HTTP í˜¸ìŠ¤íŒ… í™˜ê²½
        wsUrl = 'wss://athletetime-backend.onrender.com/ws';
      }
      
      console.log('ğŸ”Œ WebSocket ì—°ê²° ì‹œë„:', wsUrl);
      
      try {
        ws = new WebSocket(wsUrl);
        
        ws.onopen = () => {
          // console.log('âœ… ì±„íŒ… ì„œë²„ ì—°ê²°ë¨'); // Production: removed
          reconnectAttempts = 0;
          document.getElementById('connectionStatus').textContent = 'ì˜¨ë¼ì¸';
          
          // ë©”ì¸ ì±„íŒ…ë°© í‘œì‹œ ë° ìë™ ì…ì¥
          const mainRoom = {
            id: 'main',
            name: 'ë©”ì¸ ì±„íŒ…ë°©',
            description: 'ëª¨ë“  ìœ¡ìƒì¸ë“¤ì´ í•¨ê»˜í•˜ëŠ” ê³µê°„',
            userCount: 0,
            active: true
          };
          
          // ê¸°ë³¸ ì±„íŒ…ë°© ëª©ë¡
          const defaultRooms = [
            { id: 'main', name: 'ë©”ì¸ ì±„íŒ…ë°©', icon: 'ğŸ ', desc: 'ëª¨ë‘ì˜ ì±„íŒ…ë°©', permanent: true, userCount: 0 },
            { id: 'general', name: 'ììœ ì±„íŒ…', icon: 'ğŸ’¬', desc: 'ììœ ë¡­ê²Œ ëŒ€í™”í•´ìš”', permanent: true, userCount: 0 },
            { id: 'running', name: 'ëŸ¬ë‹ í¬ë£¨', icon: 'ğŸƒ', desc: 'í•¨ê»˜ ë‹¬ë ¤ìš”', permanent: true, userCount: 0 },
            { id: 'track', name: 'íŠ¸ë™ í›ˆë ¨', icon: 'ğŸŸï¸', desc: 'íŠ¸ë™ í›ˆë ¨ ì •ë³´ ê³µìœ ', permanent: true, userCount: 0 }
          ];
          
          // ë°© ëª©ë¡ ì—…ë°ì´íŠ¸ (ì´ë²¤íŠ¸ ë£¸ì€ updateRoomListì—ì„œ ìë™ ì¶”ê°€ë¨)
          updateRoomList(defaultRooms);
          
          // ë©”ì¸ ì±„íŒ…ë°© ìë™ ì…ì¥
          setTimeout(() => {
            joinRoom('main');
          }, 300);
        };
        
        ws.onmessage = (event) => {
          const data = JSON.parse(event.data);
          handleWebSocketMessage(data);
        };
        
        ws.onclose = () => {
          // console.log('âŒ ì±„íŒ… ì„œë²„ ì—°ê²° ëŠê¹€'); // Production: removed
          document.getElementById('connectionStatus').textContent = 'ì˜¤í”„ë¼ì¸';
          
          // ì¬ì—°ê²° ì‹œë„
          if (reconnectAttempts < 5) {
            reconnectAttempts++;
            setTimeout(connectWebSocket, 2000 * reconnectAttempts);
          }
        };
        
        ws.onerror = (error) => {
          console.error('WebSocket ì˜¤ë¥˜:', error);
        };
        
      } catch (error) {
        console.error('WebSocket ì—°ê²° ì‹¤íŒ¨:', error);
      }
    }
    
    // WebSocket ë©”ì‹œì§€ ì²˜ë¦¬
    function handleWebSocketMessage(data) {
      console.log('Received message:', data); // ë””ë²„ê¹…ìš©
      switch(data.type) {
        case 'connected':
          updateRoomList(data.data.rooms);
          updateStats(data.data.stats);
          break;
          
        case 'room_joined':
          handleRoomJoined(data.data);
          break;
          
        case 'message':
          displayMessage(data.data);
          break;
          
        case 'new_message':
          displayMessage(data.data);
          break;
          
        case 'user_joined':
          if (data.data.nickname) {
            addSystemMessage(`${data.data.nickname}ë‹˜ì´ ì…ì¥í–ˆìŠµë‹ˆë‹¤.`);
          }
          if (data.data.userCount !== undefined) {
            updateRoomUserCount(data.data.userCount);
          }
          break;
          
        case 'user_left':
          if (data.data.nickname) {
            addSystemMessage(`${data.data.nickname}ë‹˜ì´ í‡´ì¥í–ˆìŠµë‹ˆë‹¤.`);
          }
          if (data.data.userCount !== undefined) {
            updateRoomUserCount(data.data.userCount);
          }
          break;
          
        case 'room_created':
          addRoomToList(data.data);
          break;
          
        case 'room_deleted':
          removeRoomFromList(data.data.roomId);
          if (currentRoom === data.data.roomId) {
            joinRoom('general');
            alert(`í˜„ì¬ ì±„íŒ…ë°©ì´ ${data.data.reason}ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
          }
          break;
          
        case 'room_update':
          updateRoomInfo(data.data);
          updateRoomInList(data.data);
          break;
          
        case 'stats_update':
          updateStats(data.data);
          break;
          
        case 'user_typing':
          showTypingIndicator(data.data);
          break;
          
        case 'server_shutdown':
          addSystemMessage('ì„œë²„ê°€ ì¬ì‹œì‘ë©ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì—°ê²°ë©ë‹ˆë‹¤.');
          break;
          
        case 'reaction_added':
          updateReaction(data.data);
          break;
          
        case 'error':
          alert(data.data.message);
          break;
      }
    }
    
    // ë°© ì…ì¥ ì²˜ë¦¬
    function handleRoomJoined(data) {
      // ë©”ì‹œì§€ ì´ˆê¸°í™”
      document.getElementById('messagesContainer').innerHTML = '';
      
      // íˆìŠ¤í† ë¦¬ í‘œì‹œ
      if (data.messages && data.messages.length > 0) {
        console.log(`ğŸ“¥ 24ì‹œê°„ ë‚´ ë©”ì‹œì§€ ${data.messages.length}ê°œ ë¡œë“œ`);
        
        // ë©”ì‹œì§€ê°€ ë§ì„ ë•Œ ë¡œë”© í‘œì‹œ
        if (data.messages.length > 20) {
          addSystemMessage(`â³ ë©”ì‹œì§€ ${data.messages.length}ê°œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...`);
        }
        
        // ê°€ì¥ ì˜¤ë˜ëœ ë©”ì‹œì§€ ì‹œê°„ ê³„ì‚°
        const oldestMsg = data.messages[0];
        const oldestTime = new Date(oldestMsg.timestamp);
        const now = new Date();
        const hoursDiff = Math.floor((now - oldestTime) / (1000 * 60 * 60));
        
        // ì‹œê°„ ì •ë³´ì™€ í•¨ê»˜ êµ¬ë¶„ì„  ì¶”ê°€
        if (data.messages.length >= 5) {
          if (hoursDiff >= 1) {
            addSystemMessage(`â”â”â”â”â” ìµœê·¼ ${hoursDiff}ì‹œê°„ ëŒ€í™” ë‚´ì—­ (${data.messages.length}ê°œ) â”â”â”â”â”`);
          } else {
            const minutesDiff = Math.floor((now - oldestTime) / (1000 * 60));
            addSystemMessage(`â”â”â”â”â” ìµœê·¼ ${minutesDiff}ë¶„ ëŒ€í™” ë‚´ì—­ (${data.messages.length}ê°œ) â”â”â”â”â”`);
          }
        }
        
        // ë©”ì‹œì§€ë¥¼ ì²­í¬ë¡œ ë‚˜ëˆ„ì–´ ë Œë”ë§ (ì„±ëŠ¥ ìµœì í™”)
        const chunkSize = 20;
        let messageIndex = 0;
        
        function renderMessageChunk() {
          const chunk = data.messages.slice(messageIndex, messageIndex + chunkSize);
          chunk.forEach(msg => {
            // ì´ì „ ë©”ì‹œì§€ëŠ” ì•Œë¦¼ ì—†ì´ í‘œì‹œ
            displayMessage(msg, false);
          });
          
          messageIndex += chunkSize;
          
          // ë‹¤ìŒ ì²­í¬ê°€ ìˆìœ¼ë©´ ê³„ì† ë Œë”ë§
          if (messageIndex < data.messages.length) {
            setTimeout(renderMessageChunk, 10); // 10ms ê°„ê²©ìœ¼ë¡œ ì²­í¬ ë Œë”ë§
          } else {
            // ëª¨ë“  ë©”ì‹œì§€ ë¡œë“œ ì™„ë£Œ
            if (data.messages.length >= 5) {
              addSystemMessage('â”â”â”â”â” ìƒˆë¡œìš´ ëŒ€í™” ì‹œì‘ â”â”â”â”â”');
            }
            
            // ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ
            setTimeout(() => {
              const container = document.getElementById('messagesContainer');
              container.scrollTop = container.scrollHeight;
            }, 100);
          }
        }
        
        // ì²« ì²­í¬ ë Œë”ë§ ì‹œì‘
        renderMessageChunk();
        
      } else {
        console.log('ğŸ“¥ 24ì‹œê°„ ë‚´ ë©”ì‹œì§€ ì—†ìŒ');
      }
      
      // í™˜ì˜ ë©”ì‹œì§€
      if (currentRoom === 'main') {
        addSystemMessage('ğŸƒ ë©”ì¸ ì±„íŒ…ë°©ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!');
        addSystemMessage('ëª¨ë“  ìœ¡ìƒì¸ë“¤ê³¼ ììœ ë¡­ê²Œ ëŒ€í™”ë¥¼ ë‚˜ëˆ ë³´ì„¸ìš”.');
      } else {
        addSystemMessage(`ğŸ’¬ "${data.roomName || currentRoom}" ì±„íŒ…ë°©ì— ì…ì¥í–ˆìŠµë‹ˆë‹¤.`);
      }
      
      updateRoomUserCount(data.userCount);
      
      // ì…ë ¥ í™œì„±í™”
      document.getElementById('messageInput').disabled = false;
      document.getElementById('sendBtn').disabled = false;
      document.getElementById('attachBtn').disabled = false;
      document.getElementById('messageInput').focus();
      
      // ì…ë ¥ì°½ì— placeholder ì—…ë°ì´íŠ¸
      document.getElementById('messageInput').placeholder = 'ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”... (Enterë¡œ ì „ì†¡)';
      
      // ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ
      setTimeout(() => {
        const container = document.getElementById('messagesContainer');
        container.scrollTop = container.scrollHeight;
      }, 100);
    }
    
    // ë°© ì…ì¥
    function joinRoom(roomId) {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        alert('ì„œë²„ì— ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        return;
      }
      
      if (roomId === currentRoom) return;
      
      currentRoom = roomId;
      
      // UI ì—…ë°ì´íŠ¸
      document.querySelectorAll('.room-item').forEach(item => {
        item.classList.remove('active');
        if (item.dataset.roomId === roomId) {
          item.classList.add('active');
          const roomName = item.querySelector('.room-name').textContent;
          document.getElementById('currentRoomName').textContent = roomName;
        }
      });
      
      // ì„œë²„ì— ì…ì¥ ìš”ì²­
      ws.send(JSON.stringify({
        type: 'join',
        data: {
          room: roomId,
          nickname: userProfile.nickname,
          userId: userProfile.userId
        }
      }));
      
      // ëª¨ë°”ì¼ì—ì„œ ì‚¬ì´ë“œë°” ë‹«ê¸°
      if (window.innerWidth <= 768) {
        document.getElementById('sidebar').classList.remove('open');
      }
    }
    
    // ë©”ì‹œì§€ ì „ì†¡
    function sendMessage() {
      // ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ì´ë¯¸ì§€ ë©”ì‹œì§€ ì „ì†¡
      if (pendingImage) {
        sendImageMessage();
        return;
      }
      
      const input = document.getElementById('messageInput');
      const text = input.value.trim();
      
      if (!text || !ws || ws.readyState !== WebSocket.OPEN || !currentRoom) {
        console.log('Cannot send message:', { text: !!text, ws: !!ws, wsState: ws?.readyState, room: currentRoom });
        return;
      }
      
      const displayName = userProfile.anonymous ? 'ìµëª…ì„ ìˆ˜' : userProfile.nickname;
      const displayAvatar = userProfile.anonymous ? 'ìµ' : userProfile.avatar;
      
      const messageData = {
        type: 'message',
        data: {
          text,
          nickname: displayName,
          avatar: displayAvatar,
          room: currentRoom,
          userId: userProfile.userId,
          replyTo: replyToMessage
        }
      };
      
      console.log('Sending message:', messageData); // ë””ë²„ê¹…ìš©
      ws.send(JSON.stringify(messageData));
      
      // ìì‹ ì˜ ë©”ì‹œì§€ëŠ” ì„œë²„ì—ì„œ ë°›ì•„ì„œ í‘œì‹œ (ì¤‘ë³µ ë°©ì§€)
      
      input.value = '';
      input.focus();
      cancelReply();
    }
    
    // ë©”ì‹œì§€ í‘œì‹œ
    function displayMessage(data, isOwn = false) {
      const container = document.getElementById('messagesContainer');
      
      // ìì‹ ì˜ ë©”ì‹œì§€ì¸ì§€ í™•ì¸
      if (data.userId === userProfile.userId) {
        isOwn = true;
      }
      
      // ë‹¤ë¥¸ ì‚¬ìš©ìì˜ ë©”ì‹œì§€ì´ê³  í˜ì´ì§€ê°€ ë³´ì´ì§€ ì•Šì„ ë•Œ ì•Œë¦¼
      if (!isOwn && (!isPageVisible || !document.hasFocus())) {
        playNotificationSound();
        updateUnreadCount(1);
      }
      
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${isOwn ? 'own' : ''}`;
      messageDiv.id = `msg-${data.messageId || Date.now()}`;
      
      const time = new Date(data.timestamp || new Date()).toLocaleTimeString('ko-KR', {
        hour: '2-digit',
        minute: '2-digit'
      });
      
      // ë‹µì¥ í‘œì‹œ
      let replyHtml = '';
      if (data.replyTo) {
        replyHtml = `
          <div class="message-reply">
            <i class="fas fa-reply"></i> @${data.replyTo.nickname}: ${escapeHtml(data.replyTo.text)}
          </div>
        `;
      }
      
      // ì´ë¯¸ì§€ í‘œì‹œ
      let imageHtml = '';
      if (data.image) {
        imageHtml = `
          <div class="message-image" onclick="openLightbox('${data.image.full}')">
            <img src="${data.image.thumb}" alt="Uploaded image">
          </div>
        `;
      }
      
      // í…ìŠ¤íŠ¸ ì²˜ë¦¬ (ë©˜ì…˜ í•˜ì´ë¼ì´íŠ¸)
      let processedText = data.text ? checkMention(escapeHtml(data.text)) : '';
      
      messageDiv.innerHTML = `
        <div class="message-avatar">${data.avatar || '?'}</div>
        <div class="message-content">
          <div class="message-header">
            <span class="message-username">${data.nickname || 'ìµëª…'}</span>
            <span class="message-time">${time}</span>
          </div>
          ${replyHtml}
          ${processedText ? `<div class="message-text">${processedText}</div>` : ''}
          ${imageHtml}
          <div class="message-reactions" id="reactions-${messageDiv.id}"></div>
          <div class="message-actions">
            <button class="action-button" onclick="replyToMsg('${messageDiv.id}', '${escapeHtml(data.text || 'ì´ë¯¸ì§€')}', '${data.nickname}')">
              <i class="fas fa-reply"></i> ë‹µì¥
            </button>
            <button class="action-button" onclick="showEmojiPicker('${messageDiv.id}', event)">
              <i class="fas fa-smile"></i> ë°˜ì‘
            </button>
          </div>
        </div>
      `;
      
      container.appendChild(messageDiv);
      
      // ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ (ëª¨ë°”ì¼ ëŒ€ì‘)
      setTimeout(() => {
        container.scrollTop = container.scrollHeight;
        
        // ëª¨ë°”ì¼ì—ì„œ ì¶”ê°€ ìŠ¤í¬ë¡¤ ë³´ì •
        if (window.innerWidth <= 768) {
          container.scrollIntoView({ behavior: 'smooth', block: 'end' });
        }
      }, 50);
    }
    
    // ì•Œë¦¼ìŒ ì¬ìƒ
    function playNotificationSound() {
      if (!userProfile.soundEnabled) return;
      
      // ê°„ë‹¨í•œ ë¹„í”„ìŒ ìƒì„±
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      oscillator.frequency.value = 800; // ì£¼íŒŒìˆ˜
      gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
      
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.1);
    }
    
    // ì½ì§€ ì•Šì€ ë©”ì‹œì§€ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
    function updateUnreadCount(increment) {
      if (!isPageVisible) {
        unreadCount += increment;
        if (unreadCount > 0) {
          document.title = `(${unreadCount}) ìœ¡ìƒí†¡ - ì• ìŠ¬ë¦¬íŠ¸ íƒ€ì„`;
        }
      }
    }
    
    // ì‹œìŠ¤í…œ ë©”ì‹œì§€
    function addSystemMessage(text) {
      const container = document.getElementById('messagesContainer');
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message system';
      messageDiv.innerHTML = `<span>${text}</span>`;
      container.appendChild(messageDiv);
      
      // ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ (ëª¨ë°”ì¼ ëŒ€ì‘)
      setTimeout(() => {
        container.scrollTop = container.scrollHeight;
        
        // ëª¨ë°”ì¼ì—ì„œ ì¶”ê°€ ìŠ¤í¬ë¡¤ ë³´ì •
        if (window.innerWidth <= 768) {
          container.scrollIntoView({ behavior: 'smooth', block: 'end' });
        }
      }, 50);
    }
    
    // ì±„íŒ…ë°© ëª©ë¡ ì—…ë°ì´íŠ¸
    function updateRoomList(rooms) {
      const container = document.getElementById('roomList');
      container.innerHTML = '';
      
      // ì´ë²¤íŠ¸/ì‹œì¦Œ ì±„íŒ…ë°© ì¶”ê°€
      const activeEventRooms = getActiveEventRooms();
      if (activeEventRooms.length > 0) {
        const eventTitle = document.createElement('div');
        eventTitle.className = 'room-section-title';
        eventTitle.innerHTML = 'ğŸ‰ ì´ë²¤íŠ¸/ëŒ€íšŒ ì±„íŒ…ë°©';
        eventTitle.style.color = '#f59e0b';
        container.appendChild(eventTitle);
        
        activeEventRooms.forEach(eventRoom => {
          container.appendChild(createEventRoomElement(eventRoom));
        });
      }
      
      // ë©”ì¸ ì±„íŒ…ë°©
      const mainTitle = document.createElement('div');
      mainTitle.className = 'room-section-title';
      mainTitle.style.marginTop = activeEventRooms.length > 0 ? '20px' : '0';
      mainTitle.textContent = 'ğŸ’¬ ë©”ì¸ ì±„íŒ…ë°©';
      container.appendChild(mainTitle);
      
      const permanentRooms = [];
      const customRooms = [];
      
      rooms.forEach(room => {
        if (room.permanent) {
          permanentRooms.push(room);
        } else {
          customRooms.push(room);
        }
      });
      
      // ë©”ì¸ ì±„íŒ…ë°©
      permanentRooms.forEach(room => {
        container.appendChild(createRoomElement(room));
      });
      
      // ì‚¬ìš©ì ìƒì„± ì±„íŒ…ë°©
      if (customRooms.length > 0) {
        const title = document.createElement('div');
        title.className = 'room-section-title';
        title.style.marginTop = '20px';
        title.textContent = 'ğŸ‘¥ ì‚¬ìš©ì ì±„íŒ…ë°©';
        container.appendChild(title);
        
        customRooms.forEach(room => {
          container.appendChild(createRoomElement(room));
        });
      }
    }
    
    // ì´ë²¤íŠ¸ ì±„íŒ…ë°© ì—˜ë¦¬ë¨¼íŠ¸ ìƒì„±
    function createEventRoomElement(eventRoom) {
      const div = document.createElement('div');
      div.className = 'room-item event-room';
      div.dataset.roomId = eventRoom.id;
      div.onclick = () => joinRoom(eventRoom.id);
      
      const status = getEventRoomStatus(eventRoom);
      const dday = getEventDDay(eventRoom);
      const style = getEventTypeStyle(eventRoom.type);
      
      // ìŠ¤íƒ€ì¼ ì¶”ê°€
      div.style.background = 'linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(239, 68, 68, 0.1))';
      div.style.border = '1px solid rgba(245, 158, 11, 0.3)';
      
      div.innerHTML = `
        <div class="room-icon" style="background: ${style.background}; font-size: 1.5rem;">
          ${eventRoom.icon}
        </div>
        <div class="room-info">
          <div class="room-name" style="display: flex; align-items: center; gap: 8px;">
            ${eventRoom.name}
            <span style="font-size: 0.7rem; padding: 2px 6px; background: ${style.background}; color: white; border-radius: 4px;">
              ${style.badge}
            </span>
            ${dday !== 'ìƒì‹œ' ? `<span style="font-size: 0.7rem; color: #f59e0b;">${dday}</span>` : ''}
          </div>
          <div class="room-meta">
            <span style="color: #999; font-size: 0.75rem;">${eventRoom.description}</span>
          </div>
          <div style="margin-top: 4px;">
            <span style="font-size: 0.65rem; color: #667eea;">
              <i class="fas fa-calendar"></i> ${eventRoom.eventDate}
            </span>
            ${status.status === 'active' ? 
              `<span style="margin-left: 10px; font-size: 0.65rem; color: #10b981;">
                <i class="fas fa-circle"></i> ${status.message}
              </span>` : ''}
          </div>
        </div>
      `;
      
      // ê³§ ì‹œì‘ë˜ëŠ” ì´ë²¤íŠ¸ëŠ” ê¹œë¹¡ì´ëŠ” íš¨ê³¼
      if (status.status === 'upcoming' && parseInt(status.message.match(/\d+/)[0]) <= 3) {
        div.style.animation = 'pulse 2s infinite';
      }
      
      return div;
    }
    
    // ì±„íŒ…ë°© ì—˜ë¦¬ë¨¼íŠ¸ ìƒì„±
    function createRoomElement(room) {
      const div = document.createElement('div');
      div.className = 'room-item';
      div.dataset.roomId = room.id;
      div.onclick = () => joinRoom(room.id);
      
      const timeLeft = room.permanent ? '' : calculateTimeLeft(room.lastActivity);
      
      div.innerHTML = `
        <div class="room-icon">${room.icon || 'ğŸ’¬'}</div>
        <div class="room-info">
          <div class="room-name">${room.name}</div>
          <div class="room-meta">
            <span class="room-users">
              <i class="fas fa-users"></i>
              <span>${room.userCount || 0}</span>
            </span>
            <span>${room.desc || ''}</span>
          </div>
        </div>
        ${!room.permanent && timeLeft ? `<div class="room-timer"><i class="fas fa-clock"></i> ${timeLeft}</div>` : ''}
      `;
      
      return div;
    }
    
    // ë‚¨ì€ ì‹œê°„ ê³„ì‚°
    function calculateTimeLeft(lastActivity) {
      if (!lastActivity) return '';
      
      const now = new Date();
      const last = new Date(lastActivity);
      const diff = now - last;
      const minutesLeft = Math.max(0, 30 - Math.floor(diff / 60000));
      
      if (minutesLeft <= 0) return 'ê³§ ì‚­ì œ';
      if (minutesLeft <= 5) return `${minutesLeft}ë¶„`;
      return '';
    }
    
    // í†µê³„ ì—…ë°ì´íŠ¸
    function updateStats(stats) {
      console.log('Updating stats:', stats);
      if (stats.onlineUsers !== undefined) {
        const onlineEl = document.getElementById('onlineCount');
        if (onlineEl) onlineEl.textContent = stats.onlineUsers;
      }
      if (stats.totalRooms !== undefined) {
        const roomEl = document.getElementById('roomCount');
        if (roomEl) roomEl.textContent = stats.totalRooms;
      }
      if (stats.totalMessages !== undefined) {
        const msgEl = document.getElementById('messageCount');
        if (msgEl) msgEl.textContent = stats.totalMessages > 999 ? '999+' : stats.totalMessages;
      }
    }
    
    // ë°© ëª©ë¡ì—ì„œ íŠ¹ì • ë°© ì—…ë°ì´íŠ¸
    function updateRoomInList(roomData) {
      const roomElement = document.querySelector(`.room-item[data-room-id="${roomData.roomId}"]`);
      if (roomElement) {
        const userCountEl = roomElement.querySelector('.room-users span');
        if (userCountEl) {
          userCountEl.textContent = roomData.userCount || 0;
        }
      }
    }
    
    // ë°© ì •ë³´ ì—…ë°ì´íŠ¸
    function updateRoomInfo(roomData) {
      if (roomData.roomId === currentRoom) {
        updateRoomUserCount(roomData.userCount);
      }
    }
    
    // ë°© ì‚¬ìš©ì ìˆ˜ ì—…ë°ì´íŠ¸
    function updateRoomUserCount(count) {
      document.getElementById('currentRoomUsers').textContent = `${count}ëª…`;
      document.getElementById('roomUserCount').textContent = count;
    }
    
    // íƒ€ì´í•‘ ì²˜ë¦¬
    function handleTyping() {
      if (!ws || ws.readyState !== WebSocket.OPEN || !currentRoom) return;
      
      if (!isTyping) {
        isTyping = true;
        ws.send(JSON.stringify({
          type: 'typing',
          data: { isTyping: true }
        }));
      }
      
      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(() => {
        isTyping = false;
        ws.send(JSON.stringify({
          type: 'typing',
          data: { isTyping: false }
        }));
      }, 1000);
    }
    
    // íƒ€ì´í•‘ í‘œì‹œ
    function showTypingIndicator(data) {
      const indicator = document.getElementById('typingIndicator');
      if (data.isTyping) {
        indicator.textContent = `${data.nickname}ë‹˜ì´ ì…ë ¥ ì¤‘...`;
        indicator.classList.add('show');
        
        setTimeout(() => {
          indicator.classList.remove('show');
        }, 3000);
      }
    }
    
    // í”„ë¡œí•„ ëª¨ë‹¬
    function openProfileModal() {
      document.getElementById('nicknameInput').value = userProfile.nickname;
      document.getElementById('anonymousCheck').checked = userProfile.anonymous;
      document.getElementById('soundCheck').checked = userProfile.soundEnabled !== false;
      document.getElementById('profileModal').classList.add('active');
    }
    
    function closeProfileModal() {
      document.getElementById('profileModal').classList.remove('active');
    }
    
    function saveProfile() {
      userProfile.nickname = document.getElementById('nicknameInput').value || `ìœ¡ìƒì¸${Math.floor(Math.random() * 10000)}`;
      userProfile.anonymous = document.getElementById('anonymousCheck').checked;
      userProfile.soundEnabled = document.getElementById('soundCheck').checked;
      userProfile.avatar = userProfile.nickname.substring(0, 1);
      
      saveProfileToStorage();
      updateProfileUI();
      closeProfileModal();
      
      // ì„œë²„ì— í”„ë¡œí•„ ì—…ë°ì´íŠ¸
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({
          type: 'profile_update',
          data: userProfile
        }));
      }
    }
    
    // ì±„íŒ…ë°© ìƒì„±
    function openCreateRoomModal() {
      document.getElementById('createRoomModal').classList.add('active');
    }
    
    function closeCreateRoomModal() {
      document.getElementById('createRoomModal').classList.remove('active');
      document.getElementById('roomNameInput').value = '';
      document.getElementById('roomDescInput').value = '';
    }
    
    function createRoom() {
      const roomName = document.getElementById('roomNameInput').value.trim();
      const roomDesc = document.getElementById('roomDescInput').value.trim();
      
      if (!roomName) {
        alert('ì±„íŒ…ë°© ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.');
        return;
      }
      
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        alert('ì„œë²„ì— ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        return;
      }
      
      ws.send(JSON.stringify({
        type: 'create_room',
        data: {
          name: roomName,
          description: roomDesc,
          icon: 'ğŸ’¬',
          private: false
        }
      }));
      
      closeCreateRoomModal();
    }
    
    // ì‚¬ì´ë“œë°” í† ê¸€
    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('open');
    }
    
    // ë°© ì¶”ê°€
    function addRoomToList(room) {
      const container = document.getElementById('roomList');
      
      // ì‚¬ìš©ì ì±„íŒ…ë°© ì„¹ì…˜ì´ ì—†ìœ¼ë©´ ì¶”ê°€
      let customSection = container.querySelector('.custom-rooms-section');
      if (!customSection) {
        const title = document.createElement('div');
        title.className = 'room-section-title custom-rooms-section';
        title.style.marginTop = '20px';
        title.textContent = 'ì‚¬ìš©ì ì±„íŒ…ë°©';
        container.appendChild(title);
      }
      
      container.appendChild(createRoomElement(room));
    }
    
    // ë°© ì œê±°
    function removeRoomFromList(roomId) {
      const element = document.querySelector(`[data-room-id="${roomId}"]`);
      if (element) {
        element.remove();
      }
    }
    
    // ë°© ì •ë³´ ì—…ë°ì´íŠ¸
    function updateRoomInfo(data) {
      const element = document.querySelector(`[data-room-id="${data.id}"]`);
      if (element) {
        const userCount = element.querySelector('.room-users span');
        if (userCount) {
          userCount.textContent = data.userCount;
        }
      }
    }
    
    // HTML ì´ìŠ¤ì¼€ì´í”„
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // íƒ€ì´ë¨¸ ì—…ë°ì´íŠ¸ (1ë¶„ë§ˆë‹¤)
    setInterval(() => {
      document.querySelectorAll('.room-item').forEach(item => {
        const roomId = item.dataset.roomId;
        // íƒ€ì´ë¨¸ ì—…ë°ì´íŠ¸ ë¡œì§
      });
    }, 60000);
    
    // ì•ˆë‚´ ëª¨ë‹¬
    function openGuideModal() {
      document.getElementById('guideModal').classList.add('active');
    }
    
    function closeGuideModal() {
      document.getElementById('guideModal').classList.remove('active');
    }
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', function() {
      // ì²˜ìŒ ë°©ë¬¸í•œ ì‚¬ìš©ìì—ê²Œë§Œ ê°€ì´ë“œ í‘œì‹œ
      const hasVisited = localStorage.getItem('chatGuideShown');
      if (!hasVisited) {
        openGuideModal();
        localStorage.setItem('chatGuideShown', 'true');
      }
      
      // ì´ˆê¸°í™” (í”„ë¡œí•„ ë¡œë“œì™€ WebSocket ì—°ê²° í¬í•¨)
      init();
      
      // Service Worker ë“±ë¡ (PWA)
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js')
          .then(registration => console.log('ServiceWorker registered'))
          .catch(error => console.log('ServiceWorker registration failed:', error));
      }
    });
    
    // í˜ì´ì§€ ê°€ì‹œì„± ë³€ê²½ ê°ì§€
    document.addEventListener('visibilitychange', function() {
      isPageVisible = !document.hidden;
      if (isPageVisible) {
        // í˜ì´ì§€ê°€ ë‹¤ì‹œ ë³´ì¼ ë•Œ ì½ì§€ ì•Šì€ ì¹´ìš´íŠ¸ ì´ˆê¸°í™”
        unreadCount = 0;
        document.title = 'ìœ¡ìƒí†¡ - ì‹¤ì‹œê°„ ì±„íŒ… | ì• ìŠ¬ë¦¬íŠ¸ íƒ€ì„';
      }
    });
    
    // í˜ì´ì§€ í¬ì»¤ìŠ¤ ê°ì§€
    window.addEventListener('focus', function() {
      isPageVisible = true;
      unreadCount = 0;
      document.title = 'ìœ¡ìƒí†¡ - ì‹¤ì‹œê°„ ì±„íŒ… | ì• ìŠ¬ë¦¬íŠ¸ íƒ€ì„';
    });
    
    window.addEventListener('blur', function() {
      isPageVisible = false;
    });
    
    // ===== ëª¨ë°”ì¼ ìŠ¤ì™€ì´í”„ ì œìŠ¤ì²˜ =====
    let touchStartX = 0;
    let touchEndX = 0;
    
    document.addEventListener('touchstart', function(e) {
      touchStartX = e.changedTouches[0].screenX;
    }, false);
    
    document.addEventListener('touchend', function(e) {
      touchEndX = e.changedTouches[0].screenX;
      handleSwipeGesture();
    }, false);
    
    function handleSwipeGesture() {
      const swipeThreshold = 50;
      const diff = touchEndX - touchStartX;
      
      if (Math.abs(diff) > swipeThreshold) {
        if (diff > 0) {
          // ì˜¤ë¥¸ìª½ ìŠ¤ì™€ì´í”„ - ì‚¬ì´ë“œë°” ì—´ê¸°
          if (window.innerWidth <= 768) {
            document.getElementById('sidebar').classList.add('open');
          }
        } else {
          // ì™¼ìª½ ìŠ¤ì™€ì´í”„ - ì‚¬ì´ë“œë°” ë‹«ê¸°
          if (window.innerWidth <= 768) {
            document.getElementById('sidebar').classList.remove('open');
          }
        }
      }
    }
    
    // ===== ì´ë¯¸ì§€ ì—…ë¡œë“œ ê¸°ëŠ¥ =====
    
    function triggerImageUpload() {
      document.getElementById('imageUpload').click();
    }
    
    function handleImageUpload(event) {
      const file = event.target.files[0];
      if (!file || !file.type.startsWith('image/')) {
        alert('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
        return;
      }
      
      // íŒŒì¼ í¬ê¸° ì²´í¬ (10MB ì œí•œ)
      if (file.size > 10 * 1024 * 1024) {
        alert('íŒŒì¼ í¬ê¸°ëŠ” 10MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.');
        return;
      }
      
      compressImage(file, (compressedImage, thumbnail) => {
        pendingImage = {
          full: compressedImage,
          thumb: thumbnail,
          name: file.name
        };
        
        // í”„ë¦¬ë·° í‘œì‹œ
        document.getElementById('previewImg').src = thumbnail;
        document.getElementById('imagePreview').style.display = 'block';
      });
    }
    
    function compressImage(file, callback) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
          // ì¸ë„¤ì¼ìš© ìº”ë²„ìŠ¤ (ìµœëŒ€ 300px)
          const thumbCanvas = document.createElement('canvas');
          const thumbCtx = thumbCanvas.getContext('2d');
          const maxThumbSize = 300;
          
          let thumbWidth = img.width;
          let thumbHeight = img.height;
          
          if (thumbWidth > maxThumbSize || thumbHeight > maxThumbSize) {
            if (thumbWidth > thumbHeight) {
              thumbHeight = (maxThumbSize * thumbHeight) / thumbWidth;
              thumbWidth = maxThumbSize;
            } else {
              thumbWidth = (maxThumbSize * thumbWidth) / thumbHeight;
              thumbHeight = maxThumbSize;
            }
          }
          
          thumbCanvas.width = thumbWidth;
          thumbCanvas.height = thumbHeight;
          thumbCtx.drawImage(img, 0, 0, thumbWidth, thumbHeight);
          
          // í’€ì‚¬ì´ì¦ˆìš© ìº”ë²„ìŠ¤ (ìµœëŒ€ 1200px, í’ˆì§ˆ ì••ì¶•)
          const fullCanvas = document.createElement('canvas');
          const fullCtx = fullCanvas.getContext('2d');
          const maxFullSize = 1200;
          
          let fullWidth = img.width;
          let fullHeight = img.height;
          
          if (fullWidth > maxFullSize || fullHeight > maxFullSize) {
            if (fullWidth > fullHeight) {
              fullHeight = (maxFullSize * fullHeight) / fullWidth;
              fullWidth = maxFullSize;
            } else {
              fullWidth = (maxFullSize * fullWidth) / fullHeight;
              fullHeight = maxFullSize;
            }
          }
          
          fullCanvas.width = fullWidth;
          fullCanvas.height = fullHeight;
          fullCtx.drawImage(img, 0, 0, fullWidth, fullHeight);
          
          // Base64ë¡œ ë³€í™˜ (JPEG í’ˆì§ˆ 0.7)
          const thumbnail = thumbCanvas.toDataURL('image/jpeg', 0.7);
          const fullImage = fullCanvas.toDataURL('image/jpeg', 0.8);
          
          callback(fullImage, thumbnail);
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }
    
    function cancelImageUpload() {
      pendingImage = null;
      document.getElementById('imagePreview').style.display = 'none';
      document.getElementById('imageUpload').value = '';
    }
    
    function sendImageMessage() {
      if (!pendingImage || !ws || ws.readyState !== WebSocket.OPEN || !currentRoom) return;
      
      const displayName = userProfile.anonymous ? 'ìµëª…ì„ ìˆ˜' : userProfile.nickname;
      const displayAvatar = userProfile.anonymous ? 'ìµ' : userProfile.avatar;
      
      const messageData = {
        type: 'message',
        data: {
          text: '',
          image: pendingImage,
          nickname: displayName,
          avatar: displayAvatar,
          room: currentRoom,
          userId: userProfile.userId,
          replyTo: replyToMessage
        }
      };
      
      console.log('Sending image message');
      ws.send(JSON.stringify(messageData));
      
      cancelImageUpload();
      replyToMessage = null;
    }
    
    // ë¼ì´íŠ¸ë°•ìŠ¤ ê¸°ëŠ¥
    function openLightbox(imageUrl) {
      document.getElementById('lightboxImage').src = imageUrl;
      document.getElementById('imageLightbox').style.display = 'flex';
    }
    
    function closeLightbox(event) {
      if (!event || event.target.id === 'imageLightbox') {
        document.getElementById('imageLightbox').style.display = 'none';
      }
    }
    
    function downloadImage() {
      const img = document.getElementById('lightboxImage');
      const link = document.createElement('a');
      link.href = img.src;
      link.download = 'athletetime-image.jpg';
      link.click();
    }
    
    // ===== ì´ëª¨ì§€ ë°˜ì‘ ê¸°ëŠ¥ =====
    
    function showEmojiPicker(messageId, event) {
      currentEmojiTarget = messageId;
      const picker = document.getElementById('emojiPicker');
      picker.style.display = 'block';
      picker.style.left = event.pageX + 'px';
      picker.style.top = event.pageY + 'px';
      
      // í´ë¦­ ì™¸ë¶€ ì˜ì—­ ê°ì§€
      setTimeout(() => {
        document.addEventListener('click', hideEmojiPicker);
      }, 100);
    }
    
    function hideEmojiPicker() {
      document.getElementById('emojiPicker').style.display = 'none';
      document.removeEventListener('click', hideEmojiPicker);
    }
    
    function addReaction(emoji) {
      if (!currentEmojiTarget || !ws || ws.readyState !== WebSocket.OPEN) return;
      
      ws.send(JSON.stringify({
        type: 'reaction',
        data: {
          messageId: currentEmojiTarget,
          emoji: emoji,
          userId: userProfile.userId,
          room: currentRoom
        }
      }));
      
      hideEmojiPicker();
    }
    
    // ===== ë‹µì¥ ê¸°ëŠ¥ =====
    
    function replyToMsg(messageId, messageText, nickname) {
      replyToMessage = {
        id: messageId,
        text: messageText.substring(0, 50),
        nickname: nickname
      };
      
      // ë‹µì¥ í‘œì‹œ UI ì¶”ê°€
      const input = document.getElementById('messageInput');
      input.placeholder = `@${nickname}ì—ê²Œ ë‹µì¥ ì¤‘...`;
      input.focus();
    }
    
    function cancelReply() {
      replyToMessage = null;
      document.getElementById('messageInput').placeholder = 'ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”... (Enterë¡œ ì „ì†¡)';
    }
    
    // ===== @ë©˜ì…˜ ê¸°ëŠ¥ =====
    
    function checkMention(text) {
      if (!text) return '';
      const mentionRegex = /@(\S+)/g;
      const matches = text.match(mentionRegex);
      if (matches) {
        matches.forEach(mention => {
          const username = mention.substring(1);
          // í•´ë‹¹ ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼
          if (username === userProfile.nickname) {
            playNotificationSound();
          }
        });
      }
      return text.replace(mentionRegex, '<span style="color: #667eea; font-weight: bold;">$&</span>');
    }
    
    // ë°˜ì‘ ì—…ë°ì´íŠ¸
    function updateReaction(data) {
      const reactionsEl = document.querySelector(`#reactions-${data.messageId}`);
      if (!reactionsEl) return;
      
      // ë©”ì‹œì§€ë³„ ë°˜ì‘ ì €ì¥
      if (!messageReactions.has(data.messageId)) {
        messageReactions.set(data.messageId, new Map());
      }
      
      const reactions = messageReactions.get(data.messageId);
      if (!reactions.has(data.emoji)) {
        reactions.set(data.emoji, new Set());
      }
      
      reactions.get(data.emoji).add(data.userId);
      
      // UI ì—…ë°ì´íŠ¸
      renderReactions(data.messageId);
    }
    
    function renderReactions(messageId) {
      const reactionsEl = document.querySelector(`#reactions-${messageId}`);
      if (!reactionsEl) return;
      
      const reactions = messageReactions.get(messageId);
      if (!reactions || reactions.size === 0) {
        reactionsEl.innerHTML = '';
        return;
      }
      
      let html = '';
      reactions.forEach((users, emoji) => {
        const isActive = users.has(userProfile.userId);
        html += `
          <button class="reaction-button ${isActive ? 'active' : ''}" onclick="toggleReaction('${messageId}', '${emoji}')">
            ${emoji} <span class="reaction-count">${users.size}</span>
          </button>
        `;
      });
      
      reactionsEl.innerHTML = html;
    }
    
    function toggleReaction(messageId, emoji) {
      const reactions = messageReactions.get(messageId);
      if (!reactions) return;
      
      const users = reactions.get(emoji);
      if (users && users.has(userProfile.userId)) {
        // ë°˜ì‘ ì œê±°
        users.delete(userProfile.userId);
        if (users.size === 0) {
          reactions.delete(emoji);
        }
      } else {
        // ë°˜ì‘ ì¶”ê°€
        addReaction(emoji);
      }
      
      renderReactions(messageId);
    }
  </script>


</body>
</html>