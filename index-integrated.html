<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>애슬리트 타임 - 러닝 커뮤니티</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Malgun Gothic', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    
    /* 채팅 플로팅 버튼 */
    .chat-fab {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      transition: all 0.3s;
    }
    
    .chat-fab:hover {
      transform: scale(1.1);
    }
    
    .chat-fab .notification-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: #ef4444;
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    
    /* 채팅 패널 */
    .chat-panel {
      position: fixed;
      bottom: 90px;
      right: 20px;
      width: 380px;
      height: 600px;
      background: #1a1a1a;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
      display: none;
      flex-direction: column;
      z-index: 999;
      animation: slideUp 0.3s ease-out;
    }
    
    .chat-panel.active {
      display: flex;
    }
    
    @keyframes slideUp {
      from {
        transform: translateY(20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    @media (max-width: 640px) {
      .chat-panel {
        position: fixed;
        bottom: 0;
        right: 0;
        left: 0;
        width: 100%;
        height: 100vh;
        border-radius: 0;
      }
    }
    
    /* 메인 컨텐츠 스타일 */
    .main-header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }
    
    .feature-card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      transition: all 0.3s;
    }
    
    .feature-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
    }
    
    /* 실시간 활동 피드 */
    .activity-feed {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 12px;
      padding: 16px;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .activity-item {
      padding: 8px 12px;
      margin: 4px 0;
      background: rgba(102, 126, 234, 0.1);
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
      animation: fadeIn 0.5s;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    /* 채팅 메시지 스타일 */
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      background: #0f0f0f;
    }
    
    .chat-message {
      margin-bottom: 12px;
      animation: slideIn 0.3s;
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(-20px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    .message-content {
      background: rgba(255, 255, 255, 0.05);
      padding: 8px 12px;
      border-radius: 12px;
      display: inline-block;
      max-width: 80%;
      color: #e0e0e0;
    }
    
    .own-message .message-content {
      background: rgba(102, 126, 234, 0.2);
      margin-left: auto;
      display: block;
    }
    
    ::-webkit-scrollbar {
      width: 6px;
    }
    
    ::-webkit-scrollbar-track {
      background: transparent;
    }
    
    ::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 3px;
    }
  </style>
</head>
<body>
  <!-- 메인 헤더 -->
  <header class="main-header sticky top-0 z-50">
    <div class="container mx-auto px-4 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-4">
          <h1 class="text-2xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">
            애슬리트 타임
          </h1>
          <nav class="hidden md:flex gap-6">
            <a href="#pace" class="hover:text-purple-600 transition">페이스 계산기</a>
            <a href="#track" class="hover:text-purple-600 transition">트랙 계산기</a>
            <a href="#training" class="hover:text-purple-600 transition">훈련 플랜</a>
            <a href="#community" class="hover:text-purple-600 transition">커뮤니티</a>
          </nav>
        </div>
        
        <!-- 실시간 상태 -->
        <div class="flex items-center gap-4">
          <div class="hidden md:flex items-center gap-2 px-3 py-1 bg-red-100 rounded-full">
            <div class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
            <span class="text-sm font-medium" id="onlineCount">247명 온라인</span>
          </div>
          <button class="px-4 py-2 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-full text-sm font-medium hover:opacity-90 transition">
            로그인
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- 메인 컨텐츠 -->
  <main class="container mx-auto px-4 py-8">
    <!-- 히어로 섹션 -->
    <section class="text-center text-white mb-12">
      <h2 class="text-4xl md:text-5xl font-bold mb-4">
        더 빠르게, 더 멀리, 함께
      </h2>
      <p class="text-xl mb-8 opacity-90">
        실시간으로 소통하며 함께 성장하는 러닝 커뮤니티
      </p>
      <div class="flex justify-center gap-4">
        <button onclick="window.location.href='pace-calculator.html'" class="px-6 py-3 bg-white text-purple-600 rounded-full font-medium hover:bg-gray-100 transition">
          페이스 계산 시작하기
        </button>
        <button onclick="toggleChat()" class="px-6 py-3 bg-black bg-opacity-30 text-white rounded-full font-medium hover:bg-opacity-40 transition">
          실시간 채팅 참여
        </button>
      </div>
    </section>

    <!-- 실시간 활동 피드 -->
    <section class="mb-12">
      <h3 class="text-white text-xl font-bold mb-4">🔥 실시간 커뮤니티 활동</h3>
      <div class="activity-feed" id="activityFeed">
        <!-- 활동 아이템들이 여기에 추가됨 -->
      </div>
    </section>

    <!-- 기능 카드 그리드 -->
    <section class="grid md:grid-cols-3 gap-6 mb-12">
      <div class="feature-card">
        <div class="text-3xl mb-4">🏃‍♂️</div>
        <h3 class="text-xl font-bold mb-2">페이스 계산기</h3>
        <p class="text-gray-600 mb-4">목표 시간에 맞는 정확한 페이스를 계산하세요</p>
        <a href="pace-calculator.html" class="text-purple-600 font-medium hover:underline">
          계산하기 →
        </a>
      </div>
      
      <div class="feature-card">
        <div class="text-3xl mb-4">🏟️</div>
        <h3 class="text-xl font-bold mb-2">트랙 레인 계산기</h3>
        <p class="text-gray-600 mb-4">레인별 정확한 거리와 시간을 계산하세요</p>
        <a href="pace-calculator.html#track" class="text-purple-600 font-medium hover:underline">
          계산하기 →
        </a>
      </div>
      
      <div class="feature-card">
        <div class="text-3xl mb-4">💬</div>
        <h3 class="text-xl font-bold mb-2">실시간 채팅</h3>
        <p class="text-gray-600 mb-4">
          <span class="inline-flex items-center gap-1">
            <span class="w-2 h-2 bg-green-500 rounded-full"></span>
            <span id="chatUserCount">32명</span> 채팅 중
          </span>
        </p>
        <button onclick="toggleChat()" class="text-purple-600 font-medium hover:underline">
          채팅 참여 →
        </button>
      </div>
    </section>

    <!-- 실시간 기록 보드 -->
    <section class="grid md:grid-cols-2 gap-6">
      <div class="bg-white rounded-lg p-6">
        <h3 class="text-xl font-bold mb-4">🏆 오늘의 베스트 기록</h3>
        <div class="space-y-3" id="bestRecords">
          <!-- 기록들이 여기에 추가됨 -->
        </div>
      </div>
      
      <div class="bg-white rounded-lg p-6">
        <h3 class="text-xl font-bold mb-4">📈 실시간 통계</h3>
        <div class="grid grid-cols-2 gap-4">
          <div class="text-center p-4 bg-purple-50 rounded-lg">
            <div class="text-2xl font-bold text-purple-600" id="totalDistance">1,234km</div>
            <div class="text-sm text-gray-600">오늘 총 거리</div>
          </div>
          <div class="text-center p-4 bg-pink-50 rounded-lg">
            <div class="text-2xl font-bold text-pink-600" id="totalRunners">89명</div>
            <div class="text-sm text-gray-600">활동 러너</div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- 채팅 플로팅 버튼 -->
  <div class="chat-fab" onclick="toggleChat()" id="chatFab">
    <i class="fas fa-comments text-white text-2xl"></i>
    <div class="notification-badge" id="unreadBadge" style="display: none;">0</div>
  </div>

  <!-- 채팅 패널 -->
  <div class="chat-panel" id="chatPanel">
    <div class="bg-gradient-to-r from-purple-600 to-pink-600 p-4 rounded-t-lg">
      <div class="flex items-center justify-between text-white">
        <div>
          <h3 class="font-bold">실시간 러닝톡</h3>
          <div class="text-xs opacity-90">
            <span id="chatStatus">연결 중...</span>
          </div>
        </div>
        <button onclick="toggleChat()" class="text-white hover:opacity-80">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>
    
    <div class="chat-messages" id="chatMessages">
      <div class="text-center text-gray-500 text-sm py-4">
        채팅에 오신 것을 환영합니다!
      </div>
    </div>
    
    <div class="p-4 border-t border-gray-800">
      <div class="flex gap-2">
        <input 
          type="text" 
          id="chatInput" 
          class="flex-1 px-4 py-2 bg-gray-800 text-white rounded-full text-sm focus:outline-none focus:ring-2 focus:ring-purple-600"
          placeholder="메시지를 입력하세요..."
          onkeypress="handleChatKeyPress(event)">
        <button onclick="sendChatMessage()" class="px-4 py-2 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-full hover:opacity-90 transition">
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
    </div>
  </div>

  <script>
    // WebSocket 연결
    let ws = null;
    let currentUser = null;
    let chatOpen = false;
    let unreadCount = 0;
    let activityInterval = null;
    
    // 초기화
    window.addEventListener('DOMContentLoaded', () => {
      initializeApp();
    });
    
    function initializeApp() {
      // 사용자 생성
      currentUser = {
        id: localStorage.getItem('userId') || 'user_' + Math.random().toString(36).substr(2, 9),
        name: localStorage.getItem('username') || generateUsername()
      };
      
      localStorage.setItem('userId', currentUser.id);
      localStorage.setItem('username', currentUser.name);
      
      // WebSocket 연결
      connectWebSocket();
      
      // 실시간 활동 시작
      startActivityFeed();
      
      // 통계 업데이트
      updateStats();
      setInterval(updateStats, 10000);
    }
    
    function generateUsername() {
      const adjectives = ['빠른', '강한', '민첩한', '열정적인', '파워'];
      const nouns = ['러너', '스프린터', '마라토너', '선수', '챔피언'];
      return adjectives[Math.floor(Math.random() * adjectives.length)] +
             nouns[Math.floor(Math.random() * nouns.length)] +
             Math.floor(Math.random() * 999);
    }
    
    function connectWebSocket() {
      const wsUrl = `ws://${window.location.hostname}:3002`;
      
      try {
        ws = new WebSocket(wsUrl);
        
        ws.onopen = () => {
          updateChatStatus('온라인', 'green');
        };
        
        ws.onmessage = (event) => {
          const data = JSON.parse(event.data);
          handleWebSocketMessage(data);
        };
        
        ws.onerror = () => {
          updateChatStatus('오프라인', 'red');
          fallbackToLocal();
        };
        
        ws.onclose = () => {
          updateChatStatus('재연결 중...', 'yellow');
          setTimeout(connectWebSocket, 3000);
        };
      } catch (error) {
        console.log('WebSocket 연결 실패, 로컬 모드로 전환');
        fallbackToLocal();
      }
    }
    
    function handleWebSocketMessage(data) {
      switch(data.type) {
        case 'connected':
          onConnected(data.data);
          break;
        case 'message':
          onChatMessage(data.data);
          break;
        case 'userJoined':
        case 'userLeft':
          onUserActivity(data.data);
          break;
      }
    }
    
    function onConnected(data) {
      currentUser = { ...currentUser, ...data.user };
      updateChatStatus(`${data.userCount}명 온라인`, 'green');
      
      // 이전 메시지 표시
      if (data.recentMessages) {
        data.recentMessages.forEach(msg => displayChatMessage(msg));
      }
    }
    
    function onChatMessage(message) {
      displayChatMessage(message);
      
      // 채팅이 닫혀있으면 알림 표시
      if (!chatOpen) {
        unreadCount++;
        updateUnreadBadge();
      }
      
      // 활동 피드에 추가
      addActivityItem(`💬 ${message.username}: ${message.text.substring(0, 30)}...`);
    }
    
    function onUserActivity(data) {
      updateChatStatus(`${data.userCount}명 온라인`, 'green');
      document.getElementById('onlineCount').textContent = `${data.userCount}명 온라인`;
      document.getElementById('chatUserCount').textContent = `${data.userCount}명`;
    }
    
    function displayChatMessage(message) {
      const messagesContainer = document.getElementById('chatMessages');
      const messageDiv = document.createElement('div');
      const isOwn = currentUser && message.userId === currentUser.id;
      
      messageDiv.className = `chat-message ${isOwn ? 'own-message' : ''}`;
      
      const time = new Date(message.timestamp).toLocaleTimeString('ko-KR', {
        hour: '2-digit',
        minute: '2-digit'
      });
      
      messageDiv.innerHTML = `
        <div class="message-content">
          <div class="text-xs opacity-70 mb-1">
            ${message.username} · ${time}
          </div>
          <div>${escapeHtml(message.text)}</div>
        </div>
      `;
      
      messagesContainer.appendChild(messageDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    function sendChatMessage() {
      const input = document.getElementById('chatInput');
      const text = input.value.trim();
      
      if (!text) return;
      
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({
          type: 'message',
          data: { text }
        }));
      } else {
        // 로컬 모드
        displayChatMessage({
          id: Date.now(),
          userId: currentUser.id,
          username: currentUser.name,
          text: text,
          timestamp: new Date()
        });
      }
      
      input.value = '';
      
      // 활동 피드에 추가
      addActivityItem(`💬 나: ${text.substring(0, 30)}...`);
    }
    
    function toggleChat() {
      const panel = document.getElementById('chatPanel');
      chatOpen = !chatOpen;
      
      if (chatOpen) {
        panel.classList.add('active');
        unreadCount = 0;
        updateUnreadBadge();
        document.getElementById('chatInput').focus();
      } else {
        panel.classList.remove('active');
      }
    }
    
    function updateUnreadBadge() {
      const badge = document.getElementById('unreadBadge');
      if (unreadCount > 0) {
        badge.style.display = 'flex';
        badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
      } else {
        badge.style.display = 'none';
      }
    }
    
    function updateChatStatus(text, color) {
      const status = document.getElementById('chatStatus');
      status.innerHTML = `<span class="inline-flex items-center gap-1">
        <span class="w-2 h-2 bg-${color}-500 rounded-full"></span>
        ${text}
      </span>`;
    }
    
    function startActivityFeed() {
      // 초기 활동 추가
      const activities = [
        '🏃 강력러너님이 5km 완주',
        '💬 새로운 대화 시작됨',
        '🏆 파워스프린터님이 신기록 달성',
        '👥 3명의 러너가 참여',
        '📊 오늘의 페이스 계산 100회 돌파'
      ];
      
      activities.forEach((activity, index) => {
        setTimeout(() => addActivityItem(activity), index * 1000);
      });
      
      // 주기적 업데이트
      activityInterval = setInterval(() => {
        const randomActivities = [
          `🏃 ${generateUsername()}님이 러닝 시작`,
          `💪 ${Math.floor(Math.random() * 10) + 1}km 달성`,
          `⚡ 페이스 ${4 + Math.random()}:${Math.floor(Math.random() * 60).toString().padStart(2, '0')}`,
          `🎯 목표 달성률 ${Math.floor(Math.random() * 30) + 70}%`
        ];
        
        const activity = randomActivities[Math.floor(Math.random() * randomActivities.length)];
        addActivityItem(activity);
      }, 15000);
    }
    
    function addActivityItem(text) {
      const feed = document.getElementById('activityFeed');
      const item = document.createElement('div');
      item.className = 'activity-item';
      item.innerHTML = `
        <span class="text-purple-600">●</span>
        <span class="text-sm">${text}</span>
        <span class="text-xs text-gray-500 ml-auto">방금</span>
      `;
      
      feed.insertBefore(item, feed.firstChild);
      
      // 최대 10개 유지
      while (feed.children.length > 10) {
        feed.removeChild(feed.lastChild);
      }
    }
    
    function updateStats() {
      // 통계 업데이트
      const totalDistance = Math.floor(Math.random() * 500) + 1000;
      const totalRunners = Math.floor(Math.random() * 50) + 50;
      
      document.getElementById('totalDistance').textContent = `${totalDistance.toLocaleString()}km`;
      document.getElementById('totalRunners').textContent = `${totalRunners}명`;
      
      // 베스트 기록 업데이트
      const records = document.getElementById('bestRecords');
      records.innerHTML = `
        <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
          <span class="font-medium">5km</span>
          <span class="text-purple-600 font-bold">18:45</span>
        </div>
        <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
          <span class="font-medium">10km</span>
          <span class="text-purple-600 font-bold">38:23</span>
        </div>
        <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
          <span class="font-medium">하프</span>
          <span class="text-purple-600 font-bold">1:25:17</span>
        </div>
      `;
    }
    
    function handleChatKeyPress(event) {
      if (event.key === 'Enter') {
        sendChatMessage();
      }
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    function fallbackToLocal() {
      updateChatStatus('로컬 모드', 'gray');
      
      // 가상 메시지 생성
      setInterval(() => {
        if (Math.random() > 0.8) {
          const messages = [
            '오늘 날씨 좋네요!',
            '10km 목표 달성!',
            '같이 뛰실 분?',
            '페이스 조절이 어려워요',
            '화이팅!'
          ];
          
          displayChatMessage({
            id: Date.now(),
            userId: 'bot_' + Math.random(),
            username: generateUsername(),
            text: messages[Math.floor(Math.random() * messages.length)],
            timestamp: new Date()
          });
        }
      }, 8000);
    }
  </script>
</body>
</html>